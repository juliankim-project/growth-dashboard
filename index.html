<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í¼í¬ë¨¼ìŠ¤ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<style>
/* â”€â”€ ë¦¬ì…‹ & ê¸°ë³¸ â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#13151a;color:#e1e4ea;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:13px;min-height:100vh;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:#13151a;}
::-webkit-scrollbar-thumb{background:#2a2d35;border-radius:3px;}

/* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€ */
#app{display:none;flex-direction:column;min-height:100vh;}
header{padding:16px 24px;border-bottom:1px solid #1e2128;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.logo-wrap{display:flex;align-items:center;gap:10px;}
.logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#6c63ff,#a78bfa);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff;}
.logo-text{font-size:15px;font-weight:700;letter-spacing:-0.3px;}
.logo-sub{font-size:10px;color:#555b66;}
main{padding:20px 24px 48px;}

/* â”€â”€ ì»¨íŠ¸ë¡¤ ë°” â”€â”€ */
.ctrl-bar{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:20px;padding:16px;background:#1a1d24;border-radius:12px;border:1px solid #2a2d35;}
.ctrl-group{display:flex;flex-direction:column;gap:4px;}
.ctrl-label{font-size:10px;color:#6c7280;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;}
.ctrl-bar select,.ctrl-bar input[type=date]{padding:6px 10px;border-radius:8px;border:1px solid #2a2d35;background:#13151a;color:#e1e4ea;font-size:12px;outline:none;cursor:pointer;font-family:inherit;min-width:110px;color-scheme:dark;}
.ctrl-bar select:disabled{color:#3a3d45;border-color:#1e2128;cursor:default;opacity:0.5;}
.gran-wrap{display:flex;border-radius:8px;overflow:hidden;border:1px solid #2a2d35;}
.gran-btn{padding:6px 14px;font-size:12px;font-weight:400;color:#6c7280;background:#13151a;border:none;cursor:pointer;font-family:inherit;transition:all 0.15s;border-right:1px solid #2a2d35;}
.gran-btn.active{font-weight:700;color:#fff;background:#6c63ff;}
.date-sep{color:#555b66;font-size:13px;padding-bottom:7px;}

/* â”€â”€ ì„¹ì…˜ êµ¬ë¶„ì„  â”€â”€ */
.kpi-section{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;}
.kpi-section-label{font-size:10px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
.kpi-section-label::before{content:'';display:inline-block;width:20px;height:1px;background:#2a2d35;}
.kpi-section-label::after{content:'';flex:1;height:1px;background:#1e2128;}

/* â”€â”€ KPI ê·¸ë¦¬ë“œ â”€â”€ */
/* â”€â”€ ë©”ì¸/ì„œë¸Œíƒ­ â”€â”€ */
#main-nav{display:flex;gap:0;padding:0 24px;border-bottom:1px solid #1e2128;background:#13151a;}
.main-tab-btn{padding:11px 24px;font-size:13px;font-weight:500;color:#6c7280;background:transparent;border:none;border-bottom:2px solid transparent;cursor:pointer;font-family:inherit;transition:all 0.15s;border-radius:10px 10px 0 0;}
.main-tab-btn.active,.main-tab-btn:hover{color:#e1e4ea;}
.main-tab-btn.active{font-weight:700;border-bottom-color:#6c63ff;background:#1e2128;}
#mkt-subnav{display:flex;gap:6px;padding:10px 24px;background:#13151a;border-bottom:1px solid #2a2d35;}
.mkt-sub-btn{padding:6px 18px;font-size:12px;font-weight:500;color:#6c7280;background:#1a1d24;border:1px solid #2a2d35;border-radius:8px;cursor:pointer;font-family:inherit;transition:all 0.15s;}
.mkt-sub-btn.active{font-weight:700;color:#fff;background:#6c63ff;border-color:#6c63ff;}
/* â”€â”€ 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ â”€â”€ */
#chan-nav{display:none;flex-wrap:wrap;gap:5px;padding:8px 24px;background:#0f1117;border-bottom:1px solid #1e2128;align-items:center;}
#chan-nav .chan-label{font-size:9px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;margin-right:4px;}
.chan-btn{padding:4px 14px;font-size:11px;font-weight:500;background:#13151a;border:1px solid #1e2128;border-radius:6px;cursor:pointer;font-family:inherit;transition:all 0.15s;color:#6c7280;}
.chan-btn:hover{color:#e1e4ea;border-color:#2a2d35;}
.chan-btn.active{font-weight:700;background:#38bdf822;border-color:#38bdf8;color:#38bdf8;}
.tab-section{display:none;}
.subtab-section{display:none;}
.sub-content{padding:16px 24px 40px;}
/* â”€â”€ ê·¸ë¦¬ë“œ â”€â”€ */
.kpi-grid-7{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;}
.kpi-grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.kpi-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.kpi-card{background:linear-gradient(135deg,#1e2128 0%,#23272f 100%);border-radius:10px;padding:12px 14px;border:1px solid #2a2d35;position:relative;overflow:hidden;min-width:0;}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2.5px;background:var(--accent,#6c63ff);}
.kpi-title{font-size:10px;color:#6c7280;font-weight:600;letter-spacing:0.3px;margin-bottom:5px;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.kpi-value-row{display:flex;align-items:baseline;gap:3px;}
.kpi-value{font-size:20px;font-weight:700;color:#f0f2f5;letter-spacing:-0.3px;font-variant-numeric:tabular-nums;white-space:nowrap;}
.kpi-unit{font-size:11px;color:#6c7280;}
.kpi-sub{font-size:10px;color:#4b5059;margin-top:2px;}

/* â”€â”€ ì°¨íŠ¸ ê·¸ë¦¬ë“œ â”€â”€ */
.chart-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;}
.chart-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
.chart-box{background:#1e2128;border-radius:14px;padding:18px;border:1px solid #2a2d35;}
.chart-title{font-size:12px;font-weight:600;color:#c9cdd5;margin-bottom:14px;}
.chart-box canvas{display:block;}
.chart-inner{position:relative;height:220px;width:100%;}
.chart-inner-lg{position:relative;height:240px;width:100%;}

/* â”€â”€ í…Œì´ë¸” â”€â”€ */
.table-section{margin-bottom:20px;}
.table-title{font-size:12px;font-weight:600;color:#c9cdd5;margin-bottom:8px;}
.table-wrap{overflow-x:auto;max-height:440px;border-radius:12px;border:1px solid #2a2d35;}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead th{padding:10px 12px;text-align:left;background:#1a1d24;color:#6c7280;font-weight:600;font-size:10px;letter-spacing:0.5px;text-transform:uppercase;border-bottom:1px solid #2a2d35;white-space:nowrap;position:sticky;top:0;z-index:1;}
thead th.right{text-align:right;}
tbody tr:nth-child(even){background:#21242b;}
tbody tr:nth-child(odd){background:#1e2128;}
tbody td{padding:9px 12px;color:#d1d5db;border-bottom:1px solid #252830;white-space:nowrap;font-variant-numeric:tabular-nums;}
tbody td.right{text-align:right;}

/* â”€â”€ ë¡œë”© / ì—ëŸ¬ â”€â”€ */
#loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:16px;}
.spinner{width:36px;height:36px;border:3px solid #2a2d35;border-top-color:#6c63ff;border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:13px;color:#6c7280;}
#error-msg{display:none;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:12px;color:#ef4444;font-size:13px;}

@media(max-width:1200px){.kpi-grid-7{grid-template-columns:repeat(4,1fr)}.kpi-grid-5{grid-template-columns:repeat(3,1fr)}.kpi-grid-4{grid-template-columns:repeat(2,1fr)}.chart-grid-3{grid-template-columns:1fr 1fr}}
@media(max-width:768px){.kpi-grid-7,.kpi-grid-5,.kpi-grid-4{grid-template-columns:repeat(2,1fr)}.chart-grid-3,.chart-grid-2{grid-template-columns:1fr}}

/* ì¸ì‚¬ì´íŠ¸ ë²„íŠ¼ */
#btn-insight{padding:7px 14px;border-radius:8px;border:1px solid #6c63ff55;background:#6c63ff18;color:#a78bfa;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;transition:all 0.15s;}
#btn-insight:hover{background:#6c63ff33;border-color:#6c63ff;}

/* KPI ì¹´ë“œ ì„¸ë¡œí˜• (í¼í¬ë¨¼ìŠ¤ 3ì»¬ëŸ¼ìš©) */
.kpi-card-v{background:#181b24;border-radius:8px;border:1px solid #1e2330;
  padding:8px 10px;display:flex;align-items:center;gap:8px;min-width:0;
  transition:border-color .15s,background .15s;}
.kpi-card-v:hover,.kpi-card-v.kpi-clickable:hover{border-color:var(--accent,#6c63ff);background:#1e2230;cursor:pointer;}
.kpiv-bar{width:3px;border-radius:2px;align-self:stretch;background:var(--accent,#6c63ff);flex-shrink:0;}
.kpiv-info{flex:1;min-width:0;}
.kpiv-label{font-size:9px;color:#5a6080;font-weight:700;letter-spacing:.4px;text-transform:uppercase;
  margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.kpiv-value{font-size:13px;font-weight:800;color:#dde1ef;letter-spacing:-.3px;
  font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.kpiv-sub{font-size:9px;color:#5a6080;text-align:right;flex-shrink:0;max-width:80px;line-height:1.4;}

/* KPI ê°€ë¡œí˜• clickable */
.kpi-clickable{cursor:pointer;transition:border-color .15s,background .15s;}
.kpi-clickable:hover{border-color:var(--accent,#6c63ff) !important;background:#1e2230;}
.kpi-clickable::after{content:'ğŸ“ˆ';position:absolute;bottom:6px;right:9px;font-size:9px;opacity:.4;}

/* KPI ë¯¸ë‹ˆ ëª¨ë‹¬ */
#kpi-mini-modal{display:none;position:fixed;inset:0;z-index:2100;background:#00000065;
  align-items:center;justify-content:center;}
#kpi-mini-modal-box{background:#13151c;border-radius:14px;border:1px solid #1e2330;
  box-shadow:0 24px 60px #00000090;width:420px;overflow:hidden;}
.kmm-header{padding:11px 16px;border-bottom:1px solid #1e2330;
  display:flex;align-items:center;justify-content:space-between;}
.kmm-stats{display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:1px solid #1e2330;}
.kmm-stat{padding:9px 0;text-align:center;}
.kmm-stat-label{font-size:9px;color:#5a6080;margin-bottom:3px;}
.kmm-stat-val{font-size:13px;font-weight:800;color:#dde1ef;font-variant-numeric:tabular-nums;}
.kmm-chart-area{padding:12px 14px 14px;}
/* ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ ì»¨íŠ¸ë¡¤ */
.ins-lbl{font-size:9px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.ins-gran-btn{padding:4px 11px;border-radius:6px;border:none;cursor:pointer;font-family:inherit;font-size:11px;font-weight:600;background:#2a2d35;color:#6c7280;transition:all 0.15s;}
.ins-gran-btn.active{background:#6c63ff;color:#fff;}
.ins-scope-btn{padding:4px 9px;border-radius:5px;border:none;cursor:pointer;font-family:inherit;font-size:9px;font-weight:700;background:#2a2d35;color:#8a8f98;transition:all 0.15s;}
.ins-scope-btn.active{color:#fff;}
.ins-cmp-box{padding:8px 12px;background:#1a1d24;border-radius:8px;border:1px solid #2a2d35;display:flex;gap:10px;align-items:flex-end;}
.ins-metric-tab{padding:4px 10px;border-radius:5px;border:none;cursor:pointer;font-family:inherit;font-size:10px;font-weight:600;background:#1e2128;color:#6c7280;transition:all 0.15s;}
.ins-metric-tab.active{background:#6c63ff;color:#fff;}
.ins-kpi-card{background:#1a1d24;border-radius:8px;padding:9px 11px;border:1px solid #2a2d35;}
.ins-kpi-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #1e2128;}
.ins-kpi-row:last-child{border-bottom:none;}
.ins-rank-card{background:#1a1d24;border-radius:7px;padding:8px 10px;border:1px solid #2a2d35;margin-bottom:5px;}
.ins-auto-card{background:#1a2030;border:1px solid #4a9eff33;border-radius:7px;padding:8px 10px;margin-top:8px;}
.ins-tbl-wrap{background:#13151a;border-radius:10px;border:1px solid #2a2d35;overflow:hidden;}
.ins-tbl-grp-hd{padding:5px 10px;background:#1e2128;font-size:9px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;cursor:pointer;user-select:none;}
.ins-tbl-grp-hd:hover{background:#2a2d35;}
.goal-card{background:#13151a;border-radius:10px;padding:12px 14px;border:1px solid #2a2d35;border-top:2px solid #2a2d35;transition:border-top-color 0.3s;}
.gc-header{display:flex;align-items:center;gap:5px;margin-bottom:8px;}
.gc-icon{font-size:12px;}
.gc-label{font-size:10px;color:#6c7280;font-weight:600;flex:1;}
.gc-rate{font-size:11px;font-weight:700;padding:1px 6px;border-radius:4px;background:#2a2d3566;}
.gc-actual{font-size:16px;font-weight:700;color:#e1e4ea;margin-bottom:2px;}
.gc-actual .gc-unit{font-size:11px;color:#555b66;margin-left:2px;}
.gc-target{font-size:10px;color:#555b66;margin-bottom:6px;}
.gc-bar-wrap{height:5px;background:#2a2d35;border-radius:3px;overflow:hidden;margin-bottom:6px;}
.gc-bar{height:100%;border-radius:3px;transition:width 0.5s ease,background 0.3s;}
.gc-remain{font-size:9px;color:#6c7280;min-height:12px;}
.gc-pace{font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;white-space:nowrap;}
.gc-bar-wrap{position:relative;}
.gc-pace-mark{position:absolute;top:-2px;width:2px;height:9px;border-radius:1px;pointer-events:none;}
.ins-inp{padding:5px 8px;border-radius:6px;border:1px solid #2a2d35;background:#1e2128;color:#e1e4ea;font-size:11px;outline:none;color-scheme:dark;font-family:inherit;}
.ins-quick-btn{padding:4px 9px;border-radius:6px;border:1px solid #2a2d35;background:transparent;color:#8a8f98;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s;}
.ins-quick-btn:hover,.ins-quick-btn.active{background:#6c63ff;color:#fff;border-color:#6c63ff;}
/* ìë™ìš”ì•½ ì¹´ë“œ */
.as-section{margin-bottom:12px;}
.as-title{font-size:10px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:8px;}
.as-title::after{content:'';flex:1;height:1px;background:#1e2128;}
.as-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;}
@media(max-width:900px){.as-cards{grid-template-columns:1fr 1fr;}}
.as-card{background:#13151a;border-radius:8px;padding:11px 13px;border-left:3px solid var(--ac,#6c63ff);font-size:11px;}
.as-card .ac-lbl{color:#555b66;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}
.as-card .ac-val{color:#e1e4ea;font-weight:700;font-size:13px;margin-bottom:2px;}
.as-card .ac-sub{color:#6c7280;font-size:10px;line-height:1.5;}
.as-insight{background:#13151a;border-radius:7px;padding:8px 11px;border:1px solid #2a2d35;}
.as-insight .ai-icon{margin-right:4px;}
.as-insight .ai-title{font-size:11px;font-weight:700;color:#e1e4ea;margin-bottom:2px;}
.as-insight .ai-body{font-size:10px;color:#8a8f98;line-height:1.6;}
/* ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ */
.insight-card{background:#13151a;border-radius:10px;padding:14px 16px;border-left:3px solid var(--accent,#6c63ff);}
.insight-card .ic-title{font-size:13px;font-weight:600;color:#e1e4ea;margin-bottom:4px;}
.insight-card .ic-desc{font-size:12px;color:#8a8f98;line-height:1.6;}
.insight-card .ic-val{font-size:11px;color:#555b66;margin-top:6px;font-variant-numeric:tabular-nums;}
/* ë¸Œë ˆì´í¬ë‹¤ìš´ í…Œì´ë¸” */
.bd-tbl{width:100%;border-collapse:collapse;font-size:11px;}
.bd-tbl th{padding:7px 12px;background:#1a1d24;color:#555b66;font-size:9px;font-weight:700;
  letter-spacing:0.5px;text-transform:uppercase;white-space:nowrap;position:sticky;top:0;z-index:2;border-bottom:1px solid #2a2d35;}
.bd-tbl th.r{text-align:right;}
.bd-tbl td{padding:6px 12px;border-bottom:1px solid #1e2128;white-space:nowrap;font-variant-numeric:tabular-nums;}
.bd-tbl td.r{text-align:right;}
.bd-tbl tr.grp-hd td{background:#1a1d24;color:#a78bfa;font-weight:700;font-size:11px;padding:8px 12px;}
.bd-tbl tr.avg-row td{background:#1e2128;color:#6c7280;font-weight:600;border-top:2px solid #2a2d35;}
.bd-tbl tr:nth-child(even):not(.grp-hd):not(.avg-row){background:#13151a;}
.bd-tbl tr:nth-child(odd):not(.grp-hd):not(.avg-row){background:#1a1d24;}
.hi-good{color:#34d399!important;font-weight:700!important;}
.hi-bad{color:#ef4444!important;font-weight:700!important;}
</style>
</head>
<body>

<!-- ë¡œë”© -->
<div id="loading">
  <div class="spinner"></div>
  <div class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<!-- ì—ëŸ¬ -->
<div id="error-msg">
  <div>âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
  <div id="error-detail" style="color:#6c7280;font-size:12px;"></div>
</div>

<!-- ì•± ë³¸ì²´ -->
<!-- â•â• ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© ì…ë ¥ ëª¨ë‹¬ â•â• -->
<!-- â•â• KPI ë¯¸ë‹ˆ ëª¨ë‹¬ â•â• -->
<div id="kpi-mini-modal">
  <div id="kpi-mini-modal-box">
    <div class="kmm-header" id="kmm-header"
      style="background:linear-gradient(90deg,var(--kmm-accent,#6c63ff)0e 0%,transparent 60%);
             border-left:3px solid var(--kmm-accent,#6c63ff);">
      <div>
        <div id="kmm-title" style="font-size:13px;font-weight:800;color:#dde1ef;"></div>
        <div id="kmm-meta"  style="font-size:9px;color:#5a6080;margin-top:2px;"></div>
      </div>
      <button onclick="kpiMiniClose()"
        style="background:none;border:none;color:#5a6080;font-size:16px;cursor:pointer;padding:2px 6px;">âœ•</button>
    </div>
    <div class="kmm-stats">
      <div class="kmm-stat" style="border-right:1px solid #1e2330;">
        <div class="kmm-stat-label">ìµœì†Ÿê°’</div>
        <div class="kmm-stat-val" id="kmm-min">-</div>
      </div>
      <div class="kmm-stat" style="border-right:1px solid #1e2330;">
        <div class="kmm-stat-label">í‰ê· </div>
        <div class="kmm-stat-val" id="kmm-avg" style="color:var(--kmm-accent,#6c63ff);">-</div>
      </div>
      <div class="kmm-stat">
        <div class="kmm-stat-label">ìµœëŒ“ê°’</div>
        <div class="kmm-stat-val" id="kmm-max">-</div>
      </div>
    </div>
    <div class="kmm-chart-area">
      <div style="position:relative;height:140px;width:100%;">
        <canvas id="kmm-canvas"></canvas>
      </div>
      <div style="font-size:9px;color:#5a6080;text-align:right;margin-top:4px;">-- ì ì„ : ê¸°ê°„ í‰ê· </div>
    </div>
  </div>
</div>

<div id="brand-cost-modal"
  style="display:none;position:fixed;inset:0;z-index:2000;background:#0c0e12e8;
         align-items:center;justify-content:center;">
  <div style="background:#1a1d24;border:1px solid #2a2d35;border-radius:16px;
              width:560px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;">

    <!-- í—¤ë” -->
    <div style="padding:16px 20px;border-bottom:1px solid #2a2d35;
                display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
      <span style="font-size:14px;font-weight:700;color:#fbbf24;">ğŸ’° ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© ì…ë ¥</span>
      <button id="btn-brand-cost-close"
        style="background:none;border:none;color:#6c7280;font-size:20px;cursor:pointer;padding:2px 8px;">âœ•</button>
    </div>

    <!-- ì…ë ¥ í¼ -->
    <div style="padding:16px 20px;border-bottom:1px solid #2a2d35;background:#13151a;flex-shrink:0;">
      <div style="font-size:10px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">
        ìƒˆ ë¹„ìš© ì¶”ê°€
      </div>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
        <div>
          <div style="font-size:9px;color:#6c7280;margin-bottom:4px;">ìº í˜ì¸ëª…</div>
          <input type="text" id="bc-campaign" placeholder="ìº í˜ì¸ëª… (ì¼ë¶€ í¬í•¨ í…ìŠ¤íŠ¸)"
            style="padding:6px 10px;border-radius:8px;border:1px solid #2a2d35;background:#1e2128;
                   color:#e1e4ea;font-size:12px;outline:none;font-family:inherit;min-width:180px;">
        </div>
        <div>
          <div style="font-size:9px;color:#6c7280;margin-bottom:4px;">ì‹œì‘ì¼</div>
          <input type="date" id="bc-from"
            style="padding:6px 10px;border-radius:8px;border:1px solid #2a2d35;background:#1e2128;
                   color:#e1e4ea;font-size:12px;outline:none;color-scheme:dark;font-family:inherit;">
        </div>
        <div>
          <div style="font-size:9px;color:#6c7280;margin-bottom:4px;">ì¢…ë£Œì¼</div>
          <input type="date" id="bc-to"
            style="padding:6px 10px;border-radius:8px;border:1px solid #2a2d35;background:#1e2128;
                   color:#e1e4ea;font-size:12px;outline:none;color-scheme:dark;font-family:inherit;">
        </div>
        <div>
          <div style="font-size:9px;color:#6c7280;margin-bottom:4px;">ì´ë¹„ìš© (ì›)</div>
          <input type="number" id="bc-cost" placeholder="ì˜ˆ: 5000000" min="0"
            style="padding:6px 10px;border-radius:8px;border:1px solid #2a2d35;background:#1e2128;
                   color:#e1e4ea;font-size:12px;outline:none;font-family:inherit;width:140px;">
        </div>
        <button id="btn-bc-add"
          style="padding:7px 18px;border-radius:8px;border:none;background:#fbbf24;color:#000;
                 font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;">
          ï¼‹ ì¶”ê°€
        </button>
      </div>
      <div id="bc-error" style="display:none;margin-top:8px;font-size:11px;color:#ef4444;"></div>
    </div>

    <!-- ë“±ë¡ëœ ë¹„ìš© ëª©ë¡ -->
    <div style="flex:1;overflow-y:auto;padding:16px 20px;">
      <div style="font-size:10px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">
        ë“±ë¡ëœ ë¹„ìš© í•­ëª© <span id="bc-count" style="color:#fbbf24;"></span>
      </div>
      <div id="bc-list">
        <div style="color:#555b66;font-size:12px;">ë“±ë¡ëœ í•­ëª©ì´ ì—†ì–´ìš”. ìœ„ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
      </div>
    </div>

    <!-- í‘¸í„° -->
    <div style="padding:12px 20px;border-top:1px solid #2a2d35;display:flex;justify-content:space-between;
                align-items:center;flex-shrink:0;background:#13151a;">
      <span id="bc-summary" style="font-size:11px;color:#6c7280;"></span>
      <button id="btn-bc-apply"
        style="padding:7px 22px;border-radius:8px;border:none;background:#6c63ff;color:#fff;
               font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;">
        ëŒ€ì‹œë³´ë“œì— ë°˜ì˜ â–¶
      </button>
    </div>

  </div>
</div>

<!-- â•â• ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ â€” ì „ì²´í™”ë©´ ì™€ì´ë“œ â•â• -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ëª©í‘œ ì…ë ¥ ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="goal-modal" style="display:none;position:fixed;inset:0;z-index:1100;
  background:#000000cc;align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#13151a;border-radius:14px;border:1px solid #2a2d35;
              padding:22px 24px;width:400px;max-width:90vw;
              box-shadow:0 20px 60px #00000088;">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <span style="font-size:14px;font-weight:700;color:#e1e4ea;">ğŸ¯ ëª©í‘œ ì„¤ì •</span>
      <button id="btn-goal-modal-close"
        style="background:none;border:none;color:#6c7280;font-size:18px;cursor:pointer;line-height:1;">âœ•</button>
    </div>

    <!-- ëª©í‘œ ê¸°ê°„ -->
    <div style="margin-bottom:14px;padding:10px 12px;background:#1a1d24;
                border-radius:8px;border:1px solid #2a2d35;">
      <div style="font-size:9px;color:#555b66;font-weight:700;letter-spacing:1px;
                  text-transform:uppercase;margin-bottom:8px;">ëª©í‘œ ê¸°ê°„</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="date" id="goal-from" class="ins-inp" style="flex:1;">
        <span style="color:#555b66;font-size:12px;">â€”</span>
        <input type="date" id="goal-to"   class="ins-inp" style="flex:1;">
      </div>
      <div style="margin-top:6px;font-size:10px;color:#555b66;">
        ğŸ’¡ ë©”ì¸ í•„í„° ê¸°ê°„ê³¼ ì¼ì¹˜í•´ì•¼ ê³„ì‚°ë©ë‹ˆë‹¤
      </div>
    </div>

    <!-- ëª©í‘œ ìˆ˜ì¹˜ ì…ë ¥ -->
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px;">
      <div>
        <div style="font-size:10px;color:#6c7280;font-weight:600;margin-bottom:4px;">ğŸ’° ëª©í‘œ ì´ë§¤ì¶œ</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="number" id="goal-total-revenue" placeholder="ì˜ˆ: 500000000"
            style="flex:1;padding:6px 8px;border-radius:6px;border:1px solid #2a2d35;
                   background:#1e2128;color:#e1e4ea;font-size:11px;outline:none;font-family:inherit;">
          <span style="font-size:10px;color:#555b66;min-width:14px;">ì›</span>
        </div>
      </div>
      <div>
        <div style="font-size:10px;color:#6c7280;font-weight:600;margin-bottom:4px;">ğŸ›’ ëª©í‘œ íŒë§¤ê±´ìˆ˜</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="number" id="goal-total-sales" placeholder="ì˜ˆ: 2000"
            style="flex:1;padding:6px 8px;border-radius:6px;border:1px solid #2a2d35;
                   background:#1e2128;color:#e1e4ea;font-size:11px;outline:none;font-family:inherit;">
          <span style="font-size:10px;color:#555b66;min-width:14px;">ê±´</span>
        </div>
      </div>
      <div>
        <div style="font-size:10px;color:#6c7280;font-weight:600;margin-bottom:4px;">ğŸ“¢ ëª©í‘œ ê´‘ê³ ë¹„ìš©</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="number" id="goal-ad-spend" placeholder="ì˜ˆ: 30000000"
            style="flex:1;padding:6px 8px;border-radius:6px;border:1px solid #2a2d35;
                   background:#1e2128;color:#e1e4ea;font-size:11px;outline:none;font-family:inherit;">
          <span style="font-size:10px;color:#555b66;min-width:14px;">ì›</span>
        </div>
      </div>
      <div>
        <div style="font-size:10px;color:#6c7280;font-weight:600;margin-bottom:4px;">ğŸ“ˆ ëª©í‘œ ROAS</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="number" id="goal-roas" placeholder="ì˜ˆ: 350"
            style="flex:1;padding:6px 8px;border-radius:6px;border:1px solid #2a2d35;
                   background:#1e2128;color:#e1e4ea;font-size:11px;outline:none;font-family:inherit;">
          <span style="font-size:10px;color:#555b66;min-width:14px;">%</span>
        </div>
      </div>
      <div>
        <div style="font-size:10px;color:#6c7280;font-weight:600;margin-bottom:4px;">ğŸ¯ ëª©í‘œ ì „í™˜ë§¤ì¶œ</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="number" id="goal-conv-revenue" placeholder="ì˜ˆ: 100000000"
            style="flex:1;padding:6px 8px;border-radius:6px;border:1px solid #2a2d35;
                   background:#1e2128;color:#e1e4ea;font-size:11px;outline:none;font-family:inherit;">
          <span style="font-size:10px;color:#555b66;min-width:14px;">ì›</span>
        </div>
      </div>
    </div>

    <button id="btn-goal-apply"
      style="width:100%;padding:10px 0;border-radius:8px;border:none;
             background:#6c63ff;color:#fff;font-weight:700;font-size:12px;
             cursor:pointer;font-family:inherit;">
      ì ìš© â–¶
    </button>
  </div>
</div>

<div id="insight-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:#0c0e12f0;flex-direction:column;">

  <!-- â”€â”€ í—¤ë” â”€â”€ -->
  <div style="padding:11px 24px;background:#1a1d24;border-bottom:1px solid #2a2d35;
              display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:10px;flex-wrap:wrap;">
    <div style="display:flex;align-items:center;gap:10px;">
      <span style="font-size:14px;font-weight:700;color:#f0f2f5;">ğŸ’¡ ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸</span>
      <span id="ins-period-badge"
        style="font-size:9px;color:#6c7280;background:#1c2030;border:1px solid #252a3a;
               border-radius:5px;padding:2px 9px;white-space:nowrap;"></span>
      <span id="ins-ch-badge" style="display:none;font-size:10px;font-weight:600;
        border-radius:5px;padding:2px 9px;"></span>
    </div>
    <button id="btn-insight-close"
      style="background:none;border:none;color:#6c7280;font-size:20px;cursor:pointer;padding:2px 8px;">âœ•</button>
  </div>

  <!-- â”€â”€ í•„í„° ë°” â”€â”€ -->
  <div style="padding:8px 24px;background:#0f1119;border-bottom:1px solid #252a3a;
              display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;flex-shrink:0;">

    <!-- ë‚ ì§œ ì§ì ‘ ì…ë ¥ -->
    <div>
      <div class="ins-lbl">ë¶„ì„ ê¸°ê°„</div>
      <div style="display:flex;align-items:center;gap:5px;">
        <input type="date" id="ins-from" class="ins-inp">
        <span style="color:#555b66;font-size:9px;">â€”</span>
        <input type="date" id="ins-to" class="ins-inp">
      </div>
    </div>

    <!-- ë¹ ë¥¸ ì„ íƒ -->
    <div>
      <div class="ins-lbl">ë¹ ë¥¸ ì„ íƒ</div>
      <div style="display:flex;gap:3px;">
        <button class="ins-quick-btn" data-days="1">ìµœê·¼ 1ì¼</button>
        <button class="ins-quick-btn" data-days="3">ìµœê·¼ 3ì¼</button>
        <button class="ins-quick-btn" data-days="7">ìµœê·¼ 7ì¼</button>
        <button class="ins-quick-btn" data-days="14">ìµœê·¼ 14ì¼</button>
        <button class="ins-quick-btn" data-days="30">ìµœê·¼ 30ì¼</button>
      </div>
    </div>

    <!-- ì±„ë„ -->
    <div>
      <div class="ins-lbl">ì±„ë„</div>
      <select id="ins-sel-channel" class="ins-inp" style="cursor:pointer;">
        <option value="ì „ì²´">ì „ì²´</option>
      </select>
    </div>

    <!-- ìº í˜ì¸ í…ìŠ¤íŠ¸ í•„í„° -->
    <div>
      <div class="ins-lbl">ìº í˜ì¸ í•„í„°</div>
      <input type="text" id="ins-camp-filter" class="ins-inp"
        placeholder="ì±„ë„ ì„ íƒ í›„ í™œì„±" disabled
        style="min-width:160px;">
    </div>

    <!-- ì¸ì‚¬ì´íŠ¸ / ì°¨íŠ¸ íƒ­ í† ê¸€ -->
    <div style="margin-left:auto;display:flex;gap:2px;background:#1c2030;border-radius:7px;
                padding:2px;border:1px solid #252a3a;">
      <button id="ins-tab-insight" data-instab="insight"
        style="padding:4px 14px;border-radius:5px;border:none;cursor:pointer;font-family:inherit;
               font-size:10px;font-weight:700;background:#181b24;color:#e2e5ef;transition:all .15s;">
        ğŸ’¡ ì¸ì‚¬ì´íŠ¸
      </button>
      <button id="ins-tab-chart" data-instab="chart"
        style="padding:4px 14px;border-radius:5px;border:none;cursor:pointer;font-family:inherit;
               font-size:10px;font-weight:400;background:transparent;color:#6b7394;transition:all .15s;">
        ğŸ“ˆ ì°¨íŠ¸
      </button>
    </div>
  </div>

  <!-- â”€â”€ ë³¸ë¬¸ â”€â”€ -->
  <div id="ins-body" style="flex:1;overflow-y:auto;padding:14px 20px;min-height:0;">
    <div style="color:#6b7394;font-size:12px;text-align:center;padding:60px 0;">
      ê¸°ê°„ì„ ì„¤ì •í•˜ê³  ì±„ë„ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    </div>
  </div>

</div>

<div id="app">
  <!-- â”€â”€ Global Header â”€â”€ -->
  <header>
    <div class="logo-wrap">
      <div class="logo">G</div>
      <div>
        <div class="logo-text">Growth Dashboard</div>
        <div class="logo-sub">ê·¸ë¡œìŠ¤íŒ€ í†µí•© ëŒ€ì‹œë³´ë“œ</div>
      </div>
    </div>
    <div id="last-updated" style="font-size:11px;color:#555b66;"></div>
  </header>

  <!-- â”€â”€ ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ -->
  <nav id="main-nav">
    <button class="main-tab-btn active" data-tab="product">ğŸ“Š í”„ë¡œë•íŠ¸</button>
    <button class="main-tab-btn" data-tab="marketing">ğŸ“¢ ë§ˆì¼€íŒ…</button>
  </nav>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë§ˆì¼€íŒ… íƒ­
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-marketing" class="tab-section" style="display:none;">

    <!-- ì„œë¸Œíƒ­ -->
    <div id="mkt-subnav">
      <button class="mkt-sub-btn active" data-sub="total">ğŸ“Š TOTAL</button>
      <button class="mkt-sub-btn" data-sub="perf">ğŸ¯ í¼í¬ë¨¼ìŠ¤</button>
      <button class="mkt-sub-btn" data-sub="crm">ğŸ’¬ CRM</button>
    </div>

    <!-- â”€â”€ 3ë‹¨ê³„: ì±„ë„ ë„¤ë¹„ (perf/crm ì„ íƒ ì‹œ í‘œì‹œ) â”€â”€ -->
    <div id="chan-nav">
      <span class="chan-label" id="chan-nav-label">ì±„ë„</span>
      <!-- JSë¡œ ë™ì  ìƒì„± -->
    </div>

    <!-- â”€â”€ í¼í¬ë¨¼ìŠ¤ ì„œë¸Œíƒ­ (ê¸°ì¡´ ì „ì²´) â”€â”€ -->
    <div id="subtab-perf" class="subtab-section" style="display:none;">
      <main>

      <!-- ëª©í‘œì„¤ì • í–‰ (ctrl-bar ìœ„ ë…ë¦½ row) -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:8px 14px;
                  background:#1a1d24;border-radius:10px;border:1px solid #2a2d35;">
        <span style="font-size:10px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;">ğŸ¯ ëª©í‘œ ì„¤ì •</span>
        <div style="width:1px;height:14px;background:#2a2d35;"></div>
        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
          <input type="checkbox" id="chk-goal-on"
            style="width:13px;height:13px;accent-color:#fbbf24;cursor:pointer;">
          <span style="font-size:11px;font-weight:600;color:#8a8f98;">ëª©í‘œ í™œì„±í™”</span>
        </label>
        <button id="btn-goal-input" style="display:none;
          padding:5px 11px;border-radius:7px;border:1px solid #fbbf2466;background:#fbbf2415;
          color:#fbbf24;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;">
          ê¸°ê°„ ì…ë ¥ âœï¸
        </button>
        <div style="flex:1;"></div>
        <!-- ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© -->
        <span style="font-size:10px;font-weight:700;color:#555b66;letter-spacing:.5px;">ë¸Œëœë“œê²€ìƒ‰</span>
        <button id="btn-brand-cost"
          style="padding:5px 12px;border-radius:7px;border:1px solid #fbbf2455;background:#fbbf2412;
                 color:#fbbf24;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;
                 display:flex;align-items:center;gap:5px;white-space:nowrap;">
          ğŸ’° ë¹„ìš© ì…ë ¥
        </button>
        <!-- ì¸ì‚¬ì´íŠ¸ ë²„íŠ¼ -->
        <button id="btn-insight" title="ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸"
          style="padding:5px 12px;border-radius:7px;border:1px solid #6c63ff55;background:#6c63ff18;
                 color:#a78bfa;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;
                 display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all .15s;">
          ğŸ’¡ ì¸ì‚¬ì´íŠ¸
        </button>
      </div>

      <!-- ì»¨íŠ¸ë¡¤ ë°” -->
      <div class="ctrl-bar">
        <div class="ctrl-group">
          <label class="ctrl-label">ì‹œì‘ì¼</label>
          <input type="date" id="date-from">
        </div>
        <div class="date-sep">â€”</div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì¢…ë£Œì¼</label>
          <input type="date" id="date-to">
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì§‘ê³„ ë‹¨ìœ„</label>
          <div class="gran-wrap">
            <button class="gran-btn" data-gran="daily">ì¼ë³„</button>
            <button class="gran-btn" data-gran="weekly">ì£¼ë³„</button>
            <button class="gran-btn active" data-gran="monthly">ì›”ë³„</button>
          </div>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì±„ë„</label>
          <select id="sel-channel">
            <option value="ì „ì²´">ì „ì²´</option>
          </select>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ìº í˜ì¸</label>
          <select id="sel-campaign" disabled>
            <option value="ì „ì²´">ì „ì²´</option>
          </select>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ìº í˜ì¸ ê²€ìƒ‰</label>
          <input type="text" id="camp-search" placeholder="í¬í•¨ í…ìŠ¤íŠ¸ ì…ë ¥..." style="padding:6px 10px;border-radius:8px;border:1px solid #2a2d35;background:#13151a;color:#e1e4ea;font-size:12px;outline:none;font-family:inherit;min-width:150px;" />
        </div>
      </div>

      <!-- ëª©í‘œ ëŒ€ë¹„ í˜„í™© ì„¹ì…˜ (GOAL_ON ì‹œ í‘œì‹œ) -->
      <div id="goal-section" style="display:none;margin-bottom:4px;">
        <!-- ê¸°ê°„ ë¶ˆì¼ì¹˜ ê²½ê³  -->
        <div id="goal-period-warn" style="display:none;margin-bottom:8px;padding:8px 14px;
          background:#fbbf2418;border:1px solid #fbbf2444;border-radius:8px;
          font-size:11px;color:#fbbf24;display:none;align-items:center;gap:8px;">
          âš ï¸ ëª©í‘œ ê¸°ê°„ì´ ë©”ì¸ í•„í„° ê¸°ê°„ê³¼ ë‹¤ë¦…ë‹ˆë‹¤. <strong>ê¸°ê°„ì„ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš”.</strong>
        </div>

        <!-- ì„¹ì…˜ í—¤ë” -->
        <div style="font-size:10px;font-weight:700;color:#fbbf24;letter-spacing:1px;
                    text-transform:uppercase;margin-bottom:10px;
                    display:flex;align-items:center;gap:8px;">
          ğŸ¯ ëª©í‘œ ëŒ€ë¹„ í˜„í™©
          <span id="goal-period-label" style="font-size:9px;color:#555b66;font-weight:400;text-transform:none;letter-spacing:0;"></span>
          <span style="flex:1;height:1px;background:#1e2128;display:block;"></span>
          <!-- (2) ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ ëª©í‘œ ëŒ€ë¹„ ì²´í¬ -->
          <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
            <input type="checkbox" id="chk-insight-goal"
              style="width:12px;height:12px;accent-color:#6c63ff;cursor:pointer;">
            <span style="font-size:10px;color:#8a8f98;font-weight:600;text-transform:none;letter-spacing:0;">
              ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ ëª©í‘œ ëŒ€ë¹„ í˜„í™© ë³´ê¸°
            </span>
          </label>
        </div>

        <!-- 5ê°œ ëª©í‘œ ì¹´ë“œ â€” gc-rate: ì „ì²´ë‹¬ì„±ë¥  / gc-pace: ì§„í–‰ì¼ìˆ˜ ëŒ€ë¹„ ë‹¬ì„±ë¥  -->
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:4px;">
          <div class="goal-card" id="gc-total-revenue" data-inv="false">
            <div class="gc-header">
              <span class="gc-icon">ğŸ’°</span>
              <span class="gc-label">ì´ ë§¤ì¶œ</span>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
                <span class="gc-rate" id="gc-rate-revenue">-</span>
                <span class="gc-pace" id="gc-pace-revenue" style="color:#555b66;background:#2a2d35;">-</span>
              </div>
            </div>
            <div class="gc-actual"><span id="gc-val-revenue">-</span><span class="gc-unit">ì›</span></div>
            <div class="gc-target">ëª©í‘œ <span id="gc-goal-revenue">-</span>ì›</div>
            <div class="gc-bar-wrap">
              <div class="gc-bar" id="gc-bar-revenue"></div>
              <div class="gc-pace-mark" id="gc-pace-mark-revenue" style="display:none;"></div>
            </div>
            <div class="gc-remain" id="gc-remain-revenue">-</div>
          </div>
          <div class="goal-card" id="gc-total-sales" data-inv="false">
            <div class="gc-header">
              <span class="gc-icon">ğŸ›’</span>
              <span class="gc-label">íŒë§¤ê±´ìˆ˜</span>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
                <span class="gc-rate" id="gc-rate-sales">-</span>
                <span class="gc-pace" id="gc-pace-sales" style="color:#555b66;background:#2a2d35;">-</span>
              </div>
            </div>
            <div class="gc-actual"><span id="gc-val-sales">-</span><span class="gc-unit">ê±´</span></div>
            <div class="gc-target">ëª©í‘œ <span id="gc-goal-sales">-</span>ê±´</div>
            <div class="gc-bar-wrap">
              <div class="gc-bar" id="gc-bar-sales"></div>
              <div class="gc-pace-mark" id="gc-pace-mark-sales" style="display:none;"></div>
            </div>
            <div class="gc-remain" id="gc-remain-sales">-</div>
          </div>
          <div class="goal-card" id="gc-ad-spend" data-inv="true">
            <div class="gc-header">
              <span class="gc-icon">ğŸ“¢</span>
              <span class="gc-label">ê´‘ê³  ë¹„ìš©</span>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
                <span class="gc-rate" id="gc-rate-spend">-</span>
                <span class="gc-pace" id="gc-pace-spend" style="color:#555b66;background:#2a2d35;">-</span>
              </div>
            </div>
            <div class="gc-actual"><span id="gc-val-spend">-</span><span class="gc-unit">ì›</span></div>
            <div class="gc-target">ëª©í‘œ <span id="gc-goal-spend">-</span>ì›</div>
            <div class="gc-bar-wrap">
              <div class="gc-bar" id="gc-bar-spend"></div>
              <div class="gc-pace-mark" id="gc-pace-mark-spend" style="display:none;"></div>
            </div>
            <div class="gc-remain" id="gc-remain-spend">-</div>
          </div>
          <div class="goal-card" id="gc-roas" data-inv="false">
            <div class="gc-header">
              <span class="gc-icon">ğŸ“ˆ</span>
              <span class="gc-label">ROAS</span>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
                <span class="gc-rate" id="gc-rate-roas">-</span>
                <span class="gc-pace" id="gc-pace-roas" style="color:#555b66;background:#2a2d35;">-</span>
              </div>
            </div>
            <div class="gc-actual"><span id="gc-val-roas">-</span><span class="gc-unit">%</span></div>
            <div class="gc-target">ëª©í‘œ <span id="gc-goal-roas">-</span>%</div>
            <div class="gc-bar-wrap">
              <div class="gc-bar" id="gc-bar-roas"></div>
              <div class="gc-pace-mark" id="gc-pace-mark-roas" style="display:none;"></div>
            </div>
            <div class="gc-remain" id="gc-remain-roas">-</div>
          </div>
          <div class="goal-card" id="gc-conv-revenue" data-inv="false">
            <div class="gc-header">
              <span class="gc-icon">ğŸ¯</span>
              <span class="gc-label">ì „í™˜ ë§¤ì¶œ</span>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
                <span class="gc-rate" id="gc-rate-conv">-</span>
                <span class="gc-pace" id="gc-pace-conv" style="color:#555b66;background:#2a2d35;">-</span>
              </div>
            </div>
            <div class="gc-actual"><span id="gc-val-conv">-</span><span class="gc-unit">ì›</span></div>
            <div class="gc-target">ëª©í‘œ <span id="gc-goal-conv">-</span>ì›</div>
            <div class="gc-bar-wrap">
              <div class="gc-bar" id="gc-bar-conv"></div>
              <div class="gc-pace-mark" id="gc-pace-mark-conv" style="display:none;"></div>
            </div>
            <div class="gc-remain" id="gc-remain-conv">-</div>
          </div>
        </div>
      </div>

      <!-- â•â• KPI ì„¹ì…˜ ë¦¬ë‰´ì–¼ â•â• -->

      <!-- â‘  í”„ë¡œë•íŠ¸ ì§€í‘œ ì„¹ì…˜ (ê°€ë¡œ) -->
      <div id="kpi-sec-product" style="border-radius:12px;border:1px solid #1e2330;overflow:hidden;background:#13151c;margin-bottom:10px;">
        <div onclick="kpiToggle('product')"
          style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;
                 background:linear-gradient(90deg,#fbbf2410 0%,transparent 50%);
                 border-left:3px solid #fbbf24;cursor:pointer;user-select:none;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:13px;">ğŸ¨</span>
            <span style="font-size:12px;font-weight:800;color:#dde1ef;">í”„ë¡œë•íŠ¸ ì§€í‘œ</span>
            <span style="font-size:9px;font-weight:700;color:#fbbf24;background:#fbbf2418;border:1px solid #fbbf2430;border-radius:4px;padding:1px 7px;">7ê°œ ì§€í‘œ</span>
            <span id="product-kpi-status" style="font-size:9px;color:#555b66;">Â· product_rawdata ì—°ê²° ëŒ€ê¸°ì¤‘</span>
          </div>
          <span id="kpi-arrow-product" style="font-size:9px;color:#5a6080;transition:transform .2s;display:inline-block;">â–¼</span>
        </div>
        <div id="kpi-body-product" style="display:flex;gap:8px;padding:10px 14px 14px;border-top:1px solid #1e2330;">
          <div class="kpi-card kpi-clickable" data-kpi="pkv-total-revenue"  style="--accent:#fbbf24;flex:1;"><div class="kpi-title">ì´ ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-total-revenue">-</span></div><div class="kpi-sub" id="pkv-total-revenue-sub">ì¼í‰ê·  -</div></div>
          <div class="kpi-card kpi-clickable" data-kpi="pkv-total-sales"    style="--accent:#34d399;flex:1;"><div class="kpi-title">ì´ ê²°ì œê±´ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-total-sales">-</span><span class="kpi-unit">ê±´</span></div><div class="kpi-sub" id="pkv-total-sales-sub">ì¼í‰ê·  -</div></div>
          <div class="kpi-card kpi-clickable" data-kpi="pkv-total-nights"   style="--accent:#2dd4bf;flex:1;"><div class="kpi-title">ì´ ê²°ì œë°•ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-total-nights">-</span><span class="kpi-unit">ë°•</span></div><div class="kpi-sub" id="pkv-total-nights-sub">ì¼í‰ê·  -</div></div>
          <div class="kpi-card kpi-clickable" data-kpi="pkv-aov"            style="--accent:#a78bfa;flex:1;"><div class="kpi-title">ê°ë‹¨ê°€</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-aov">-</span></div><div class="kpi-sub">ì´ë§¤ì¶œÃ·ê²°ì œê±´ìˆ˜</div></div>
          <div class="kpi-card kpi-clickable" data-kpi="pkv-adr"            style="--accent:#818cf8;flex:1;"><div class="kpi-title">ADR</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-adr">-</span></div><div class="kpi-sub">ì´ë§¤ì¶œÃ·ê²°ì œë°•ìˆ˜</div></div>
          <div class="kpi-card kpi-clickable" data-kpi="pkv-los"            style="--accent:#38bdf8;flex:1;"><div class="kpi-title">LOS</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-los">-</span><span class="kpi-unit">ë°•</span></div><div class="kpi-sub">ê²°ì œë°•ìˆ˜Ã·ê²°ì œê±´ìˆ˜</div></div>
          <div class="kpi-card kpi-clickable" data-kpi="pkv-leadtime"       style="--accent:#f472b6;flex:1;"><div class="kpi-title">í‰ê·  ë¦¬ë“œíƒ€ì„</div><div class="kpi-value-row"><span class="kpi-value" id="pkv-leadtime">-</span><span class="kpi-unit">ì¼</span></div><div class="kpi-sub">ì˜ˆì•½â†’ì²´í¬ì¸ í‰ê· </div></div>
        </div>
      </div>

      <!-- â‘¡ í¼í¬ë¨¼ìŠ¤ ì§€í‘œ í†µí•© ì„¹ì…˜ (3ì»¬ëŸ¼) -->
      <div id="kpi-sec-perf" style="border-radius:12px;border:1px solid #1e2330;overflow:hidden;background:#13151c;margin-bottom:20px;">
        <div onclick="kpiToggle('perf')"
          style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;
                 background:linear-gradient(90deg,#6c63ff0f 0%,transparent 50%);
                 border-left:3px solid #6c63ff;cursor:pointer;user-select:none;">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <span style="font-size:13px;">ğŸ¯</span>
            <span style="font-size:12px;font-weight:800;color:#dde1ef;">í¼í¬ë¨¼ìŠ¤ ì§€í‘œ</span>
            <span style="font-size:9px;font-weight:700;color:#6c63ff;background:#6c63ff18;border:1px solid #6c63ff30;border-radius:4px;padding:1px 7px;">19ê°œ ì§€í‘œ</span>
            <span style="font-size:9px;font-weight:600;color:#38bdf8;background:#38bdf812;border:1px solid #38bdf825;border-radius:4px;padding:1px 7px;">ğŸ“Š ë³¼ë¥¨</span>
            <span style="font-size:9px;font-weight:600;color:#a78bfa;background:#a78bfa12;border:1px solid #a78bfa25;border-radius:4px;padding:1px 7px;">âš¡ ë‹¨ê°€Â·íš¨ìœ¨</span>
            <span style="font-size:9px;font-weight:600;color:#34d399;background:#34d39912;border:1px solid #34d39925;border-radius:4px;padding:1px 7px;">ğŸ” ì „í™˜ìœ¨</span>
          </div>
          <span id="kpi-arrow-perf" style="font-size:9px;color:#5a6080;transition:transform .2s;display:inline-block;">â–¼</span>
        </div>

        <div id="kpi-body-perf" style="display:grid;grid-template-columns:1fr 1fr 1fr;border-top:1px solid #1e2330;">

          <!-- ì»¬ëŸ¼1: í¼í¬ë¨¼ìŠ¤ ë³¼ë¥¨ -->
          <div style="border-right:1px solid #1e2330;">
            <div style="padding:8px 14px;display:flex;align-items:center;gap:6px;border-bottom:1px solid #1e2330;background:#38bdf807;">
              <span style="font-size:11px;">ğŸ“Š</span>
              <span style="font-size:10px;font-weight:800;color:#38bdf8;">í¼í¬ë¨¼ìŠ¤ ë³¼ë¥¨</span>
              <span style="font-size:9px;color:#5a6080;">7ê°œ</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;padding:10px 12px 12px;">
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-spend"        style="--accent:#ef4444;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ì´ ë¹„ìš©</div><div class="kpiv-value" id="kv-spend">-</div></div><div class="kpiv-sub">ì„ íƒ ê¸°ê°„ í•©ì‚°</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-impressions"  style="--accent:#818cf8;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ë…¸ì¶œìˆ˜</div><div class="kpiv-value" id="kv-impressions">-</div></div><div class="kpiv-sub">ì´ ë…¸ì¶œ íšŸìˆ˜</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-clicks"       style="--accent:#38bdf8;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">í´ë¦­ìˆ˜</div><div class="kpiv-value" id="kv-clicks">-</div></div><div class="kpiv-sub">ì´ í´ë¦­ íšŸìˆ˜</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-signups"      style="--accent:#34d399;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">íšŒì›ê°€ì…ìˆ˜</div><div class="kpiv-value" id="kv-signups">-</div></div><div class="kpiv-sub">ì‹ ê·œ ê°€ì…</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-detailviews"  style="--accent:#2dd4bf;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ìƒì„¸í˜ì´ì§€ ì¡°íšŒ</div><div class="kpiv-value" id="kv-detailviews">-</div></div><div class="kpiv-sub">ìƒì„¸ ì¡°íšŒ íšŸìˆ˜</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-conversions"  style="--accent:#fbbf24;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">êµ¬ë§¤ ì „í™˜</div><div class="kpiv-value" id="kv-conversions">-</div></div><div class="kpiv-sub">ê²°ì œ ê±´ìˆ˜</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-conv-revenue" style="--accent:#6c63ff;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ì „í™˜ ë§¤ì¶œ</div><div class="kpiv-value" id="kv-conv-revenue">-</div></div><div class="kpiv-sub">ê´‘ê³  ê¸°ì—¬ ë§¤ì¶œ</div></div>
            </div>
          </div>

          <!-- ì»¬ëŸ¼2: ë‹¨ê°€Â·íš¨ìœ¨ -->
          <div style="border-right:1px solid #1e2330;">
            <div style="padding:8px 14px;display:flex;align-items:center;gap:6px;border-bottom:1px solid #1e2330;background:#a78bfa07;">
              <span style="font-size:11px;">âš¡</span>
              <span style="font-size:10px;font-weight:800;color:#a78bfa;">ë‹¨ê°€ Â· íš¨ìœ¨</span>
              <span style="font-size:9px;color:#5a6080;">7ê°œ</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;padding:10px 12px 12px;">
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-cpm"  style="--accent:#a78bfa;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">CPM</div><div class="kpiv-value" id="kv-cpm">-</div></div><div class="kpiv-sub">1,000ë…¸ì¶œë‹¹ ë¹„ìš©</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-cpc"  style="--accent:#f472b6;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">CPC</div><div class="kpiv-value" id="kv-cpc">-</div></div><div class="kpiv-sub">í´ë¦­ë‹¹ ë¹„ìš©</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-ctr"  style="--accent:#38bdf8;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">CTR</div><div class="kpiv-value" id="kv-ctr">-</div></div><div class="kpiv-sub">ë…¸ì¶œ ëŒ€ë¹„ í´ë¦­</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-cac"  style="--accent:#34d399;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">CAC</div><div class="kpiv-value" id="kv-cac">-</div></div><div class="kpiv-sub">íšŒì›ê°€ì…ë‹¹ ë¹„ìš©</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-cpa"  style="--accent:#fbbf24;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">CPA</div><div class="kpiv-value" id="kv-cpa">-</div></div><div class="kpiv-sub">ìƒì„¸ì¡°íšŒë‹¹ ë¹„ìš©</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-cps"  style="--accent:#fb923c;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">CPS</div><div class="kpiv-value" id="kv-cps">-</div></div><div class="kpiv-sub">êµ¬ë§¤ì „í™˜ë‹¹ ë¹„ìš©</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-roas" style="--accent:#22d3ee;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ROAS</div><div class="kpiv-value" id="kv-roas">-</div></div><div class="kpiv-sub">ì „í™˜ë§¤ì¶œÃ·ë¹„ìš©</div></div>
            </div>
          </div>

          <!-- ì»¬ëŸ¼3: ì „í™˜ìœ¨ -->
          <div>
            <div style="padding:8px 14px;display:flex;align-items:center;gap:6px;border-bottom:1px solid #1e2330;background:#34d39907;">
              <span style="font-size:11px;">ğŸ”</span>
              <span style="font-size:10px;font-weight:800;color:#34d399;">ì „í™˜ìœ¨</span>
              <span style="font-size:9px;color:#5a6080;">5ê°œ</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;padding:10px 12px 12px;">
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-signup-cvr"      style="--accent:#6c63ff;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">í´ë¦­ â†’ ê°€ì…</div><div class="kpiv-value" id="kv-signup-cvr">-</div></div><div class="kpiv-sub">íšŒì›ê°€ì… ì „í™˜ìœ¨</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-purchase-cvr"    style="--accent:#34d399;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">í´ë¦­ â†’ êµ¬ë§¤</div><div class="kpiv-value" id="kv-purchase-cvr">-</div></div><div class="kpiv-sub">êµ¬ë§¤ ì „í™˜ìœ¨</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-post-signup-cvr" style="--accent:#f472b6;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ê°€ì… â†’ êµ¬ë§¤</div><div class="kpiv-value" id="kv-post-signup-cvr">-</div></div><div class="kpiv-sub">ê°€ì… í›„ êµ¬ë§¤ ì „í™˜</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-ad-spend-ratio"  style="--accent:#ef4444;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ê´‘ê³ ë¹„/ì´ë§¤ì¶œ</div><div class="kpiv-value" id="kv-ad-spend-ratio">-</div></div><div class="kpiv-sub">ê´‘ê³ ë¹„Ã·ì´ë§¤ì¶œ</div></div>
              <div class="kpi-card-v kpi-clickable" data-kpi="kv-ad-rev-ratio"    style="--accent:#a78bfa;"><div class="kpiv-bar"></div><div class="kpiv-info"><div class="kpiv-label">ê´‘ê³ ë§¤ì¶œ/ì´ë§¤ì¶œ</div><div class="kpiv-value" id="kv-ad-rev-ratio">-</div></div><div class="kpiv-sub">ì „í™˜ë§¤ì¶œÃ·ì´ë§¤ì¶œ</div></div>
            </div>
          </div>

        </div>
      </div>

      <!-- ì°¨íŠ¸ 1í–‰ -->
      <div class="chart-grid-3">
        <div class="chart-box">
          <div class="chart-title" id="ct-spend-rev">ë¹„ìš© vs ì „í™˜ë§¤ì¶œ</div>
          <div class="chart-inner"><canvas id="chart-spend-rev"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title" id="ct-roas">ROAS ì¶”ì´ â€” ì±„ë„ë³„</div>
          <div class="chart-inner"><canvas id="chart-roas"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title" id="ct-share">ì±„ë„ë³„ ë¹„ìš© ì ìœ ìœ¨</div>
          <div class="chart-inner"><canvas id="chart-share"></canvas></div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ 2í–‰ (ì±„ë„ ì „ì²´ì¼ ë•Œë§Œ í‘œì‹œ) -->
      <div class="chart-grid-2" id="chart-row-2">
        <div class="chart-box">
          <div class="chart-title" id="ct-ch-spend">ì±„ë„ë³„ ë¹„ìš© ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-ch-spend"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title" id="ct-ch-rev">ì±„ë„ë³„ ì „í™˜ë§¤ì¶œ ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-ch-rev"></canvas></div>
        </div>
      </div>

      <!-- ìƒì„¸ í…Œì´ë¸” -->
      <div class="table-section">
        <div class="table-title" id="table-title">ì±„ë„ë³„ ì„±ê³¼ ìƒì„¸</div>
        <div class="table-wrap">
          <table>
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </div>
      </main>
    </div>

    <!-- â”€â”€ TOTAL ì„œë¸Œíƒ­ â”€â”€ -->
    <div id="subtab-total" class="subtab-section" style="display:none;">
      <div class="sub-content">

        <!-- TOTAL ì»¨íŠ¸ë¡¤ë°” -->
        <div class="ctrl-bar" style="margin-bottom:12px;">
          <div style="font-size:10px;font-weight:700;color:#555b66;letter-spacing:1px;text-transform:uppercase;padding-bottom:2px;">
            ğŸ“Š TOTAL â€” í¼í¬ë¨¼ìŠ¤ + CRM í†µí•©
          </div>
          <div class="ctrl-group" style="margin-left:auto;">
            <label class="ctrl-label">ì§‘ê³„ ë‹¨ìœ„</label>
            <div class="gran-wrap">
              <button class="gran-btn" data-gran-total="daily">ì¼ë³„</button>
              <button class="gran-btn" data-gran-total="weekly">ì£¼ë³„</button>
              <button class="gran-btn active" data-gran-total="monthly">ì›”ë³„</button>
            </div>
          </div>
        </div>

        <!-- â‘  í”„ë¡œë•íŠ¸ ì§€í‘œ (ê³ ì • ë…¸ì¶œ â€” product_rawdata ì—°ë™) -->
        <div id="kpi-sec-product-total" style="border-radius:12px;border:1px solid #1e2330;overflow:hidden;background:#13151c;margin-bottom:10px;">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;
               background:linear-gradient(90deg,#fbbf2410 0%,transparent 50%);border-left:3px solid #fbbf24;">
            <div style="display:flex;align-items:center;gap:10px;">
              <span style="font-size:13px;">ğŸ¨</span>
              <span style="font-size:12px;font-weight:800;color:#dde1ef;">í”„ë¡œë•íŠ¸ ì§€í‘œ</span>
              <span style="font-size:9px;font-weight:700;color:#fbbf24;background:#fbbf2418;border:1px solid #fbbf2430;border-radius:4px;padding:1px 7px;">ê³ ì • í‘œì‹œ</span>
            </div>
          </div>
          <div style="display:flex;gap:8px;padding:10px 14px 14px;border-top:1px solid #1e2330;">
            <div class="kpi-card" style="--accent:#fbbf24;flex:1;"><div class="kpi-title">ì´ ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-total-revenue">-</span></div><div class="kpi-sub" id="tot-pkv-rev-sub">-</div></div>
            <div class="kpi-card" style="--accent:#34d399;flex:1;"><div class="kpi-title">ê²°ì œê±´ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-total-sales">-</span><span class="kpi-unit">ê±´</span></div><div class="kpi-sub" id="tot-pkv-sales-sub">-</div></div>
            <div class="kpi-card" style="--accent:#2dd4bf;flex:1;"><div class="kpi-title">ê²°ì œë°•ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-total-nights">-</span><span class="kpi-unit">ë°•</span></div></div>
            <div class="kpi-card" style="--accent:#a78bfa;flex:1;"><div class="kpi-title">ê°ë‹¨ê°€</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-aov">-</span></div><div class="kpi-sub">ì´ë§¤ì¶œÃ·ê²°ì œê±´ìˆ˜</div></div>
            <div class="kpi-card" style="--accent:#818cf8;flex:1;"><div class="kpi-title">ADR</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-adr">-</span></div><div class="kpi-sub">ì´ë§¤ì¶œÃ·ê²°ì œë°•ìˆ˜</div></div>
            <div class="kpi-card" style="--accent:#38bdf8;flex:1;"><div class="kpi-title">LOS</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-los">-</span><span class="kpi-unit">ë°•</span></div></div>
            <div class="kpi-card" style="--accent:#f472b6;flex:1;"><div class="kpi-title">ë¦¬ë“œíƒ€ì„</div><div class="kpi-value-row"><span class="kpi-value" id="tot-pkv-leadtime">-</span><span class="kpi-unit">ì¼</span></div></div>
          </div>
        </div>

        <!-- â‘¡ í†µí•© ì„±ê³¼ ìš”ì•½ KPI -->
        <div class="kpi-section" style="margin-top:4px;">
          <div class="kpi-section-label" style="color:#f472b6;">í†µí•© ì„±ê³¼ ìš”ì•½</div>
          <div class="kpi-grid-5">
            <div class="kpi-card" style="--accent:#ef4444"><div class="kpi-title">ì´ ë¹„ìš©</div><div class="kpi-value-row"><span class="kpi-value" id="tot-spend">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub" id="tot-spend-sub">í¼í¬ë¨¼ìŠ¤ + CRM</div></div>
            <div class="kpi-card" style="--accent:#6c63ff"><div class="kpi-title">ì´ ì „í™˜ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="tot-rev">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub" id="tot-rev-sub">í¼í¬ë¨¼ìŠ¤ + CRM</div></div>
            <div class="kpi-card" style="--accent:#38bdf8"><div class="kpi-title">ì´ ì „í™˜</div><div class="kpi-value-row"><span class="kpi-value" id="tot-conv">-</span><span class="kpi-unit">ê±´</span></div><div class="kpi-sub" id="tot-conv-sub">í¼í¬ë¨¼ìŠ¤ + CRM</div></div>
            <div class="kpi-card" style="--accent:#f472b6"><div class="kpi-title">í†µí•© ROAS</div><div class="kpi-value-row"><span class="kpi-value" id="tot-roas">-</span><span class="kpi-unit">%</span></div><div class="kpi-sub">ì „í™˜ë§¤ì¶œ Ã· ë¹„ìš©</div></div>
            <div class="kpi-card" style="--accent:#fbbf24"><div class="kpi-title">í†µí•© CPA</div><div class="kpi-value-row"><span class="kpi-value" id="tot-cpa">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub">ë¹„ìš© Ã· ì „í™˜</div></div>
          </div>
        </div>

        <!-- â‘¢ CRM ì±„ë„ë³„ ì„±ê³¼ KPI (ë¯¸ë‹ˆ ëª¨ë‹¬ ì§€ì›) -->
        <div class="kpi-section">
          <div class="kpi-section-label" style="color:#34d399;">ğŸ’¬ CRM ì±„ë„ë³„ ì„±ê³¼</div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
            <div class="kpi-card kpi-clickable" data-crm-kpi="sent"        style="--accent:#6c63ff;position:relative;"><div class="kpi-title">ì´ ë°œì†¡</div><div class="kpi-value-row"><span class="kpi-value" id="tot-crm-sent">-</span><span class="kpi-unit">ê±´</span></div></div>
            <div class="kpi-card kpi-clickable" data-crm-kpi="opened"      style="--accent:#38bdf8;position:relative;"><div class="kpi-title">ì—´ëŒìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="tot-crm-opened">-</span></div><div class="kpi-sub" id="tot-crm-open-rate">ì—´ëŒìœ¨ -</div></div>
            <div class="kpi-card kpi-clickable" data-crm-kpi="clicked"     style="--accent:#34d399;position:relative;"><div class="kpi-title">í´ë¦­ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="tot-crm-clicked">-</span></div><div class="kpi-sub" id="tot-crm-click-rate">í´ë¦­ìœ¨ -</div></div>
            <div class="kpi-card kpi-clickable" data-crm-kpi="converted"   style="--accent:#fbbf24;position:relative;"><div class="kpi-title">ì „í™˜ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="tot-crm-converted">-</span></div><div class="kpi-sub" id="tot-crm-conv-rate">ì „í™˜ìœ¨ -</div></div>
            <div class="kpi-card kpi-clickable" data-crm-kpi="revenue"     style="--accent:#f472b6;position:relative;"><div class="kpi-title">CRM ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="tot-crm-revenue">-</span><span class="kpi-unit">ì›</span></div></div>
          </div>
        </div>

        <!-- â‘£ ì±„ë„ ìœ í˜•ë³„ ë¹„ì¤‘ -->
        <div class="kpi-section">
          <div class="kpi-section-label" style="color:#34d399;">ì±„ë„ ìœ í˜•ë³„ ë¹„ì¤‘</div>
          <div class="kpi-grid-4">
            <div class="kpi-card" style="--accent:#6c63ff"><div class="kpi-title">í¼í¬ë¨¼ìŠ¤ ë¹„ìš©</div><div class="kpi-value-row"><span class="kpi-value" id="tot-p-spend">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub" id="tot-p-spend-share">ì „ì²´ ë¹„ìš©ì˜ -</div></div>
            <div class="kpi-card" style="--accent:#34d399"><div class="kpi-title">CRM ë¹„ìš©</div><div class="kpi-value-row"><span class="kpi-value" id="tot-c-spend">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub" id="tot-c-spend-share">ì „ì²´ ë¹„ìš©ì˜ -</div></div>
            <div class="kpi-card" style="--accent:#a78bfa"><div class="kpi-title">í¼í¬ë¨¼ìŠ¤ ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="tot-p-rev">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub" id="tot-p-rev-share">ì „ì²´ ë§¤ì¶œì˜ -</div></div>
            <div class="kpi-card" style="--accent:#38bdf8"><div class="kpi-title">CRM ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="tot-c-rev">-</span><span class="kpi-unit">ì›</span></div><div class="kpi-sub" id="tot-c-rev-share">ì „ì²´ ë§¤ì¶œì˜ -</div></div>
          </div>
        </div>

        <!-- TOTAL ì°¨íŠ¸ -->
        <div class="chart-grid-3" style="margin-top:8px;">
          <div class="chart-box">
            <div class="chart-title">ë¹„ìš© ë¹„ì¤‘ â€” í¼í¬ë¨¼ìŠ¤ vs CRM</div>
            <div class="chart-inner"><canvas id="chart-tot-spend-share"></canvas></div>
          </div>
          <div class="chart-box">
            <div class="chart-title">ì „í™˜ë§¤ì¶œ ë¹„ì¤‘ â€” í¼í¬ë¨¼ìŠ¤ vs CRM</div>
            <div class="chart-inner"><canvas id="chart-tot-rev-share"></canvas></div>
          </div>
          <div class="chart-box">
            <div class="chart-title" id="ct-tot-roas">í†µí•© ROAS ì¶”ì´</div>
            <div class="chart-inner"><canvas id="chart-tot-roas"></canvas></div>
          </div>
        </div>

        <div class="chart-grid-2">
          <div class="chart-box">
            <div class="chart-title" id="ct-tot-spend-stack">ë¹„ìš© ì¶”ì´ (í¼í¬ë¨¼ìŠ¤ vs CRM)</div>
            <div class="chart-inner-lg"><canvas id="chart-tot-spend-stack"></canvas></div>
          </div>
          <div class="chart-box">
            <div class="chart-title" id="ct-tot-rev-stack">ì „í™˜ë§¤ì¶œ ì¶”ì´ (í¼í¬ë¨¼ìŠ¤ vs CRM)</div>
            <div class="chart-inner-lg"><canvas id="chart-tot-rev-stack"></canvas></div>
          </div>
        </div>

        <!-- TOTAL ì±„ë„ë³„ í…Œì´ë¸” -->
        <div class="table-section">
          <div class="table-title">ì „ì²´ ì±„ë„ë³„ ì„±ê³¼ (í¼í¬ë¨¼ìŠ¤ + CRM)</div>
          <div class="table-wrap">
            <table>
              <thead id="tot-table-head"></thead>
              <tbody id="tot-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ CRM ì„œë¸Œíƒ­ â”€â”€ -->
    <div id="subtab-crm" class="subtab-section" style="display:none;">
      <div class="sub-content">

        <!-- CRM ì»¨íŠ¸ë¡¤ë°” (í¼í¬ë¨¼ìŠ¤ì™€ ë™ì¼ ì–‘ì‹) -->
        <div class="ctrl-bar">
          <div class="ctrl-group">
            <label class="ctrl-label">ì‹œì‘ì¼</label>
            <input type="date" id="crm-date-from">
          </div>
          <div class="date-sep">â€”</div>
          <div class="ctrl-group">
            <label class="ctrl-label">ì¢…ë£Œì¼</label>
            <input type="date" id="crm-date-to">
          </div>
          <div class="ctrl-group">
            <label class="ctrl-label">ì§‘ê³„ ë‹¨ìœ„</label>
            <div class="gran-wrap">
              <button class="gran-btn" data-gran-crm="daily">ì¼ë³„</button>
              <button class="gran-btn" data-gran-crm="weekly">ì£¼ë³„</button>
              <button class="gran-btn active" data-gran-crm="monthly">ì›”ë³„</button>
            </div>
          </div>
          <div class="ctrl-group">
            <label class="ctrl-label">ì±„ë„</label>
            <select id="crm-sel-channel">
              <option value="ì „ì²´">ì „ì²´</option>
            </select>
          </div>
        </div>

        <!-- í”„ë¡œë•íŠ¸ ì§€í‘œ ê³ ì • ë…¸ì¶œ í–‰ -->
        <div id="kpi-sec-product-crm" style="border-radius:12px;border:1px solid #1e2330;overflow:hidden;background:#13151c;margin-bottom:10px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px 16px;
               background:linear-gradient(90deg,#fbbf2410 0%,transparent 60%);border-left:3px solid #fbbf24;">
            <span style="font-size:12px;">ğŸ¨</span>
            <span style="font-size:11px;font-weight:800;color:#dde1ef;">í”„ë¡œë•íŠ¸ ì§€í‘œ</span>
            <span style="font-size:9px;font-weight:700;color:#fbbf24;background:#fbbf2418;border:1px solid #fbbf2430;border-radius:4px;padding:1px 7px;">ê³ ì • í‘œì‹œ</span>
          </div>
          <div style="display:flex;gap:8px;padding:10px 14px 14px;border-top:1px solid #1e2330;">
            <div class="kpi-card" style="--accent:#fbbf24;flex:1;"><div class="kpi-title">ì´ ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-revenue">-</span></div><div class="kpi-sub" id="crm-pkv-rev-sub">-</div></div>
            <div class="kpi-card" style="--accent:#34d399;flex:1;"><div class="kpi-title">ê²°ì œê±´ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-sales">-</span><span class="kpi-unit">ê±´</span></div></div>
            <div class="kpi-card" style="--accent:#2dd4bf;flex:1;"><div class="kpi-title">ê²°ì œë°•ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-nights">-</span><span class="kpi-unit">ë°•</span></div></div>
            <div class="kpi-card" style="--accent:#a78bfa;flex:1;"><div class="kpi-title">ê°ë‹¨ê°€</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-aov">-</span></div><div class="kpi-sub">ì´ë§¤ì¶œÃ·ê±´ìˆ˜</div></div>
            <div class="kpi-card" style="--accent:#818cf8;flex:1;"><div class="kpi-title">ADR</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-adr">-</span></div></div>
            <div class="kpi-card" style="--accent:#38bdf8;flex:1;"><div class="kpi-title">LOS</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-los">-</span><span class="kpi-unit">ë°•</span></div></div>
            <div class="kpi-card" style="--accent:#f472b6;flex:1;"><div class="kpi-title">ë¦¬ë“œíƒ€ì„</div><div class="kpi-value-row"><span class="kpi-value" id="crm-pkv-leadtime">-</span><span class="kpi-unit">ì¼</span></div></div>
          </div>
        </div>

        <!-- CRM KPI -->
        <div class="kpi-section">
          <div class="kpi-section-label" style="color:#34d399;">CRM í•µì‹¬ ì§€í‘œ</div>
          <div class="kpi-grid-5" style="margin-bottom:8px;">
            <div class="kpi-card" style="--accent:#6c63ff"><div class="kpi-title">ì´ ë°œì†¡</div><div class="kpi-value-row"><span class="kpi-value" id="crm-sent">-</span><span class="kpi-unit">ê±´</span></div><div class="kpi-sub" id="crm-sent-sub">-</div></div>
            <div class="kpi-card" style="--accent:#38bdf8"><div class="kpi-title">ì—´ëŒìœ¨</div><div class="kpi-value-row"><span class="kpi-value" id="crm-open-rate">-</span><span class="kpi-unit">%</span></div><div class="kpi-sub" id="crm-opened-count">-ê±´ ì—´ëŒ</div></div>
            <div class="kpi-card" style="--accent:#34d399"><div class="kpi-title">í´ë¦­ìœ¨</div><div class="kpi-value-row"><span class="kpi-value" id="crm-click-rate">-</span><span class="kpi-unit">%</span></div><div class="kpi-sub" id="crm-clicked-count">-ê±´ í´ë¦­</div></div>
            <div class="kpi-card" style="--accent:#fbbf24"><div class="kpi-title">ì „í™˜ìœ¨</div><div class="kpi-value-row"><span class="kpi-value" id="crm-conv-rate">-</span><span class="kpi-unit">%</span></div><div class="kpi-sub" id="crm-conv-count">-ê±´ ì „í™˜</div></div>
            <div class="kpi-card" style="--accent:#a78bfa"><div class="kpi-title">CRM ROAS</div><div class="kpi-value-row"><span class="kpi-value" id="crm-roas">-</span><span class="kpi-unit">%</span></div><div class="kpi-sub">ì „í™˜ë§¤ì¶œ Ã· ë¹„ìš©</div></div>
          </div>
          <div class="kpi-grid-5">
            <div class="kpi-card" style="--accent:#2dd4bf"><div class="kpi-title">ì„¤ì¹˜ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="crm-installs">-</span><span class="kpi-unit">ê±´</span></div><div class="kpi-sub" id="crm-install-rate">ì„¤ì¹˜ìœ¨ -</div></div>
            <div class="kpi-card" style="--accent:#818cf8"><div class="kpi-title">ìƒì„¸í˜ì´ì§€ ì¡°íšŒ</div><div class="kpi-value-row"><span class="kpi-value" id="crm-detail-views">-</span><span class="kpi-unit">íšŒ</span></div><div class="kpi-sub" id="crm-detail-rate">ì¡°íšŒìœ¨ -</div></div>
            <div class="kpi-card" style="--accent:#fb923c"><div class="kpi-title">íšŒì›ê°€ì…ìˆ˜</div><div class="kpi-value-row"><span class="kpi-value" id="crm-signups">-</span><span class="kpi-unit">ëª…</span></div><div class="kpi-sub" id="crm-signup-rate">ê°€ì…ìœ¨ -</div></div>
            <div class="kpi-card" style="--accent:#f472b6"><div class="kpi-title">ì „í™˜ ë§¤ì¶œ</div><div class="kpi-value-row"><span class="kpi-value" id="crm-revenue">-</span><span class="kpi-unit">ì›</span></div></div>
            <div class="kpi-card" style="--accent:#ef4444"><div class="kpi-title">CRM ë¹„ìš©</div><div class="kpi-value-row"><span class="kpi-value" id="crm-spend">-</span><span class="kpi-unit">ì›</span></div></div>
          </div>
        </div>

        <!-- CRM ì°¨íŠ¸ -->
        <div class="chart-grid-3">
          <div class="chart-box" id="crm-funnel-box">
            <div class="chart-title">ì „í™˜ í¼ë„</div>
            <div id="crm-funnel-wrap" style="padding:8px 0;"></div>
          </div>
          <div class="chart-box">
            <div class="chart-title" id="ct-crm-rev">CRM ë§¤ì¶œ ì¶”ì´</div>
            <div class="chart-inner"><canvas id="chart-crm-rev"></canvas></div>
          </div>
          <div class="chart-box">
            <div class="chart-title">ì±„ë„ë³„ ë§¤ì¶œ ì ìœ ìœ¨</div>
            <div class="chart-inner"><canvas id="chart-crm-share"></canvas></div>
          </div>
        </div>

        <!-- CRM ì±„ë„ í…Œì´ë¸” -->
        <div class="table-section">
          <div class="table-title">ì±„ë„ë³„ CRM ìƒì„¸ ì„±ê³¼</div>
          <div class="table-wrap">
            <table>
              <thead id="crm-table-head"></thead>
              <tbody id="crm-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /tab-marketing -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í”„ë¡œë•íŠ¸ íƒ­ (í˜¸í…” ìš´ì˜ ë¶„ì„)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-product" class="tab-section" style="display:block;">
    <div class="sub-content">

      <!-- í”„ë¡œë•íŠ¸ ì»¨íŠ¸ë¡¤ë°” -->
      <div class="ctrl-bar">
        <div class="ctrl-group">
          <label class="ctrl-label">ì‹œì‘ì¼</label>
          <input type="date" id="prod-date-from">
        </div>
        <div class="date-sep">â€”</div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì¢…ë£Œì¼</label>
          <input type="date" id="prod-date-to">
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì§‘ê³„ ë‹¨ìœ„</label>
          <div class="gran-wrap">
            <button class="gran-btn" data-gran-prod="daily">ì¼ë³„</button>
            <button class="gran-btn" data-gran-prod="weekly">ì£¼ë³„</button>
            <button class="gran-btn active" data-gran-prod="monthly">ì›”ë³„</button>
          </div>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì§€ì—­</label>
          <select id="prod-sel-region"><option value="ì „ì²´">ì „ì²´</option></select>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ì§€ì </label>
          <select id="prod-sel-branch" disabled><option value="ì „ì²´">ì „ì²´</option></select>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ë¸Œëœë“œ</label>
          <select id="prod-sel-brand"><option value="ì „ì²´">ì „ì²´</option></select>
        </div>
        <div class="ctrl-group">
          <label class="ctrl-label">ê°ì‹¤íƒ€ì…</label>
          <select id="prod-sel-room"><option value="ì „ì²´">ì „ì²´</option></select>
        </div>
        <div class="ctrl-group" style="margin-left:auto;">
          <label class="ctrl-label">ë°ì´í„° ìƒíƒœ</label>
          <span id="hotel-status" style="font-size:11px;color:#555b66;">hotel_rawdata ë¡œë“œ ëŒ€ê¸°ì¤‘</span>
        </div>
      </div>

      <!-- KPI ì„¹ì…˜ 1: ì˜ˆì•½ í•µì‹¬ ì§€í‘œ -->
      <div class="kpi-section">
        <div class="kpi-section-label" style="color:#fbbf24;">ì˜ˆì•½ í•µì‹¬ ì§€í‘œ</div>
        <div class="kpi-grid-5">
          <div class="kpi-card" style="--accent:#6c63ff">
            <div class="kpi-title">ì´ ë§¤ì¶œ</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-revenue">-</span><span class="kpi-unit">ì›</span></div>
            <div class="kpi-sub" id="hkv-revenue-sub">ê¸°ê°„ í•©ê³„</div>
          </div>
          <div class="kpi-card" style="--accent:#38bdf8">
            <div class="kpi-title">ì˜ˆì•½ ê±´ìˆ˜</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-bookings">-</span><span class="kpi-unit">ê±´</span></div>
            <div class="kpi-sub" id="hkv-bookings-sub">ê¸°ê°„ í•©ê³„</div>
          </div>
          <div class="kpi-card" style="--accent:#34d399">
            <div class="kpi-title">ì˜ˆì•½ ë°•ìˆ˜</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-nights">-</span><span class="kpi-unit">ë°•</span></div>
            <div class="kpi-sub" id="hkv-nights-sub">ê¸°ê°„ í•©ê³„</div>
          </div>
          <div class="kpi-card" style="--accent:#fbbf24">
            <div class="kpi-title">í‰ê·  ë¦¬ë“œíƒ€ì„</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-leadtime">-</span><span class="kpi-unit">ì¼</span></div>
            <div class="kpi-sub">ì²´í¬ì¸ì¼ âˆ’ ì˜ˆì•½ì¼</div>
          </div>
          <div class="kpi-card" style="--accent:#f472b6">
            <div class="kpi-title">ê°ë‹¨ê°€</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-aov">-</span><span class="kpi-unit">ì›</span></div>
            <div class="kpi-sub">ë§¤ì¶œ Ã· ê±´ìˆ˜</div>
          </div>
        </div>
      </div>

      <!-- KPI ì„¹ì…˜ 2: ìš´ì˜ íš¨ìœ¨ ì§€í‘œ -->
      <div class="kpi-section">
        <div class="kpi-section-label" style="color:#22d3ee;">ìš´ì˜ íš¨ìœ¨ ì§€í‘œ</div>
        <div class="kpi-grid-5">
          <div class="kpi-card" style="--accent:#a78bfa">
            <div class="kpi-title">ADR</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-adr">-</span><span class="kpi-unit">ì›</span></div>
            <div class="kpi-sub">ë§¤ì¶œ Ã· ë°•ìˆ˜</div>
          </div>
          <div class="kpi-card" style="--accent:#2dd4bf">
            <div class="kpi-title">LOS</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-los">-</span><span class="kpi-unit">ë°•</span></div>
            <div class="kpi-sub">ë°•ìˆ˜ Ã· ê±´ìˆ˜</div>
          </div>
          <div class="kpi-card" style="--accent:#22c55e">
            <div class="kpi-title">OCC (ê°€ë™ë¥ )</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-occ">-</span><span class="kpi-unit">%</span></div>
            <div class="kpi-sub" id="hkv-occ-sub">íŒë§¤ / ê°€ìš©ê°ì‹¤</div>
          </div>
          <div class="kpi-card" style="--accent:#818cf8">
            <div class="kpi-title">RevPAR</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-revpar">-</span><span class="kpi-unit">ì›</span></div>
            <div class="kpi-sub">ë§¤ì¶œ Ã· ê°€ìš©ê°ì‹¤ìˆ˜</div>
          </div>
          <div class="kpi-card" style="--accent:#ef4444">
            <div class="kpi-title">ì·¨ì†Œìœ¨</div>
            <div class="kpi-value-row"><span class="kpi-value" id="hkv-cancel">-</span><span class="kpi-unit">%</span></div>
            <div class="kpi-sub" id="hkv-cancel-sub">-ê±´ ì·¨ì†Œ</div>
          </div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ Row 1: ë§¤ì¶œì¶”ì´ + ì‹œì¦Œ -->
      <div class="chart-grid-2">
        <div class="chart-box">
          <div class="chart-title" id="ct-hotel-ts">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-hotel-ts"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title">ì‹œì¦Œë³„ ë§¤ì¶œ ë¹„êµ
            <span style="font-size:10px;color:#555b66;font-weight:400;margin-left:6px;">ë´„ 3~5ì›” Â· ì—¬ë¦„ 6~8ì›” Â· ê°€ì„ 9~11ì›” Â· ê²¨ìš¸ 12~2ì›”</span>
          </div>
          <div class="chart-inner-lg"><canvas id="chart-hotel-season"></canvas></div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ Row 2: 3ê°œ íŒŒì´ -->
      <div class="chart-grid-3">
        <div class="chart-box">
          <div class="chart-title">ì§€ì—­ë³„ ë§¤ì¶œ ì ìœ ìœ¨</div>
          <div class="chart-inner"><canvas id="chart-hotel-pie-region"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title">ë¸Œëœë“œë³„ ë§¤ì¶œ ì ìœ ìœ¨</div>
          <div class="chart-inner"><canvas id="chart-hotel-pie-brand"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title">ê°ì‹¤íƒ€ì…ë³„ ë§¤ì¶œ ì ìœ ìœ¨</div>
          <div class="chart-inner"><canvas id="chart-hotel-pie-room"></canvas></div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ Row 3: ì§€ì—­â†’ì§€ì  / ì§€ì â†’ê°ì‹¤ ìŠ¤íƒë“œ ìˆ˜í‰ë°” -->
      <div class="chart-grid-2">
        <div class="chart-box">
          <div class="chart-title">ì§€ì—­ë³„ â†’ ì§€ì ë³„ ë§¤ì¶œ ì ìœ ìœ¨</div>
          <div style="height:220px;position:relative;"><canvas id="chart-hotel-region-branch"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title">ì§€ì ë³„ â†’ ê°ì‹¤íƒ€ì…ë³„ ë§¤ì¶œ ì ìœ ìœ¨</div>
          <div style="height:300px;position:relative;"><canvas id="chart-hotel-branch-room"></canvas></div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ Row 4: ì§€ì—­ë³„ ì‹œê³„ì—´ -->
      <div class="chart-grid-2">
        <div class="chart-box">
          <div class="chart-title" id="ct-hotel-region-aov">ì§€ì—­ë³„ ê°ë‹¨ê°€ ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-hotel-region-aov"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title" id="ct-hotel-region-adr">ì§€ì—­ë³„ ADR ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-hotel-region-adr"></canvas></div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ Row 5: ì§€ì ë³„ ì‹œê³„ì—´ -->
      <div class="chart-grid-2">
        <div class="chart-box">
          <div class="chart-title" id="ct-hotel-branch-aov">ì§€ì ë³„ ê°ë‹¨ê°€ ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-hotel-branch-aov"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-title" id="ct-hotel-branch-adr">ì§€ì ë³„ ADR ì¶”ì´</div>
          <div class="chart-inner-lg"><canvas id="chart-hotel-branch-adr"></canvas></div>
        </div>
      </div>

      <!-- ì§€ì ë³„ ì„±ê³¼ ë­í‚¹ í…Œì´ë¸” -->
      <div class="table-section">
        <div class="table-title">ì§€ì ë³„ ì„±ê³¼ ë­í‚¹</div>
        <div class="table-wrap">
          <table>
            <thead id="hotel-branch-rank-head"></thead>
            <tbody id="hotel-branch-rank-body"></tbody>
          </table>
        </div>
      </div>

      <!-- ì‹œì¦Œë³„ + ê¸°ê°„ë³„ ìƒì„¸ í…Œì´ë¸” (2ì—´) -->
      <div class="chart-grid-2" style="margin-top:0;">
        <div class="table-section">
          <div class="table-title">ì‹œì¦Œë³„ ìƒì„¸</div>
          <div class="table-wrap">
            <table>
              <thead><tr>
                <th>ì‹œì¦Œ</th><th class="r">ë§¤ì¶œ</th><th class="r">ê±´ìˆ˜</th>
                <th class="r">ê°ë‹¨ê°€</th><th class="r">ADR</th><th class="r">LOS</th>
              </tr></thead>
              <tbody id="hotel-season-body"></tbody>
            </table>
          </div>
        </div>
        <div class="table-section">
          <div class="table-title" id="hotel-period-title">ê¸°ê°„ë³„ ìƒì„¸</div>
          <div class="table-wrap" style="max-height:360px;">
            <table>
              <thead id="hotel-period-head"></thead>
              <tbody id="hotel-period-body"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div><!-- /tab-product -->

</div><!-- /app -->

<script>
/* ================================================================
   ìƒìˆ˜ & ì „ì—­ ìƒíƒœ
================================================================ */
const COLORS = ['#6c63ff','#38bdf8','#34d399','#fbbf24','#f472b6','#a78bfa','#2dd4bf','#ef4444','#fb923c','#818cf8'];

// â”€â”€ ì±„ë„ë³„ ê³ ì • ìƒ‰ìƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì°¨íŠ¸ ì „ì²´ì—ì„œ ê°™ì€ ì±„ë„ì€ í•­ìƒ ê°™ì€ ìƒ‰ ì‚¬ìš© (ì¸ë±ìŠ¤ ê¸°ë°˜ X)
const CHANNEL_COLORS = {
  'facebook.business': '#38bdf8',   // í•˜ëŠ˜ìƒ‰
  'google.adwords':    '#ef4444',   // ë¶‰ì€ìƒ‰
  'naver.ë¸Œëœë“œê²€ìƒ‰':  '#16a34a',   // ì§™ì€ ë…¹ìƒ‰
  'naver.íŒŒì›Œë§í¬':    '#a3e635',   // í˜•ê´‘ ì—°ë‘ìƒ‰
};
// ì •ì˜ë˜ì§€ ì•Šì€ ì±„ë„ì€ COLORS íŒ”ë ˆíŠ¸ì—ì„œ ìˆœì„œëŒ€ë¡œ fallback
function chColor(ch, fallbackIdx) {
  return CHANNEL_COLORS[ch] || COLORS[fallbackIdx % COLORS.length];
}
const CHART_DEFAULTS = {
  color: '#6c7280',
  grid:  '#2a2d35',
  tooltip: {
    backgroundColor:'#1e2128', borderColor:'#2a2d35', borderWidth:1,
    titleColor:'#8a8f98', bodyColor:'#e1e4ea', padding:10,
    // ê°™ì€ xì¶• í¬ì¸íŠ¸ì˜ ëª¨ë“  ë°ì´í„°ì…‹ í•œêº¼ë²ˆì— í‘œì‹œ
    mode:'index', intersect:false
  }
};

// í˜„ì¬ ìƒíƒœ
let RAW_DATA   = [];   // perf_raw ì „ì²´ ë°ì´í„° (ê°ì²´ ë°°ì—´)
let CHANNELS   = [];   // ì±„ë„ ëª©ë¡
let CAMP_MAP   = {};   // { ì±„ë„ëª…: [ìº í˜ì¸ëª…, ...] }
let GRAN       = 'monthly';
let DATE_FROM  = '';
let DATE_TO    = '';

// Chart.js ì¸ìŠ¤í„´ìŠ¤ (ì¬ë Œë” ì‹œ destroy í•„ìš”)
const charts   = {};

// â”€â”€ ëª©í‘œ ì„¤ì • state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let GOAL_ON         = false;   // ëª©í‘œì„¤ì • í™œì„± ì—¬ë¶€
let INSIGHT_GOAL_ON = false;   // ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ ëª©í‘œ ëŒ€ë¹„ í‘œì‹œ ì—¬ë¶€
let GOALS = {
  from: '', to: '',
  totalRevenue: 0, totalSales: 0,
  adSpend: 0, roas: 0, convRevenue: 0,
};
const GOAL_STORAGE_KEY = 'perf_goals_v1';

function saveGoals() {
  try { localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify({ GOALS, GOAL_ON, INSIGHT_GOAL_ON })); } catch(e) {}
}
function loadGoals() {
  try {
    const s = localStorage.getItem(GOAL_STORAGE_KEY);
    if (!s) return;
    const p = JSON.parse(s);
    GOALS           = { ...GOALS, ...p.GOALS };
    GOAL_ON         = !!p.GOAL_ON;
    INSIGHT_GOAL_ON = !!p.INSIGHT_GOAL_ON;
  } catch(e) {}
}

// â”€â”€ í”„ë¡œë•íŠ¸ ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let PRODUCT_DATA = [];  // [{date, totalSales, totalNights, totalRevenue, aov,
                        //   appRevenue, appSales, appNights,
                        //   webRevenue, webSales, webNights,
                        //   couponDiscount, pointDiscount, discountRate}]

// â”€â”€ í˜¸í…” ìš´ì˜ ë°ì´í„° (hotel_rawdata) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// date | region | branch | brand | room_type | revenue |
// bookings | nights | lead_time | cancellations | sold_rooms | available_rooms
let HOTEL_DATA        = [];
let HOTEL_REGIONS     = [];
let HOTEL_BRANCHES_MAP = {};  // { ì§€ì—­: [ì§€ì , ...] }
let HOTEL_BRANDS      = [];
let HOTEL_ROOMS       = [];
const HOTEL_COLORS = ['#6c63ff','#38bdf8','#34d399','#fbbf24','#f472b6',
                       '#a78bfa','#2dd4bf','#ef4444','#fb923c','#818cf8','#22d3ee'];
const SEASONS_MAP = {
  '01':'ê²¨ìš¸','02':'ê²¨ìš¸','03':'ë´„','04':'ë´„','05':'ë´„',
  '06':'ì—¬ë¦„','07':'ì—¬ë¦„','08':'ì—¬ë¦„','09':'ê°€ì„','10':'ê°€ì„','11':'ê°€ì„','12':'ê²¨ìš¸'
};
const SEASON_ORDER      = ['ë´„','ì—¬ë¦„','ê°€ì„','ê²¨ìš¸'];
const SEASON_COLORS_MAP = { ë´„:'#34d399', ì—¬ë¦„:'#38bdf8', ê°€ì„:'#fbbf24', ê²¨ìš¸:'#a78bfa' };
const SEASON_LABELS_MAP = {
  ë´„:'ë´„ (3~5ì›”)', ì—¬ë¦„:'ì—¬ë¦„ (6~8ì›”)', ê°€ì„:'ê°€ì„ (9~11ì›”)', ê²¨ìš¸:'ê²¨ìš¸ (12~2ì›”)'
};

function getOccColor(v) {
  const n = parseFloat(v);
  if (n >= 85) return '#22c55e';
  if (n >= 70) return '#84cc16';
  if (n >= 55) return '#fbbf24';
  if (n >= 40) return '#f97316';
  return '#ef4444';
}

// â”€â”€ CRM ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let CRM_DATA    = [];
let CRM_CHANS   = [];  // CRM ì±„ë„ ëª©ë¡

// â”€â”€ íƒ­ / ì„œë¸Œíƒ­ / ì±„ë„ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ACTIVE_TAB    = 'product';   // 'product' | 'marketing'
let MKT_SUB       = 'total';     // 'total' | 'perf' | 'crm'
let PERF_CHAN      = 'ì „ì²´';      // í¼í¬ë¨¼ìŠ¤ 3ë‹¨ê³„ ì±„ë„ í•„í„° (meta/google/kakao/...)
let CRM_CHAN       = 'ì „ì²´';      // CRM 3ë‹¨ê³„ ì±„ë„ í•„í„°
let PERF_CHANNELS  = [];         // í¼í¬ë¨¼ìŠ¤ ì±„ë„ ëª©ë¡ (ë°ì´í„°ì—ì„œ ë™ì  ì¶”ì¶œ)
let CRM_CHANNELS   = [];         // CRM ì±„ë„ ëª©ë¡
let GRAN_TOTAL  = 'monthly';
let GRAN_CRM    = 'monthly';
let GRAN_PROD   = 'monthly';

// ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ (destroy í›„ ì¬ìƒì„±)
const CHARTS = {};

// â”€â”€ ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© ì˜¤ë²„ë ˆì´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [{id, from, to, totalCost}] í˜•íƒœ. localStorageë¡œ ì„¸ì…˜ ê°„ ìœ ì§€.
let BRAND_COSTS = [];
const BC_STORAGE_KEY = 'perf_brand_costs_v1';

function loadBrandCosts() {
  try {
    const raw = localStorage.getItem(BC_STORAGE_KEY);
    if (raw) BRAND_COSTS = JSON.parse(raw);
  } catch(e) { BRAND_COSTS = []; }
}

function saveBrandCosts() {
  try { localStorage.setItem(BC_STORAGE_KEY, JSON.stringify(BRAND_COSTS)); } catch(e) {}
}

/* íŠ¹ì • ë‚ ì§œ + ìº í˜ì¸ì˜ ë¸Œëœë“œê²€ìƒ‰ ì¼ë³„ ë¹„ìš© ë°˜í™˜ (ê¸°ê°„ ë‚´ ê· ë“± ë°°ë¶„)
   campaign: RAW_DATAì˜ d.campaign ê°’ â€” bc.campaignì´ í¬í•¨ í…ìŠ¤íŠ¸ë¡œ ë§¤ì¹­ */
function getBrandDailySpend(date, campaign) {
  return BRAND_COSTS.reduce((sum, bc) => {
    // ìº í˜ì¸ëª…: bc.campaignì´ d.campaignì— í¬í•¨ë˜ë©´ ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
    const campMatch = campaign.toLowerCase().includes(bc.campaign.toLowerCase());
    if (campMatch && date >= bc.from && date <= bc.to) {
      const days = Math.round((new Date(bc.to) - new Date(bc.from)) / 86400000) + 1;
      sum += bc.totalCost / days;
    }
    return sum;
  }, 0);
}

/* ================================================================
   ìœ í‹¸ í•¨ìˆ˜
================================================================ */
const fo = v => Math.round(Number(v||0)).toLocaleString(); // ì†Œìˆ˜ì  ì œê±°
const pct = (a, b) => b ? ((a/b)*100).toFixed(2) : '0';
const pct0 = (a, b) => b ? ((a/b)*100).toFixed(0) : '0';

function periodKey(dateStr, gran) {
  if (gran === 'daily')   return dateStr;
  if (gran === 'monthly') return dateStr.slice(0, 7);
  // weekly: ISO year-week
  const d = new Date(dateStr);
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const week = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2,'0')}`;
}

function periodLabel(key, gran) {
  if (gran === 'daily')   return key.slice(5);
  if (gran === 'monthly') return key.slice(5) + 'ì›”';
  return key.replace(/^\d{4}-W/, '') + 'ì£¼ì°¨';
}
// renderTotal / renderCrm ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³„ì¹­ (ë™ì¼ í•¨ìˆ˜)
const buildPeriodKey   = periodKey;
const buildPeriodLabel = periodLabel;

/* ================================================================
   ë°ì´í„° ë¡œë“œ (Apps Script í˜¸ì¶œ)
================================================================ */

function onDataLoaded(result) {
  try {
    if (result.error) { onDataError(result.error); return; }

    const h = result.headers;
    const idx = {
      date:         h.indexOf('date') !== -1 ? h.indexOf('date') : h.indexOf('data'),
      channel:      h.indexOf('channel'),
      campaign:     h.indexOf('campaign'),
      spend:        h.indexOf('spend'),
      impressions:  h.indexOf('impressions'),
      clicks:       h.indexOf('clicks'),
      detailViews:  h.indexOf('detail_views'),
      signups:      h.indexOf('signups'),
      conversions:  h.indexOf('conversions'),
      convRevenue:  h.indexOf('conv_revenue'),
    };

    console.log('[onDataLoaded] í—¤ë”:', h);
    console.log('[onDataLoaded] ì¸ë±ìŠ¤ ë§¤í•‘:', idx);
    console.log('[onDataLoaded] ì´ í–‰ìˆ˜:', result.rows.length);
    console.log('[onDataLoaded] ì²«ë²ˆì§¸ í–‰ ìƒ˜í”Œ:', result.rows[0]);

    RAW_DATA = result.rows.map(r => {
      const channel  = String(r[idx.channel]  || '');
      const campaign = String(r[idx.campaign] || '');
      // naver.searchad â†’ ìº í˜ì¸ëª…ì— 'ë¸Œëœë“œê²€ìƒ‰' í¬í•¨ ì—¬ë¶€ë¡œ ì„œë¸Œì±„ë„ ë¶„ê¸°
      let channelDisplay = channel;
      if (channel === 'naver.searchad') {
        channelDisplay = campaign.includes('ë¸Œëœë“œê²€ìƒ‰')
          ? 'naver.ë¸Œëœë“œê²€ìƒ‰'
          : 'naver.íŒŒì›Œë§í¬';
      }
      return {
        date:           String(r[idx.date] || ''),
        channel,                  // ì›ë³¸ ì±„ë„ (í•„í„°ë§ ìš©ë„)
        channelDisplay,           // í‘œì‹œÂ·ì§‘ê³„ìš© (ë¸Œëœë“œê²€ìƒ‰/íŒŒì›Œë§í¬ ë¶„ê¸°ë¨)
        campaign,
        spend:       Number(r[idx.spend]       || 0),
        impressions: Number(r[idx.impressions] || 0),
        clicks:      Number(r[idx.clicks]      || 0),
        detailViews: Number(r[idx.detailViews] || 0),
        signups:     Number(r[idx.signups]     || 0),
        conversions: Number(r[idx.conversions] || 0),
        convRevenue: Number(r[idx.convRevenue] || 0),
      };
    }).filter(d => d.date && d.channel);

    // (3) ì˜¤ëŠ˜ ë°ì´í„° ì—†ìŒ â†’ ì–´ì œê¹Œì§€ë§Œ ìœ íš¨ ë°ì´í„°ë¡œ ì²˜ë¦¬
    const todayStr = new Date().toISOString().slice(0, 10);
    const ydayStr  = (() => { const d = new Date(); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); })();
    const dates = RAW_DATA.map(d => d.date).filter(d => d <= ydayStr).sort();
    DATE_FROM = dates[0] || '';
    DATE_TO   = dates[dates.length - 1] || '';  // ìµœëŒ€ ì–´ì œ

    console.log('[onDataLoaded] RAW_DATA ê±´ìˆ˜:', RAW_DATA.length, '/ ë‚ ì§œë²”ìœ„:', DATE_FROM, '~', DATE_TO);

    document.getElementById('date-from').value = DATE_FROM;
    document.getElementById('date-to').value   = DATE_TO;

    // channelDisplay ê¸°ì¤€ìœ¼ë¡œ ì±„ë„ ëª©ë¡ êµ¬ì„± (naver.ë¸Œëœë“œê²€ìƒ‰ / naver.íŒŒì›Œë§í¬ ë¶„ê¸° ë°˜ì˜)
    CHANNELS      = [...new Set(RAW_DATA.map(d => d.channelDisplay))].sort();
    PERF_CHANNELS = CHANNELS;  // 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ìš©
    CAMP_MAP  = {};
    RAW_DATA.forEach(d => {
      if (!CAMP_MAP[d.channelDisplay]) CAMP_MAP[d.channelDisplay] = new Set();
      CAMP_MAP[d.channelDisplay].add(d.campaign);
    });
    Object.keys(CAMP_MAP).forEach(ch => { CAMP_MAP[ch] = [...CAMP_MAP[ch]].sort(); });

    const selCh = document.getElementById('sel-channel');
    CHANNELS.forEach(ch => {
      const opt = document.createElement('option');
      opt.value = ch; opt.textContent = ch;
      selCh.appendChild(opt);
    });

    // 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ ì´ˆê¸° êµ¬ì„±
    updateChanNav('perf');

    document.getElementById('last-updated').textContent =
      `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')} Â· ì´ ${RAW_DATA.length.toLocaleString()}í–‰`;

    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('app').style.flexDirection = 'column';

    // í¼í¬ë¨¼ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ í”„ë¡œë•íŠ¸ ë°ì´í„° ìˆœì°¨ ë¡œë“œ
    loadProductData();
    loadHotelData();  // hotel_rawdata ë³‘ë ¬ ë¡œë“œ (Product íƒ­ìš©)
    loadCrmData();    // crm_rawdata ë³‘ë ¬ ë¡œë“œ (CRM íƒ­ìš©)

    try {
      render();
    } catch(renderErr) {
      console.error('[render] ì˜¤ë¥˜:', renderErr);
      // render ì˜¤ë¥˜ëŠ” ì•±ì€ í‘œì‹œí•˜ë˜ ì½˜ì†”ì—ë§Œ ê¸°ë¡
    }

  } catch(e) {
    console.error('[onDataLoaded] ì˜¤ë¥˜:', e);
    onDataError('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + e.message);
  }
}

function onDataError(err) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error-msg').style.display = 'flex';
  document.getElementById('error-detail').textContent = String(err);
}

/* ================================================================
   í•„í„° ì ìš©
================================================================ */
function getFiltered() {
  // ctrl-bar ë“œë¡­ë‹¤ìš´ or 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ ì¤‘ ìš°ì„ ìˆœìœ„: PERF_CHAN
  const ch      = PERF_CHAN !== 'ì „ì²´' ? PERF_CHAN : document.getElementById('sel-channel').value;
  const camp    = document.getElementById('sel-campaign').value;
  const campTxt = (document.getElementById('camp-search').value || '').trim().toLowerCase();

  return RAW_DATA
    .filter(d =>
      d.date >= DATE_FROM && d.date <= DATE_TO &&
      (ch   === 'ì „ì²´' || d.channelDisplay === ch) &&
      (camp === 'ì „ì²´' || d.campaign       === camp) &&
      (!campTxt || d.campaign.toLowerCase().includes(campTxt))
    )
    .map(d => {
      // ë¸Œëœë“œê²€ìƒ‰ rows â†’ ë‚ ì§œë³„ ë¹„ìš© ì˜¤ë²„ë ˆì´ í•©ì‚°
      if (d.channelDisplay === 'naver.ë¸Œëœë“œê²€ìƒ‰' && BRAND_COSTS.length > 0) {
        // d.campaign ê¸°ì¤€ìœ¼ë¡œ ë§¤ì¹­ëœ í•­ëª©ë§Œ ë¹„ìš© í•©ì‚°
        const overlay = getBrandDailySpend(d.date, d.campaign);
        if (overlay > 0) return { ...d, spend: d.spend + overlay };
      }
      return d;
    });
}

/* ================================================================
   KPI ì§‘ê³„
================================================================ */
function calcKpi(rows) {
  const spend       = rows.reduce((s,d)=>s+d.spend,       0);
  const impressions = rows.reduce((s,d)=>s+d.impressions, 0);
  const clicks      = rows.reduce((s,d)=>s+d.clicks,      0);
  const signups     = rows.reduce((s,d)=>s+d.signups,     0);
  const detailViews = rows.reduce((s,d)=>s+d.detailViews, 0);
  const conversions = rows.reduce((s,d)=>s+d.conversions, 0);
  const convRevenue = rows.reduce((s,d)=>s+d.convRevenue, 0);
  return {
    spend, impressions, clicks, signups, detailViews, conversions, convRevenue,
    cpm:  impressions ? Math.round(spend / impressions * 1000) : 0,
    cpc:  clicks      ? Math.round(spend / clicks)            : 0,
    ctr:  pct(clicks, impressions),
    cac:  signups     ? Math.round(spend / signups)           : 0,
    cpa:  detailViews ? Math.round(spend / detailViews)       : 0,
    cps:  conversions ? Math.round(spend / conversions)       : 0,
    roas: pct0(convRevenue, spend),
    signupCvr:     pct(signups,     clicks),
    purchaseCvr:   pct(conversions, clicks),
    postSignupCvr: pct(conversions, signups),
  };
}

/* ================================================================
   ì‹œê³„ì—´ ì§‘ê³„
================================================================ */
function calcTimeSeries(rows, gran) {
  // ì „ì²´ ì§‘ê³„
  const map = {};
  rows.forEach(d => {
    const k = periodKey(d.date, gran);
    if (!map[k]) map[k] = {period:k, spend:0, convRevenue:0, conversions:0, clicks:0, impressions:0, signups:0};
    map[k].spend       += d.spend;
    map[k].convRevenue += d.convRevenue;
    map[k].conversions += d.conversions;
    map[k].clicks      += d.clicks;
    map[k].impressions += d.impressions;
    map[k].signups     += d.signups;
  });

  // ì±„ë„ë³„ spend/rev (ROAS ë©€í‹°ë¼ì¸ìš©) â€” channelDisplay ê¸°ì¤€
  const chMap = {};
  rows.forEach(d => {
    const k = periodKey(d.date, gran);
    if (!chMap[k]) chMap[k] = {};
    chMap[k][d.channelDisplay + '_spend'] = (chMap[k][d.channelDisplay + '_spend'] || 0) + d.spend;
    chMap[k][d.channelDisplay + '_rev']   = (chMap[k][d.channelDisplay + '_rev']   || 0) + d.convRevenue;
  });

  return Object.values(map).map(d => {
    const ch = chMap[d.period] || {};
    const chRoas = {};
    CHANNELS.forEach(c => {
      const s = ch[c + '_spend'] || 0;
      const r = ch[c + '_rev']   || 0;
      chRoas[c + '_roas'] = s ? Math.round((r / s) * 100) : null;
    });
    return {
      ...d, ...chRoas,
      label: periodLabel(d.period, gran),
      roas:  d.spend ? Math.round((d.convRevenue / d.spend) * 100) : 0,
    };
  }).sort((a, b) => a.period.localeCompare(b.period));
}

/* ================================================================
   ì±„ë„ë³„ ì‹œê³„ì—´ (ìŠ¤íƒë°”ìš©)
================================================================ */
function calcChTS(rows, gran) {
  const map = {};
  rows.forEach(d => {
    const k = periodKey(d.date, gran);
    if (!map[k]) map[k] = { period: k };
    map[k][d.channelDisplay + '_spend'] = (map[k][d.channelDisplay + '_spend'] || 0) + d.spend;
    map[k][d.channelDisplay + '_rev']   = (map[k][d.channelDisplay + '_rev']   || 0) + d.convRevenue;
  });
  return Object.values(map)
    .map(row => ({ ...row, label: periodLabel(row.period, gran) }))
    .sort((a, b) => a.period.localeCompare(b.period));
}

/* ================================================================
   ì°¨ì›ë³„ ì§‘ê³„ (ì±„ë„ë³„ or ìº í˜ì¸ë³„)
================================================================ */
function calcByDim(rows, dimKey) {
  const map = {};
  rows.forEach(d => {
    // channel â†’ channelDisplayë¡œ ëŒ€ì²´ (ë¸Œëœë“œê²€ìƒ‰/íŒŒì›Œë§í¬ ë¶„ê¸° ë°˜ì˜)
    const key = dimKey === 'channel' ? d.channelDisplay : d[dimKey];
    if (!map[key]) map[key] = {dim:key, spend:0, impressions:0, clicks:0, signups:0, detailViews:0, conversions:0, convRevenue:0};
    const m = map[key];
    m.spend       += d.spend;
    m.impressions += d.impressions;
    m.clicks      += d.clicks;
    m.signups     += d.signups;
    m.detailViews += d.detailViews;
    m.conversions += d.conversions;
    m.convRevenue += d.convRevenue;
  });
  return Object.values(map).map(d => ({
    ...d,
    ctr:        pct(d.clicks,      d.impressions),
    cpc:        d.clicks      ? Math.round(d.spend / d.clicks)      : 0,
    cac:        d.signups     ? Math.round(d.spend / d.signups)     : 0,
    cpa:        d.detailViews ? Math.round(d.spend / d.detailViews) : 0,
    cps:        d.conversions ? Math.round(d.spend / d.conversions) : 0,
    roas:       pct0(d.convRevenue, d.spend),
    signupCvr:  pct(d.signups,     d.clicks),
    purchaseCvr:pct(d.conversions, d.clicks),
  })).sort((a, b) => b.spend - a.spend);
}

/* ================================================================
   ì°¨íŠ¸ ë Œë”
================================================================ */
function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

const baseAxes = () => ({
  x: { ticks: { color: '#6c7280', font:{size:10} }, grid: { color: CHART_DEFAULTS.grid } },
  y: { ticks: { color: '#6c7280', font:{size:10} }, grid: { color: CHART_DEFAULTS.grid } },
});

// ë¹„ìš© vs ì „í™˜ë§¤ì¶œ (ComposedChart ëŒ€ì‹  Bar+Line í˜¼í•©)
function renderSpendRev(ts, granLabel) {
  destroyChart('spend-rev');
  const ctx = document.getElementById('chart-spend-rev').getContext('2d');
  document.getElementById('ct-spend-rev').textContent = `${granLabel} ë¹„ìš© vs ì „í™˜ë§¤ì¶œ`;
  charts['spend-rev'] = new Chart(ctx, {
    data: {
      labels: ts.map(d => d.label),
      datasets: [
        { type:'bar',  label:'ë¹„ìš©',     data: ts.map(d=>d.spend),       backgroundColor:'#ef444466', borderRadius:4, yAxisID:'y' },
        { type:'line', label:'ì „í™˜ë§¤ì¶œ', data: ts.map(d=>d.convRevenue), borderColor:'#a78bfa',       borderWidth:2, pointRadius:0, tension:0.3, yAxisID:'y2' },
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: { legend:{labels:{color:'#8a8f98',font:{size:11}}}, tooltip: CHART_DEFAULTS.tooltip },
      scales: {
        ...baseAxes(),
        y:  { ...baseAxes().y, position:'left',  ticks:{ ...baseAxes().y.ticks, callback: v=>fo(v) } },
        y2: { ...baseAxes().y, position:'right', grid:{display:false}, ticks:{ ...baseAxes().y.ticks, callback: v=>fo(v) } },
      }
    }
  });
}

// ROAS ì±„ë„ë³„ ë©€í‹°ë¼ì¸
// ì˜¤ë¥¸ìª½ ì¶•(y2): ë¸Œëœë“œê²€ìƒ‰ (ROAS ìŠ¤ì¼€ì¼ì´ ë‹¬ë¼ ë¶„ë¦¬)
// ì™¼ìª½ ì¶•(y):   ë‚˜ë¨¸ì§€ ì „ì²´ (íŒŒì›Œë§í¬, google.adwords, facebook.business ë“±)
const ROAS_RIGHT_AXIS = new Set(['naver.ë¸Œëœë“œê²€ìƒ‰']); // ì •í™•í•œ channelDisplay ì´ë¦„ ì¼ì¹˜

function renderRoas(ts, chInData, granLabel) {
  destroyChart('roas');
  const ctx = document.getElementById('chart-roas').getContext('2d');
  document.getElementById('ct-roas').textContent = `${granLabel} ROAS ì¶”ì´ â€” ì±„ë„ë³„`;

  // ì˜¤ë¥¸ìª½ ì¶• ì±„ë„ë§Œ ë”°ë¡œ ë¶„ë¦¬
  const rightChs = chInData.filter(ch => ROAS_RIGHT_AXIS.has(ch));
  const leftChs  = chInData.filter(ch => !ROAS_RIGHT_AXIS.has(ch));
  const hasRight  = rightChs.length > 0;

  // 'ì „ì²´' ë¼ì¸: ts.roasëŠ” ì „ì²´ ì±„ë„ í•©ì‚° (ë¸Œëœë“œê²€ìƒ‰ í¬í•¨)
  // ë¸Œëœë“œê²€ìƒ‰ ROASê°€ ì˜¤ë¥¸ìª½ ì¶•ì´ë¼ ìŠ¤ì¼€ì¼ ì˜í–¥ ì—†ìŒ â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const overallLabel = 'ì „ì²´';

  const datasets = [
    // ì „ì²´ í•©ì‚° ë¼ì¸ (í•­ìƒ ì™¼ìª½ ì¶•)
    {
      label: overallLabel,
      data: ts.map(d => d.roas),   // ì „ì²´ roas (ìŠ¤ì¼€ì¼ ì°¸ê³ ìš©)
      borderColor:'#ffffff44', borderWidth:1.5, borderDash:[4,3],
      pointRadius:0, tension:0.3, spanGaps:true, yAxisID:'y'
    },
    // ì™¼ìª½ ì¶• ì±„ë„ë“¤
    ...leftChs.map((ch, i) => ({
      label: ch,
      data: ts.map(d => d[ch + '_roas'] ?? null),
      borderColor: chColor(ch, i),
      borderWidth: 2,
      pointRadius: GRAN !== 'daily' ? 3 : 0,
      tension: 0.3,
      spanGaps: true,
      yAxisID: 'y',
    })),
    // ì˜¤ë¥¸ìª½ ì¶• ì±„ë„ë“¤ (ë¸Œëœë“œê²€ìƒ‰)
    ...rightChs.map((ch, i) => ({
      label: ch + ' â†’',
      data: ts.map(d => d[ch + '_roas'] ?? null),
      borderColor: '#fbbf24',           // í™©ê¸ˆìƒ‰ìœ¼ë¡œ êµ¬ë¶„
      borderWidth: 2.5,
      pointRadius: GRAN !== 'daily' ? 4 : 0,
      tension: 0.3,
      spanGaps: true,
      yAxisID: 'y2',
      borderDash: [6, 3],
    })),
  ];

  charts['roas'] = new Chart(ctx, {
    type:'line',
    data: { labels: ts.map(d => d.label), datasets },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend:{ labels:{ color:'#8a8f98', font:{size:10} } },
        tooltip: {
          ...CHART_DEFAULTS.tooltip,
          callbacks: {
            label: item => {
              const axis = item.dataset.yAxisID === 'y2' ? ' [ìš°ì¶•]' : '';
              const val  = item.parsed.y != null ? item.parsed.y + '%' : 'â€“';
              return `${item.dataset.label}: ${val}${axis}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks:{ color:'#6c7280', font:{size:10} },
          grid:{ color:'#2a2d35' }
        },
        y: {
          position: 'left',
          ticks:{ color:'#6c7280', font:{size:10}, callback: v => v + '%' },
          grid:{ color:'#2a2d35' },
          title:{ display:true, text:'íŒŒì›Œë§í¬ Â· Google Â· Meta', color:'#555b66', font:{size:9} }
        },
        y2: {
          position: 'right',
          display: hasRight,
          ticks:{ color:'#fbbf24', font:{size:10}, callback: v => v + '%' },
          grid:{ drawOnChartArea:false },
          title:{ display:true, text:'ë¸Œëœë“œê²€ìƒ‰ ROAS (ìš°ì¶•)', color:'#fbbf24', font:{size:9} }
        }
      }
    }
  });
}

// ë¹„ìš© ì ìœ ìœ¨ íŒŒì´
function renderShare(byDim, dimLabel) {
  destroyChart('share');
  const ctx = document.getElementById('chart-share').getContext('2d');
  document.getElementById('ct-share').textContent = `${dimLabel}ë³„ ë¹„ìš© ì ìœ ìœ¨`;
  const total = byDim.reduce((s,d)=>s+d.spend, 0);
  charts['share'] = new Chart(ctx, {
    type:'doughnut',
    data: {
      labels: byDim.map(d => d.dim),
      datasets: [{ data: byDim.map(d=>d.spend), backgroundColor: byDim.map((d,i)=>chColor(d.dim, i)), borderWidth:0 }]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend: { position:'bottom', labels:{ color:'#8a8f98', font:{size:10}, padding:8 } },
        tooltip: { ...CHART_DEFAULTS.tooltip, callbacks:{ label: ctx=>`${ctx.label}: ${fo(ctx.raw)}ì› (${total?((ctx.raw/total)*100).toFixed(1):0}%)` } }
      }
    }
  });
}

// ì±„ë„ë³„ ë¹„ìš© ìŠ¤íƒë°”
function renderChSpend(chTS, chInData, granLabel) {
  destroyChart('ch-spend');
  const ctx = document.getElementById('chart-ch-spend').getContext('2d');
  document.getElementById('ct-ch-spend').textContent = `${granLabel} ì±„ë„ë³„ ë¹„ìš© ì¶”ì´`;
  charts['ch-spend'] = new Chart(ctx, {
    type:'bar',
    data: {
      labels: chTS.map(d=>d.label),
      datasets: chInData.map((ch,i) => ({
        label: ch+' ë¹„ìš©',
        data: chTS.map(d=>d[ch+'_spend']||0),
        backgroundColor: chColor(ch, i),
        stack:'a', borderRadius:0,
      }))
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: { legend:{labels:{color:'#8a8f98',font:{size:10}}}, tooltip: CHART_DEFAULTS.tooltip },
      scales: { ...baseAxes(), y:{ ...baseAxes().y, stacked:true, ticks:{...baseAxes().y.ticks, callback:v=>fo(v)} }, x:{...baseAxes().x, stacked:true} }
    }
  });
}

// ì±„ë„ë³„ ì „í™˜ë§¤ì¶œ ìŠ¤íƒë°”
function renderChRev(chTS, chInData, granLabel) {
  destroyChart('ch-rev');
  const ctx = document.getElementById('chart-ch-rev').getContext('2d');
  document.getElementById('ct-ch-rev').textContent = `${granLabel} ì±„ë„ë³„ ì „í™˜ë§¤ì¶œ ì¶”ì´`;
  charts['ch-rev'] = new Chart(ctx, {
    type:'bar',
    data: {
      labels: chTS.map(d=>d.label),
      datasets: chInData.map((ch,i) => ({
        label: ch+' ë§¤ì¶œ',
        data: chTS.map(d=>d[ch+'_rev']||0),
        backgroundColor: chColor(ch, i),
        stack:'a', borderRadius:0,
      }))
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: { legend:{labels:{color:'#8a8f98',font:{size:10}}}, tooltip: CHART_DEFAULTS.tooltip },
      scales: { ...baseAxes(), y:{ ...baseAxes().y, stacked:true, ticks:{...baseAxes().y.ticks, callback:v=>fo(v)} }, x:{...baseAxes().x, stacked:true} }
    }
  });
}

/* ================================================================
   í…Œì´ë¸” ë Œë”
================================================================ */
function renderTable(byDim, dimLabel) {
  document.getElementById('table-title').textContent = `${dimLabel}ë³„ ì„±ê³¼ ìƒì„¸`;
  const cols = [
    {key:'dim',         label:dimLabel,      fmt:v=>v},
    {key:'spend',       label:'ë¹„ìš©',        fmt:v=>fo(v)+'ì›',  cls:'right'},
    {key:'impressions', label:'ë…¸ì¶œ',        fmt:v=>fo(v),       cls:'right'},
    {key:'clicks',      label:'í´ë¦­',        fmt:v=>fo(v),       cls:'right'},
    {key:'ctr',         label:'CTR',         fmt:v=>v+'%',       cls:'right'},
    {key:'signups',     label:'ê°€ì…',        fmt:v=>fo(v),       cls:'right'},
    {key:'signupCvr',   label:'ê°€ì…CV',      fmt:v=>v+'%',       cls:'right'},
    {key:'conversions', label:'ì „í™˜',        fmt:v=>fo(v),       cls:'right'},
    {key:'purchaseCvr', label:'êµ¬ë§¤CV',      fmt:v=>v+'%',       cls:'right'},
    {key:'cac',         label:'CAC',         fmt:v=>fo(v)+'ì›',  cls:'right'},
    {key:'cpa',         label:'CPA',         fmt:v=>fo(v)+'ì›',  cls:'right'},
    {key:'cps',         label:'CPS',         fmt:v=>fo(v)+'ì›',  cls:'right'},
    {key:'convRevenue', label:'ì „í™˜ë§¤ì¶œ',    fmt:v=>fo(v)+'ì›',  cls:'right'},
    {key:'roas',        label:'ROAS',        fmt:v=>v+'%',       cls:'right'},
  ];

  // í—¤ë”
  document.getElementById('table-head').innerHTML =
    '<tr>' + cols.map(c=>`<th class="${c.cls||''}">${c.label}</th>`).join('') + '</tr>';

  // ë°”ë””
  document.getElementById('table-body').innerHTML = byDim.map(row =>
    '<tr>' + cols.map(c=>`<td class="${c.cls||''}">${c.fmt(row[c.key])}</td>`).join('') + '</tr>'
  ).join('');
}

/* ================================================================
   ë©”ì¸ ë Œë” í•¨ìˆ˜
================================================================ */
/* ================================================================
   ëª©í‘œ ëŒ€ë¹„ í˜„í™© ë Œë”
================================================================ */
function rateColor(rate, inv=false) {
  const good = inv ? rate <= 100 : rate >= 100;
  if (good) return '#34d399';
  if (rate >= 80) return '#fbbf24';
  return '#ef4444';
}

function renderGoalCard(ids, actual, goal, unit, inv=false, remainDays=0, elapsedDays=0, totalDays=0) {
  if (!goal) return;

  // â”€â”€ ì „ì²´ ë‹¬ì„±ë¥  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rate  = +(actual / goal * 100).toFixed(1);
  const color = rateColor(rate, inv);
  const over  = actual >= goal;
  const diff  = goal - actual; // ì–‘ìˆ˜=ë¶€ì¡±, ìŒìˆ˜=ì´ˆê³¼

  // â”€â”€ ì§„í–‰ì¼ìˆ˜ ëŒ€ë¹„ ë‹¬ì„±ë¥ (í˜ì´ìŠ¤ìœ¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í˜ì´ìŠ¤ ê¸°ì¤€ê°’: ëª©í‘œ Ã— (ì§„í–‰ì¼ìˆ˜/ì „ì²´ì¼ìˆ˜)
  // inv(ê´‘ê³ ë¹„)ëŠ” ì†Œë¹„ê°€ ë¹ ë¥¼ìˆ˜ë¡ ë‚˜ì¨ â†’ ë°˜ì „
  let paceRate = null;
  let paceColor = '#555b66';
  if (totalDays > 0 && elapsedDays > 0) {
    const paceGoal = goal * (elapsedDays / totalDays);
    if (inv) {
      // ê´‘ê³ ë¹„: í˜ì´ìŠ¤ ëŒ€ë¹„ í˜„ì¬ ì†Œë¹„ê°€ ëª©í‘œë³´ë‹¤ ì ìœ¼ë©´ good
      paceRate = +(actual / paceGoal * 100).toFixed(1);
      paceColor = rateColor(paceRate, true);
    } else {
      paceRate = +(actual / paceGoal * 100).toFixed(1);
      paceColor = rateColor(paceRate, false);
    }
  }

  const card = document.getElementById(ids.card);
  if (card) card.style.borderTopColor = color;

  const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  const setStyle = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };
  const setBg = (id, bg, col) => {
    const el = document.getElementById(id);
    if (el) { el.style.background = bg; el.style.color = col; }
  };

  // ê°’ í‘œì‹œ (í•­ìƒ actual ê°’)
  const actualStr = unit === '%' ? actual.toFixed(1) : fo(Math.round(actual));
  const goalStr   = unit === '%' ? goal.toFixed(1)   : fo(Math.round(goal));
  set(ids.val,  actualStr);
  set(ids.goal, goalStr);

  // ì „ì²´ ë‹¬ì„±ë¥  ë°°ì§€
  set(ids.rate, rate + '%');
  setBg(ids.rate, color + '33', color);

  // í˜ì´ìŠ¤ ë‹¬ì„±ë¥  ë°°ì§€
  if (ids.pace) {
    if (paceRate !== null) {
      set(ids.pace, `í˜ì´ìŠ¤ ${paceRate}%`);
      setBg(ids.pace, paceColor + '22', paceColor);
    } else {
      set(ids.pace, 'â€“');
      setBg(ids.pace, '#2a2d35', '#555b66');
    }
  }

  // ì§„í–‰ë°” (ì „ì²´ ë‹¬ì„±ë¥  ê¸°ì¤€)
  const bar = document.getElementById(ids.bar);
  if (bar) {
    bar.style.width      = Math.min(rate, 100) + '%';
    bar.style.background = color;
  }

  // í˜ì´ìŠ¤ ë§ˆì»¤ â€” ì§„í–‰ë¥ (%)ì— í•´ë‹¹í•˜ëŠ” ìœ„ì¹˜ì— ì„¸ë¡œì„ 
  if (ids.paceMark) {
    const mark = document.getElementById(ids.paceMark);
    if (mark && totalDays > 0) {
      const pacePos = Math.min((elapsedDays / totalDays) * 100, 100);
      mark.style.display  = 'block';
      mark.style.left     = pacePos + '%';
      mark.style.background = '#fbbf24';
      mark.title = `ì˜¤ëŠ˜ ê¸°ì¤€ ì§„í–‰ë¥  ${pacePos.toFixed(0)}%`;
    } else if (mark) {
      mark.style.display = 'none';
    }
  }

  // ì”ì—¬ ë¬¸êµ¬
  const unitLabel = unit === '%' ? '%p' : unit;
  let remainText = '';
  if (over) {
    const overAmt = unit === '%'
      ? `+${(actual - goal).toFixed(1)}%p`
      : `+${fo(Math.round(Math.abs(diff)))}${unitLabel}`;
    remainText = `âœ… ëª©í‘œ ì´ˆê³¼ ë‹¬ì„± (${overAmt})`;
  } else {
    remainText = `ğŸ“Š ë‹¬ì„±ë¥  ${rate}%`;
    if (remainDays > 0 && unit !== '%') {
      const dailyNeeded = Math.ceil(Math.abs(diff) / remainDays);
      remainText += ` Â· ì”ì—¬ ${remainDays}ì¼ ì¼í‰ê·  ${fo(dailyNeeded)}${unitLabel} í•„ìš”`;
    } else if (unit === '%') {
      remainText += ` Â· ëª©í‘œê¹Œì§€ ${(goal - actual).toFixed(1)}%p`;
    }
  }
  set(ids.remain, remainText);
  setStyle(ids.remain, 'color', over ? '#34d399' : (rate >= 80 ? '#fbbf24' : '#8a8f98'));
}

function renderGoalSection(kpi) {
  if (!GOAL_ON || !GOALS.from) {
    document.getElementById('goal-section').style.display = 'none';
    return;
  }
  document.getElementById('goal-section').style.display = '';

  // ê¸°ê°„ ë¼ë²¨
  document.getElementById('goal-period-label').textContent =
    `${GOALS.from} ~ ${GOALS.to}`;

  // ê¸°ê°„ ë¶ˆì¼ì¹˜ ê²½ê³ 
  const mismatch = GOALS.from !== DATE_FROM || GOALS.to !== DATE_TO;
  const warnEl   = document.getElementById('goal-period-warn');
  warnEl.style.display = mismatch ? 'flex' : 'none';

  // ì¸ì‚¬ì´íŠ¸ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
  document.getElementById('chk-insight-goal').checked = INSIGHT_GOAL_ON;

  // â”€â”€ ê¸°ê°„ ì¼ìˆ˜ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const today      = new Date(); today.setHours(0,0,0,0);
  const goalStart  = new Date(GOALS.from); goalStart.setHours(0,0,0,0);
  const goalEnd    = new Date(GOALS.to);   goalEnd.setHours(0,0,0,0);
  // ì „ì²´ ëª©í‘œ ê¸°ê°„ ì¼ìˆ˜ (ì‹œì‘~ì¢…ë£Œ í¬í•¨)
  const totalDays   = Math.max(1, Math.round((goalEnd - goalStart) / 86400000) + 1);
  // ì§„í–‰ì¼ìˆ˜: ì‹œì‘ì¼ë¶€í„° ì–´ì œê¹Œì§€ (ì˜¤ëŠ˜ ë°ì´í„° ì—†ìŒ)
  const yesterday   = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
  const elapsedEnd  = yesterday < goalEnd ? yesterday : goalEnd;
  const elapsedDays = Math.max(0, Math.round((elapsedEnd - goalStart) / 86400000) + 1);
  // ì”ì—¬ì¼ìˆ˜: ì˜¤ëŠ˜ë¶€í„° ì¢…ë£Œì¼ê¹Œì§€
  const remainDays  = Math.max(0, Math.round((goalEnd - today) / 86400000) + 1);

  const pFiltered = PRODUCT_DATA.filter(d => d.date >= DATE_FROM && d.date <= DATE_TO);

  // 5ê°œ ì¹´ë“œ ë Œë”
  renderGoalCard(
    { card:'gc-total-revenue', val:'gc-val-revenue', goal:'gc-goal-revenue',
      rate:'gc-rate-revenue',  bar:'gc-bar-revenue', remain:'gc-remain-revenue',
      pace:'gc-pace-revenue',  paceMark:'gc-pace-mark-revenue' },
    pFiltered.reduce((s,d) => s+d.totalRevenue, 0),
    GOALS.totalRevenue, 'ì›', false, remainDays, elapsedDays, totalDays
  );
  renderGoalCard(
    { card:'gc-total-sales', val:'gc-val-sales', goal:'gc-goal-sales',
      rate:'gc-rate-sales',  bar:'gc-bar-sales', remain:'gc-remain-sales',
      pace:'gc-pace-sales',  paceMark:'gc-pace-mark-sales' },
    pFiltered.reduce((s,d) => s+d.totalSales, 0),
    GOALS.totalSales, 'ê±´', false, remainDays, elapsedDays, totalDays
  );
  renderGoalCard(
    { card:'gc-ad-spend', val:'gc-val-spend', goal:'gc-goal-spend',
      rate:'gc-rate-spend',  bar:'gc-bar-spend', remain:'gc-remain-spend',
      pace:'gc-pace-spend',  paceMark:'gc-pace-mark-spend' },
    kpi.spend, GOALS.adSpend, 'ì›', true, remainDays, elapsedDays, totalDays
  );
  renderGoalCard(
    { card:'gc-roas', val:'gc-val-roas', goal:'gc-goal-roas',
      rate:'gc-rate-roas',  bar:'gc-bar-roas', remain:'gc-remain-roas',
      pace:'gc-pace-roas',  paceMark:'gc-pace-mark-roas' },
    kpi.spend ? +(kpi.convRevenue / kpi.spend * 100).toFixed(1) : 0,
    GOALS.roas, '%', false, 0, elapsedDays, totalDays
  );
  renderGoalCard(
    { card:'gc-conv-revenue', val:'gc-val-conv', goal:'gc-goal-conv',
      rate:'gc-rate-conv',  bar:'gc-bar-conv', remain:'gc-remain-conv',
      pace:'gc-pace-conv',  paceMark:'gc-pace-mark-conv' },
    kpi.convRevenue, GOALS.convRevenue, 'ì›', false, remainDays, elapsedDays, totalDays
  );
}

function render() {
  const filtered  = getFiltered();
  const kpi       = calcKpi(filtered);
  const granLabel = GRAN==='daily'?'ì¼ë³„':GRAN==='weekly'?'ì£¼ë³„':'ì›”ë³„';
  const ts        = calcTimeSeries(filtered, GRAN);
  const chInData  = [...new Set(filtered.map(d=>d.channelDisplay))]; // channelDisplay ê¸°ì¤€ìœ¼ë¡œ ì±„ë„ êµ¬ë¶„

  const selCh   = document.getElementById('sel-channel').value;
  const dimKey   = selCh !== 'ì „ì²´' ? 'campaign' : 'channel';
  const dimLabel = selCh !== 'ì „ì²´' ? 'ìº í˜ì¸'   : 'ì±„ë„';
  const byDim    = calcByDim(filtered, dimKey);

  // â”€â”€ KPI ì—…ë°ì´íŠ¸ â”€â”€
  const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
  set('kv-spend',          fo(Math.round(kpi.spend)));
  set('kv-impressions',    fo(kpi.impressions));
  set('kv-clicks',         fo(kpi.clicks));
  set('kv-signups',        fo(kpi.signups));
  set('kv-detailviews',    fo(kpi.detailViews));
  set('kv-conversions',    fo(kpi.conversions));
  set('kv-conv-revenue',   fo(kpi.convRevenue));
  set('kv-cpm',            fo(kpi.cpm));
  set('kv-cpc',            fo(kpi.cpc));
  set('kv-ctr',            kpi.ctr);
  set('kv-cac',            fo(kpi.cac));
  set('kv-cpa',            fo(kpi.cpa));
  set('kv-cps',            fo(kpi.cps));
  set('kv-roas',           kpi.roas);
  set('kv-signup-cvr',     kpi.signupCvr);
  set('kv-purchase-cvr',   kpi.purchaseCvr);
  set('kv-post-signup-cvr',kpi.postSignupCvr);
  // â”€â”€ í”„ë¡œë•íŠ¸ KPI ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (PRODUCT_DATA.length > 0) {
    // í˜„ì¬ í•„í„° ê¸°ê°„ì— ë§ëŠ” product í–‰ ì¶”ì¶œ (ê¸°ê°„ ë‚´ ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
    const pFiltered = PRODUCT_DATA.filter(d => d.date >= DATE_FROM && d.date <= DATE_TO);

    const pSum = pFiltered.reduce((acc, d) => {
      acc.totalRevenue += d.totalRevenue;
      acc.totalSales   += d.totalSales;
      acc.totalNights  += d.totalNights;
      acc.coupon       += d.coupon;
      acc.point        += d.point;
      acc.totalDiscount+= d.totalDiscount;
      // ë¦¬ë“œíƒ€ì„: ê°’ì´ ìˆëŠ” í–‰ë§Œ í•©ì‚° â†’ ë‚˜ì¤‘ì— í–‰ìˆ˜ë¡œ ë‚˜ëˆ  í‰ê· 
      if (d.leadTime > 0) {
        acc.leadTimeSum += d.leadTime;
        acc.leadTimeCnt += 1;
      }
      return acc;
    }, { totalRevenue:0, totalSales:0, totalNights:0,
         coupon:0, point:0, totalDiscount:0, leadTimeSum:0, leadTimeCnt:0 });

    const days      = pFiltered.length || 1;
    const pAov      = pSum.totalSales   ? Math.round(pSum.totalRevenue / pSum.totalSales)   : 0;
    const pAdr      = pSum.totalNights  ? Math.round(pSum.totalRevenue / pSum.totalNights)  : 0;
    const pLos      = pSum.totalSales   ? +(pSum.totalNights / pSum.totalSales).toFixed(2)  : 0;
    // ë¦¬ë“œíƒ€ì„: ì„ íƒ ê¸°ê°„ ë‚´ ë°ì´í„° í‰ê· . ê¸°ê°„ ë‚´ ë°ì´í„° ì—†ìœ¼ë©´ '-'
    const pLeadTime = pSum.leadTimeCnt  ? +(pSum.leadTimeSum / pSum.leadTimeCnt).toFixed(1) : null;
    const pAdSpendRatio = pSum.totalRevenue ? +(kpi.spend / pSum.totalRevenue * 100).toFixed(1) : 0;
    const pAdRevRatio   = pSum.totalRevenue ? +(kpi.convRevenue / pSum.totalRevenue * 100).toFixed(1) : 0;

    // â”€â”€ í”„ë¡œë•íŠ¸ KPI 7ì¹´ë“œ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    set('pkv-total-revenue',     fo(pSum.totalRevenue));
    set('pkv-total-revenue-sub', `ì¼í‰ê·  ${fo(Math.round(pSum.totalRevenue/days))}ì›`);
    set('pkv-total-sales',       fo(pSum.totalSales));
    set('pkv-total-sales-sub',   `ì¼í‰ê·  ${+(pSum.totalSales/days).toFixed(1)}ê±´`);
    set('pkv-total-nights',      fo(pSum.totalNights));
    set('pkv-total-nights-sub',  `ì¼í‰ê·  ${+(pSum.totalNights/days).toFixed(1)}ë°•`);
    set('pkv-aov',               fo(pAov));
    set('pkv-adr',               fo(pAdr));
    set('pkv-los',               pLos);
    set('pkv-leadtime', pLeadTime !== null ? pLeadTime : '-');

    // ì „í™˜ìœ¨ ì„¹ì…˜ ê´‘ê³ ë¹„/ë§¤ì¶œ ì¹´ë“œ ë™ê¸°í™”
    set('pkv-ad-spend-ratio', pAdSpendRatio);
    set('pkv-ad-rev-ratio',   pAdRevRatio);
    set('kv-ad-spend-ratio',  pAdSpendRatio);
    set('kv-ad-rev-ratio',    pAdRevRatio);
  } else {
    set('kv-ad-spend-ratio', '-');
    set('kv-ad-rev-ratio',   '-');
  }

  // â”€â”€ ëª©í‘œ ëŒ€ë¹„ í˜„í™© ë Œë” â”€â”€
  renderGoalSection(kpi);

  // â”€â”€ ì°¨íŠ¸ ë Œë” â”€â”€
  renderSpendRev(ts, granLabel);
  renderRoas(ts, chInData, granLabel);
  renderShare(byDim, dimLabel);

  // ì±„ë„ ì „ì²´ì¼ ë•Œë§Œ ì±„ë„ë³„ ì¶”ì´ ì°¨íŠ¸ í‘œì‹œ
  const row2 = document.getElementById('chart-row-2');
  if (selCh === 'ì „ì²´') {
    row2.style.display = 'grid';
    const chTS = calcChTS(filtered, GRAN);
    renderChSpend(chTS, chInData, granLabel);
    renderChRev(chTS, chInData, granLabel);
  } else {
    row2.style.display = 'none';
    destroyChart('ch-spend');
    destroyChart('ch-rev');
  }

  // â”€â”€ í…Œì´ë¸” â”€â”€
  renderTable(byDim, dimLabel);
}

/* ================================================================
   ì¸ì‚¬ì´íŠ¸ ì—”ì§„ v4
   - ì§‘ê³„ ë‹¨ìœ„: ì¼ë³„ / ì£¼ë³„ / ì›”ë³„
   - ë¹„êµ ë¶„ì„: ë™ê¸°ê°„ ìë™ / ì§ì ‘ ì…ë ¥
   - ì™¼ìª½ íŒ¨ë„: ì „ì²´ ì±„ë„ ì¸ì‚¬ì´íŠ¸ / ì±„ë„ ì„ íƒ ì‹œ ìº í˜ì¸ ê¸°ì¤€ ì¸ì‚¬ì´íŠ¸
   - ì˜¤ë¥¸ìª½: SVG ì‹œê³„ì—´ ì°¨íŠ¸ + ëŒ€ì‹œë³´ë“œ ìˆœì„œ KPI í…Œì´ë¸” (ë³¼ë¥¨â†’íš¨ìœ¨â†’ì „í™˜ìœ¨)
================================================================ */

// â”€â”€ ì¸ì‚¬ì´íŠ¸ ì „ìš© ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/* ================================================================
   ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ v5 â€” ì„œìˆ í˜• ë¶„ì„ + ì°¨íŠ¸íƒ­
================================================================ */

/* â”€â”€ ìƒíƒœ â”€â”€ */
const INS5 = {
  tab: 'insight',        // 'insight' | 'chart'
  selChannel: 'ì „ì²´',
  campFilter: '',
  chartMetric: 'roas',
  from: '',
  to: '',
};

/* â”€â”€ ì±„ë„ ë¼ë²¨ ë§¤í•‘ â”€â”€ */
const INS5_CH_LABEL = {
  'facebook.business': 'Facebook',
  'google.ads':        'Google Ads',
  'naver.gfa':         'Naver GFA',
  'kakao.moment':      'Kakao',
  'naver.ë¸Œëœë“œê²€ìƒ‰':   'N.ë¸Œëœë“œê²€ìƒ‰',
  'naver.íŒŒì›Œë§í¬':     'N.íŒŒì›Œë§í¬',
};
const INS5_CH_COLOR = {
  'facebook.business': '#38bdf8',
  'google.ads':        '#6c63ff',
  'naver.gfa':         '#34d399',
  'kakao.moment':      '#fbbf24',
  'naver.ë¸Œëœë“œê²€ìƒ‰':   '#4ade80',
  'naver.íŒŒì›Œë§í¬':     '#a78bfa',
};
const INS5_CAMP_COLORS = ['#38bdf8','#6c63ff','#34d399','#fbbf24','#f472b6','#fb923c','#a78bfa','#4ade80'];

/* â”€â”€ ì§‘ê³„ â”€â”€ */
function ins5Sum(rows) {
  const s = {spend:0,impr:0,clicks:0,su:0,conv:0,rev:0};
  rows.forEach(r => {
    s.spend += r.spend;
    s.impr  += r.impressions || 0;
    s.clicks+= r.clicks;
    s.su    += r.signups     || 0;
    s.conv  += r.conversions || 0;
    s.rev   += r.convRevenue || 0;
  });
  return s;
}
function ins5Kpi(m) {
  const safe = (a,b) => b ? a/b : 0;
  return {
    roas:    +( safe(m.rev, m.spend) * 100 ).toFixed(1),
    cpm:     Math.round( safe(m.spend, m.impr) * 1000 ),
    cpc:     Math.round( safe(m.spend, m.clicks) ),
    ctr:     +( safe(m.clicks, m.impr) * 100 ).toFixed(2),
    cpa:     Math.round( safe(m.spend, m.conv) ),
    svr:     +( safe(m.su, m.clicks) * 100 ).toFixed(2),
    cvr_cp:  +( safe(m.conv, m.clicks) * 100 ).toFixed(2),
    cvr_sp:  +( safe(m.conv, m.su) * 100 ).toFixed(2),
    ...m
  };
}
function ins5AggBy(rows, keyFn) {
  const map = {};
  rows.forEach(r => {
    const k = keyFn(r);
    if (!map[k]) map[k] = {spend:0,impr:0,clicks:0,su:0,conv:0,rev:0};
    const m = map[k];
    m.spend  += r.spend;
    m.impr   += r.impressions || 0;
    m.clicks += r.clicks;
    m.su     += r.signups     || 0;
    m.conv   += r.conversions || 0;
    m.rev    += r.convRevenue || 0;
  });
  return Object.entries(map).map(([key, m]) => ({ key, ...ins5Kpi(m) }));
}
function ins5PrevRange(from, to) {
  const d1 = new Date(from), d2 = new Date(to);
  const days = Math.round((d2 - d1) / 86400000) + 1;
  const pTo = new Date(d1); pTo.setDate(pTo.getDate() - 1);
  const pFrom = new Date(pTo); pFrom.setDate(pFrom.getDate() - days + 1);
  const fmt = d => d.toISOString().slice(0, 10);
  return { from: fmt(pFrom), to: fmt(pTo) };
}
function ins5FilterRows(from, to) {
  let rows = RAW_DATA.filter(d => d.date >= from && d.date <= to);
  if (INS5.selChannel !== 'ì „ì²´') rows = rows.filter(d => d.channelDisplay === INS5.selChannel);
  if (INS5.campFilter.trim() && INS5.selChannel !== 'ì „ì²´')
    rows = rows.filter(d => d.campaign.toLowerCase().includes(INS5.campFilter.toLowerCase()));
  return rows;
}

const ins5Fo  = n => Number(n).toLocaleString('ko-KR');
const ins5Fpd = (v, d=1) => `${Number(v).toFixed(d)}%`;
const ins5Pct = (a, b) => b ? ((a - b) / b * 100) : 0;
const ins5Sgn = v => v > 0 ? '+' : '';

/* â”€â”€ ë³€í™”ëŸ‰ HTML â”€â”€ */
function ins5ChgBadge(val, inv, absUnit) {
  if (val == null || isNaN(val)) return '';
  const isGood = inv ? val < 0 : val > 0;
  const isBad  = inv ? val > 0 : val < 0;
  const col = Math.abs(val) < 0.3 ? '#6b7394' : isGood ? '#34d399' : isBad ? '#f87171' : '#6b7394';
  const bg  = Math.abs(val) < 0.3 ? '#6b739415' : isGood ? '#34d39915' : '#f8717115';
  const arr = Math.abs(val) < 0.3 ? 'â€”' : val > 0 ? 'â†‘' : 'â†“';
  const num = absUnit
    ? `${Math.abs(val).toFixed(Number.isInteger(val) ? 0 : 1)}${absUnit}`
    : `${Math.abs(val).toFixed(1)}%`;
  return `<span style="font-size:9px;font-weight:700;color:${col};background:${bg};border-radius:4px;padding:1px 6px;font-family:monospace;margin-left:4px;white-space:nowrap;">${arr} ${num}</span>`;
}

/* â”€â”€ 4ì„¹ì…˜ ì¸ì‚¬ì´íŠ¸ ìƒì„± â”€â”€ */
function ins5GenSections(curRows, prevRows) {
  const isChView = INS5.selChannel === 'ì „ì²´';
  const cur  = ins5Kpi(ins5Sum(curRows));
  const prev = ins5Kpi(ins5Sum(prevRows));

  const curBrk  = ins5AggBy(curRows,  isChView ? r => r.channelDisplay : r => r.campaign);
  const prevBrk = ins5AggBy(prevRows, isChView ? r => r.channelDisplay : r => r.campaign);
  const prevMap = Object.fromEntries(prevBrk.map(x => [x.key, x]));
  const sorted  = [...curBrk].sort((a, b) => b.roas - a.roas);

  const spendChg  = ins5Pct(cur.spend, prev.spend);
  const roasChg   = cur.roas - prev.roas;
  const cpaChg    = cur.cpa  - prev.cpa;
  const convChg   = ins5Pct(cur.conv,  prev.conv);
  const imprChg   = ins5Pct(cur.impr,  prev.impr);
  const ctrChg    = cur.ctr   - prev.ctr;
  const cpmChg    = ins5Pct(cur.cpm,   prev.cpm);
  const svrChg    = cur.svr   - prev.svr;
  const cvr_spChg = cur.cvr_sp - prev.cvr_sp;
  const cvr_cpChg = cur.cvr_cp - prev.cvr_cp;

  /* ì„¹ì…˜ 1 */
  let s1txt = '';
  if      (spendChg > 3 && roasChg < -2)
    s1txt = `ê´‘ê³ ë¹„ê°€ ì „ê¸°ê°„ ëŒ€ë¹„ ${ins5Sgn(spendChg)}${spendChg.toFixed(1)}% ì¦ê°€í–ˆìœ¼ë‚˜ ROASëŠ” ${Math.abs(roasChg).toFixed(1)}%p í•˜ë½í–ˆìŠµë‹ˆë‹¤. ë¹„ìš© í™•ì¥ ì†ë„ì— ì „í™˜ íš¨ìœ¨ì´ ë”°ë¼ì˜¤ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤. CPAëŠ” ${ins5Sgn(cpaChg)}${ins5Fo(Math.round(cpaChg))}ì› ë³€ë™ëìŠµë‹ˆë‹¤.`;
  else if (spendChg > 3 && roasChg >= 2)
    s1txt = `ê´‘ê³ ë¹„ë¥¼ ${spendChg.toFixed(1)}% í™•ì¥í–ˆìŒì—ë„ ROASê°€ ${roasChg.toFixed(1)}%p ê°œì„ ëìŠµë‹ˆë‹¤. ì „í™˜ê±´ìˆ˜ ${ins5Sgn(convChg)}${convChg.toFixed(0)}%ë¡œ ì¶”ê°€ ì˜ˆì‚° í™•ëŒ€ ì—¬ì§€ê°€ ìˆëŠ” ìƒíƒœì…ë‹ˆë‹¤.`;
  else if (spendChg < -3 && roasChg > 2)
    s1txt = `ê´‘ê³ ë¹„ë¥¼ ${Math.abs(spendChg).toFixed(1)}% ì¤„ì´ë©´ì„œ ROASê°€ ${roasChg.toFixed(1)}%p ê°œì„ ëìŠµë‹ˆë‹¤. ë¹„íš¨ìœ¨ ì§‘í–‰ ì •ë¦¬ íš¨ê³¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`;
  else if (spendChg < -3 && roasChg < -2)
    s1txt = `ê´‘ê³ ë¹„ì™€ ROAS ëª¨ë‘ í•˜ë½í–ˆìŠµë‹ˆë‹¤. ì˜ˆì‚° ì¶•ì†Œì™€ í•¨ê»˜ ì „í™˜ í’ˆì§ˆë„ ë™ë°˜ ì €í•˜ëìŠµë‹ˆë‹¤. CPAëŠ” ${ins5Sgn(cpaChg)}${ins5Fo(Math.round(cpaChg))}ì› ë³€ë™ëìŠµë‹ˆë‹¤.`;
  else
    s1txt = `ê´‘ê³ ë¹„Â·íš¨ìœ¨ ëª¨ë‘ ì „ê¸°ê°„ê³¼ ìœ ì‚¬í•œ íë¦„ì…ë‹ˆë‹¤. ROAS ${cur.roas.toFixed(1)}%ë¡œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.`;

  const sec1 = {
    title:'ì „ì²´ ì§€í‘œ íë¦„', icon:'ğŸ“Š',
    type: roasChg < -2 ? 'negative' : roasChg > 2 ? 'positive' : 'neutral',
    summary: s1txt,
    metrics: [
      {label:'ê´‘ê³ ë¹„',   cur:ins5Fo(Math.round(cur.spend/10000))+'ë§Œì›', prev:ins5Fo(Math.round(prev.spend/10000))+'ë§Œì›', chg:spendChg,              inv:false},
      {label:'ì „í™˜ê±´ìˆ˜', cur:ins5Fo(cur.conv)+'ê±´',                       prev:ins5Fo(prev.conv)+'ê±´',                       chg:convChg,               inv:false},
      {label:'ROAS',     cur:ins5Fpd(cur.roas),                           prev:ins5Fpd(prev.roas),                           chg:roasChg, absUnit:'%p', inv:false},
      {label:'CPA',      cur:ins5Fo(cur.cpa)+'ì›',                        prev:ins5Fo(prev.cpa)+'ì›',                        chg:ins5Pct(cur.cpa,prev.cpa), inv:true},
    ],
  };

  /* ì„¹ì…˜ 2 */
  let s2txt = '';
  if      (imprChg > 5 && ctrChg < -0.05)
    s2txt = `ë…¸ì¶œëŸ‰ì´ ${imprChg.toFixed(0)}% ì¦ê°€í–ˆì§€ë§Œ CTRì€ ${Math.abs(ctrChg).toFixed(2)}%p í•˜ë½í–ˆìŠµë‹ˆë‹¤. íƒ€ê²Ÿ ì˜¤ë””ì–¸ìŠ¤ ê³¼ë‹¤ í™•ì¥ ë˜ëŠ” ì†Œì¬ í”¼ë¡œë„ ëˆ„ì ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. CPMì€ ${ins5Sgn(cpmChg)}${cpmChg.toFixed(0)}% ë³€ë™í–ˆìŠµë‹ˆë‹¤.`;
  else if (imprChg > 5 && cpmChg > 10)
    s2txt = `ë…¸ì¶œëŸ‰ì´ ${imprChg.toFixed(0)}% ëŠ˜ë©´ì„œ CPMë„ ${cpmChg.toFixed(0)}% ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤. ì…ì°° ê²½ìŸ ì‹¬í™” ë˜ëŠ” íƒ€ê²Ÿ í¬í™” êµ¬ê°„ ì§„ì… ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.`;
  else if (ctrChg > 0.05 && cpmChg < 3)
    s2txt = `CTRì´ ${ctrChg.toFixed(2)}%p ê°œì„ ë˜ë©´ì„œ CPMì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ëìŠµë‹ˆë‹¤. ì†Œì¬ ì í•©ë„ê°€ ë†’ì•„ì§„ ê¸ì •ì  ì‹ í˜¸ì…ë‹ˆë‹¤.`;
  else if (ctrChg < -0.05)
    s2txt = `CTRì´ ${Math.abs(ctrChg).toFixed(2)}%p í•˜ë½í–ˆìŠµë‹ˆë‹¤. ì†Œì¬ ë©”ì‹œì§€ì™€ íƒ€ê²Ÿ ë§¤ì¹­ ì €í•˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. ì†Œì¬ êµì²´ ë˜ëŠ” ì˜¤ë””ì–¸ìŠ¤ ì¬ì •ì˜ë¥¼ ê²€í† í•˜ì„¸ìš”.`;
  else
    s2txt = `ë…¸ì¶œÂ·í´ë¦­ ì§€í‘œëŠ” ì „ê¸°ê°„ê³¼ ìœ ì‚¬í•œ íë¦„ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;

  const sec2 = {
    title:'ë…¸ì¶œÂ·í´ë¦­ íš¨ìœ¨', icon:'ğŸ‘',
    type: (imprChg > 5 && ctrChg < -0.05) || ctrChg < -0.05 ? 'negative' : 'positive',
    summary: s2txt,
    metrics: [
      {label:'ë…¸ì¶œìˆ˜',  cur:ins5Fo(cur.impr),          prev:ins5Fo(prev.impr),          chg:imprChg,              inv:false},
      {label:'CPM',     cur:ins5Fo(cur.cpm)+'ì›',       prev:ins5Fo(prev.cpm)+'ì›',      chg:cpmChg,               inv:true},
      {label:'CPC',     cur:ins5Fo(cur.cpc)+'ì›',       prev:ins5Fo(prev.cpc)+'ì›',      chg:ins5Pct(cur.cpc,prev.cpc), inv:true},
      {label:'CTR',     cur:ins5Fpd(cur.ctr, 2),        prev:ins5Fpd(prev.ctr, 2),       chg:ctrChg, absUnit:'%p', inv:false},
    ],
  };

  /* ì„¹ì…˜ 3 */
  const drops = [
    {label:'í´ë¦­â†’ê°€ì…', d:svrChg},
    {label:'ê°€ì…â†’êµ¬ë§¤', d:cvr_spChg},
    {label:'í´ë¦­â†’êµ¬ë§¤', d:cvr_cpChg},
  ];
  const bigDrop = [...drops].sort((a,b) => a.d - b.d)[0];
  let s3txt = '';
  if (bigDrop.d < -0.3)
    s3txt = `ê°€ì¥ í° ì´íƒˆì€ ${bigDrop.label} êµ¬ê°„(${bigDrop.d.toFixed(2)}%p)ì—ì„œ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ${
      bigDrop.label === 'í´ë¦­â†’ê°€ì…'   ? 'ëœë”© í˜ì´ì§€ UX ë° ê°€ì… í¼ ë§ˆì°°ì„ ì ê²€í•˜ì„¸ìš”.' :
      bigDrop.label === 'ê°€ì…â†’êµ¬ë§¤'   ? 'ê°€ì… ì´í›„ ë¦¬ë§ˆì¼€íŒ… ë¡œì§ê³¼ ë„›ì§€ ë©”ì‹œì§€ë¥¼ ê°•í™”í•˜ì„¸ìš”.' :
                                        'ì „ì²´ ì „í™˜ íë¦„ì„ ì¢…í•©ì ìœ¼ë¡œ ì ê²€í•´ì•¼ í•©ë‹ˆë‹¤.'}`;
  else if (drops.every(d => d.d >= 0))
    s3txt = `ì „í™˜ í¼ë„ ì „ êµ¬ê°„ì´ ê°œì„ ëìŠµë‹ˆë‹¤. í´ë¦­â†’ê°€ì… ${ins5Sgn(svrChg)}${Math.abs(svrChg).toFixed(2)}%p, ê°€ì…â†’êµ¬ë§¤ ${ins5Sgn(cvr_spChg)}${Math.abs(cvr_spChg).toFixed(2)}%p. í˜„ì¬ ëœë”©Â·ì˜¨ë³´ë”© íë¦„ì„ ìœ ì§€í•˜ì„¸ìš”.`;
  else
    s3txt = `ì „í™˜ í¼ë„ì€ ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì…ë‹ˆë‹¤. ì†Œí­ ë³€ë™ì´ ìˆìœ¼ë‚˜ êµ¬ì¡°ì  ì´ìŠˆëŠ” ê°ì§€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`;

  const sec3 = {
    title:'ì „í™˜ í¼ë„', icon:'ğŸ”»',
    type: bigDrop.d < -0.5 ? 'negative' : bigDrop.d > 0.3 ? 'positive' : 'neutral',
    summary: s3txt,
    metrics: [
      {label:'í´ë¦­â†’ê°€ì…', cur:ins5Fpd(cur.svr,2),    prev:ins5Fpd(prev.svr,2),    chg:svrChg,    absUnit:'%p', inv:false},
      {label:'ê°€ì…â†’êµ¬ë§¤', cur:ins5Fpd(cur.cvr_sp,2),  prev:ins5Fpd(prev.cvr_sp,2), chg:cvr_spChg, absUnit:'%p', inv:false},
      {label:'í´ë¦­â†’êµ¬ë§¤', cur:ins5Fpd(cur.cvr_cp,2),  prev:ins5Fpd(prev.cvr_cp,2), chg:cvr_cpChg, absUnit:'%p', inv:false},
      {label:'CPA',       cur:ins5Fo(cur.cpa)+'ì›',    prev:ins5Fo(prev.cpa)+'ì›',  chg:ins5Pct(cur.cpa,prev.cpa), inv:true},
    ],
  };

  /* ì„¹ì…˜ 4 */
  const breakLabel = isChView ? 'ì±„ë„' : 'ìº í˜ì¸';
  const topItem    = sorted[0];
  const botItem    = sorted[sorted.length - 1];
  const nameOf     = k => isChView ? (INS5_CH_LABEL[k] || k) : k.replace(/\[.+?\]\s*/, '');

  const withPrev   = sorted.filter(x => prevMap[x.key]);
  const bigDropItem = withPrev.length > 0
    ? [...withPrev].sort((a,b) => (a.roas - (prevMap[a.key]?.roas||0)) - (b.roas - (prevMap[b.key]?.roas||0)))[0]
    : null;
  const bigDropVal  = bigDropItem ? bigDropItem.roas - (prevMap[bigDropItem.key]?.roas || 0) : 0;

  let s4txt = sorted.length > 0
    ? `${breakLabel}ë³„ ROASëŠ” ${nameOf(topItem.key)}(${ins5Fpd(topItem.roas)})ì´ ê°€ì¥ ë†’ê³ , ${nameOf(botItem.key)}(${ins5Fpd(botItem.roas)})ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤. `
    : '';
  if (bigDropItem && bigDropVal < -5)
    s4txt += `ì „ê¸°ê°„ ëŒ€ë¹„ ${nameOf(bigDropItem.key)}ì˜ íš¨ìœ¨ í•˜ë½ì´ ê°€ì¥ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤(${bigDropVal.toFixed(1)}%p). í•´ë‹¹ ${breakLabel}ì˜ ì†Œì¬Â·íƒ€ê²ŸÂ·ì…ì°° ì „ëµì„ ìš°ì„  ê²€í† í•˜ì„¸ìš”.`;
  else if (bigDropItem && bigDropVal > 5)
    s4txt += `ì „ê¸°ê°„ ëŒ€ë¹„ ${nameOf(bigDropItem.key)}ì˜ íš¨ìœ¨ì´ ${bigDropVal.toFixed(1)}%pë¡œ ê°€ì¥ í¬ê²Œ ê°œì„ ëìŠµë‹ˆë‹¤.`;

  const sec4 = {
    title:`${breakLabel}ë³„ ì„±ê³¼ ë¹„êµ`, icon:'ğŸ“‹',
    type: 'neutral',
    summary: s4txt,
    table: sorted.map((x, i) => ({
      ...x,
      prevRoas: prevMap[x.key]?.roas ?? null,
      label: nameOf(x.key),
      color: isChView ? (INS5_CH_COLOR[x.key] || INS5_CAMP_COLORS[i % INS5_CAMP_COLORS.length]) : INS5_CAMP_COLORS[i % INS5_CAMP_COLORS.length],
    })),
  };

  return [sec1, sec2, sec3, sec4];
}

/* â”€â”€ ì„¹ì…˜ HTML ë Œë” â”€â”€ */
function ins5SectionHTML(sec, open) {
  const typeColor = sec.type === 'positive' ? '#34d399' : sec.type === 'negative' ? '#f87171' : '#fbbf24';
  const typeLabel = sec.type === 'positive' ? 'ê°œì„ ' : sec.type === 'negative' ? 'ì£¼ì˜' : 'ì•ˆì •';
  const id = 'ins5sec_' + sec.title.replace(/\s/g,'_');

  const metricsHTML = sec.metrics ? `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:${sec.table?'12px':'0'};">
      ${sec.metrics.map(m => `
        <div style="padding:10px 12px;border-radius:9px;background:#181b24;border:1px solid #252a3a;">
          <div style="font-size:9px;color:#6b7394;margin-bottom:4px;font-weight:600;">${m.label}</div>
          <div style="font-size:14px;font-weight:700;color:#e2e5ef;font-family:monospace;letter-spacing:-.5px;margin-bottom:3px;">${m.cur}</div>
          <div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;">
            <span style="font-size:9px;color:#6b7394;">ì „ê¸°ê°„ ${m.prev}</span>
            ${ins5ChgBadge(m.chg, m.inv, m.absUnit)}
          </div>
        </div>`).join('')}
    </div>` : '';

  const tableHTML = sec.table ? `
    <div style="border-radius:8px;overflow:hidden;border:1px solid #252a3a;">
      <table style="width:100%;border-collapse:collapse;font-size:10px;">
        <thead>
          <tr style="background:#1c2030;">
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:left;white-space:nowrap;">ì´ë¦„</th>
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:right;white-space:nowrap;">ê´‘ê³ ë¹„</th>
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:right;white-space:nowrap;">ROAS</th>
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:right;white-space:nowrap;">CPA</th>
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:right;white-space:nowrap;">CTR</th>
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:right;white-space:nowrap;">í´ë¦­â†’ê°€ì…</th>
            <th style="padding:7px 10px;color:#6b7394;font-weight:600;font-size:9px;text-align:right;white-space:nowrap;">ê°€ì…â†’êµ¬ë§¤</th>
          </tr>
        </thead>
        <tbody>
          ${sec.table.map((row, i) => {
            const roasDiff = row.prevRoas != null ? row.roas - row.prevRoas : null;
            const roasCol  = row.roas >= 400 ? '#34d399' : row.roas >= 250 ? '#fbbf24' : '#f87171';
            return `<tr style="border-bottom:${i<sec.table.length-1?'1px solid #1c2030':'none'};background:${i%2===0?'transparent':'#181b2466'};">
              <td style="padding:8px 10px;">
                <div style="display:flex;align-items:center;gap:7px;">
                  <div style="width:7px;height:7px;border-radius:50%;background:${row.color};flex-shrink:0;"></div>
                  <span style="color:#e2e5ef;font-weight:600;max-width:160px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${row.label}</span>
                </div>
              </td>
              <td style="padding:8px 10px;text-align:right;font-family:monospace;color:#6b7394;">${ins5Fo(Math.round(row.spend/10000))}ë§Œ</td>
              <td style="padding:8px 10px;text-align:right;">
                <span style="font-family:monospace;font-weight:700;color:${roasCol};">${ins5Fpd(row.roas)}</span>
                ${roasDiff != null ? ins5ChgBadge(roasDiff, false, '%p') : ''}
              </td>
              <td style="padding:8px 10px;text-align:right;font-family:monospace;color:#6b7394;">${ins5Fo(row.cpa)}ì›</td>
              <td style="padding:8px 10px;text-align:right;font-family:monospace;color:#6b7394;">${ins5Fpd(row.ctr,2)}</td>
              <td style="padding:8px 10px;text-align:right;font-family:monospace;color:#6b7394;">${ins5Fpd(row.svr,2)}</td>
              <td style="padding:8px 10px;text-align:right;font-family:monospace;color:#6b7394;">${ins5Fpd(row.cvr_sp,2)}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>` : '';

  return `
  <div style="border-radius:12px;overflow:hidden;border:1px solid #252a3a;margin-bottom:8px;">
    <div onclick="ins5ToggleSec('${id}')" style="display:flex;align-items:center;justify-content:space-between;
      padding:11px 16px;background:#181b24;cursor:pointer;user-select:none;
      border-left:3px solid ${typeColor};">
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:13px;">${sec.icon}</span>
        <span style="font-size:12px;font-weight:700;color:#e2e5ef;">${sec.title}</span>
        <span style="font-size:9px;font-weight:700;color:${typeColor};background:${typeColor}18;border-radius:4px;padding:1px 7px;">${typeLabel}</span>
      </div>
      <span id="${id}_arrow" style="font-size:10px;color:#6b7394;transition:transform .2s;display:inline-block;transform:${open?'rotate(180deg)':'none'};">â–¼</span>
    </div>
    <div id="${id}_body" style="display:${open?'block':'none'};background:#13151cdd;border-top:1px solid #252a3a;padding:14px 16px;">
      ${sec.summary ? `<div style="font-size:12px;line-height:1.8;color:#e2e5ef;padding:10px 14px;border-radius:8px;background:${typeColor}08;border:1px solid ${typeColor}1a;margin-bottom:${(sec.metrics||sec.table)?'12px':'0'};">${sec.summary}</div>` : ''}
      ${metricsHTML}
      ${tableHTML}
    </div>
  </div>`;
}

function ins5ToggleSec(id) {
  const body  = document.getElementById(id + '_body');
  const arrow = document.getElementById(id + '_arrow');
  if (!body) return;
  const open = body.style.display === 'none';
  body.style.display  = open ? 'block' : 'none';
  arrow.style.transform = open ? 'rotate(180deg)' : 'none';
}

/* â”€â”€ ì°¨íŠ¸ ë Œë” (Canvas / Chart.js) â”€â”€ */
const INS5_METRIC_TABS = [
  {key:'roas',   label:'ROAS',      unit:'%',  color:'#34d399'},
  {key:'cpm',    label:'CPM',       unit:'ì›', color:'#94a3b8'},
  {key:'cpc',    label:'CPC',       unit:'ì›', color:'#38bdf8'},
  {key:'ctr',    label:'CTR',       unit:'%',  color:'#6c63ff'},
  {key:'cpa',    label:'CPA',       unit:'ì›', color:'#f87171'},
  {key:'svr',    label:'í´ë¦­â†’ê°€ì…', unit:'%',  color:'#fbbf24'},
  {key:'cvr_cp', label:'í´ë¦­â†’êµ¬ë§¤', unit:'%',  color:'#fb923c'},
  {key:'cvr_sp', label:'ê°€ì…â†’êµ¬ë§¤', unit:'%',  color:'#f472b6'},
];

let _ins5Chart = null;

function ins5RenderChart(rows) {
  const mk  = INS5.chartMetric;
  const mDef = INS5_METRIC_TABS.find(x => x.key === mk) || INS5_METRIC_TABS[0];
  const isChView = INS5.selChannel === 'ì „ì²´';

  // ë‚ ì§œ ëª©ë¡
  const dates = [...new Set(rows.map(r => r.date))].sort();

  // í‚¤(ì±„ë„/ìº í˜ì¸) ëª©ë¡
  const keyFn  = isChView ? r => r.channelDisplay : r => r.campaign;
  const keys   = [...new Set(rows.map(keyFn))];
  const colorOf = (k, i) => isChView
    ? (INS5_CH_COLOR[k] || INS5_CAMP_COLORS[i % INS5_CAMP_COLORS.length])
    : INS5_CAMP_COLORS[i % INS5_CAMP_COLORS.length];

  // ë‚ ì§œÃ—í‚¤ ì§‘ê³„
  const dateKeyMap = {};
  rows.forEach(r => {
    const k = keyFn(r);
    if (!dateKeyMap[r.date]) dateKeyMap[r.date] = {};
    if (!dateKeyMap[r.date][k]) dateKeyMap[r.date][k] = {spend:0,impr:0,clicks:0,su:0,conv:0,rev:0};
    const m = dateKeyMap[r.date][k];
    m.spend  += r.spend;
    m.impr   += r.impressions || 0;
    m.clicks += r.clicks;
    m.su     += r.signups     || 0;
    m.conv   += r.conversions || 0;
    m.rev    += r.convRevenue || 0;
  });

  // ê´‘ê³ ë¹„ í•©ì‚°(ë°°ê²½ìš©)
  const spendByDate = dates.map(d => {
    let s = 0;
    keys.forEach(k => { s += (dateKeyMap[d]?.[k]?.spend || 0); });
    return Math.round(s / 10000);
  });

  // ì§€í‘œ ë¼ì¸ datasets
  const lineDS = keys.map((k, i) => ({
    type: 'line',
    label: isChView ? (INS5_CH_LABEL[k] || k) : k.replace(/\[.+?\]\s*/, ''),
    data: dates.map(d => {
      const m = dateKeyMap[d]?.[k] || {spend:0,impr:0,clicks:0,su:0,conv:0,rev:0};
      return ins5Kpi(m)[mk];
    }),
    borderColor: colorOf(k, i),
    backgroundColor: colorOf(k, i) + '22',
    borderWidth: 2,
    pointRadius: 3,
    pointHoverRadius: 5,
    tension: 0.3,
    yAxisID: 'ym',
  }));

  const body = document.getElementById('ins-body');
  // íƒ­ HTML
  const tabsHTML = INS5_METRIC_TABS.map(t => {
    const on = t.key === mk;
    return `<button onclick="ins5SetChartMetric('${t.key}')"
      style="padding:8px 13px;border:none;background:transparent;cursor:pointer;font-family:inherit;font-size:10px;
      font-weight:${on?700:400};color:${on?t.color:'#6b7394'};white-space:nowrap;flex-shrink:0;
      border-bottom:2px solid ${on?t.color:'transparent'};transition:all .12s;">${t.label}</button>`;
  }).join('');

  body.innerHTML = `
    <div style="background:#181b24;border-radius:12px;border:1px solid #252a3a;overflow:hidden;">
      <div style="display:flex;overflow-x:auto;border-bottom:1px solid #252a3a;scrollbar-width:none;">
        ${tabsHTML}
      </div>
      <div style="padding:14px 14px 10px;">
        <div style="font-size:9px;color:#6b7394;margin-bottom:8px;">ë°°ê²½ ë§‰ëŒ€ = ê´‘ê³ ë¹„(ë§Œì›) Â· ì„  = ${mDef.label}(${mDef.unit})</div>
        <div style="position:relative;height:260px;">
          <canvas id="ins5-chart-canvas"></canvas>
        </div>
        <div id="ins5-legend" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;padding-left:4px;"></div>
      </div>
    </div>`;

  // ë²”ë¡€
  const legendEl = document.getElementById('ins5-legend');
  if (legendEl) {
    legendEl.innerHTML = keys.map((k, i) => `
      <div style="display:flex;align-items:center;gap:4px;">
        <div style="width:14px;height:2px;background:${colorOf(k,i)};border-radius:1px;"></div>
        <span style="font-size:9px;color:#6b7394;">${isChView?(INS5_CH_LABEL[k]||k):k.replace(/\[.+?\]\s*/,'')}</span>
      </div>`).join('');
  }

  // Chart.js
  if (_ins5Chart) { _ins5Chart.destroy(); _ins5Chart = null; }
  const ctx = document.getElementById('ins5-chart-canvas');
  if (!ctx || typeof Chart === 'undefined') return;
  _ins5Chart = new Chart(ctx, {
    data: {
      labels: dates.map(d => d.slice(5)),
      datasets: [
        {
          type: 'bar',
          label: 'ê´‘ê³ ë¹„(ë§Œì›)',
          data: spendByDate,
          backgroundColor: '#6c63ff0d',
          borderColor: '#6c63ff22',
          borderWidth: 1,
          yAxisID: 'ysp',
          order: 2,
        },
        ...lineDS.map(d => ({...d, order: 1})),
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#13151c',
          borderColor: '#252a3a', borderWidth: 1,
          titleColor: '#6b7394', bodyColor: '#e2e5ef',
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}${ctx.dataset.yAxisID==='ysp'?'ë§Œì›':mDef.unit}`,
          },
        },
      },
      scales: {
        x:   { grid: { color: '#1c2030' }, ticks: { color: '#6b7394', font: { size: 9 } } },
        ym:  { position: 'left',  grid: { color: '#1c2030' }, ticks: { color: '#6b7394', font: { size: 9 },
               callback: v => v + (mDef.unit.length <= 1 ? mDef.unit : '') } },
        ysp: { position: 'right', grid: { display: false }, ticks: { display: false } },
      },
    },
  });
}

function ins5SetChartMetric(mk) {
  INS5.chartMetric = mk;
  const rows = ins5FilterRows(INS5.from, INS5.to);
  ins5RenderChart(rows);
}

/* â”€â”€ ë©”ì¸ ë Œë” â”€â”€ */
function ins5Render() {
  const from = document.getElementById('ins-from')?.value;
  const to   = document.getElementById('ins-to')?.value;
  if (!from || !to || !RAW_DATA.length) return;

  INS5.from = from;
  INS5.to   = to;
  INS5.selChannel = document.getElementById('ins-sel-channel')?.value || 'ì „ì²´';
  INS5.campFilter = document.getElementById('ins-camp-filter')?.value || '';

  const prev = ins5PrevRange(from, to);
  const curRows  = ins5FilterRows(from, to);
  const prevRows = ins5FilterRows(prev.from, prev.to);

  // í—¤ë” ë°°ì§€ ì—…ë°ì´íŠ¸
  const badge = document.getElementById('ins-period-badge');
  if (badge) badge.textContent = `${from.slice(5)} ~ ${to.slice(5)} vs ì „ê¸°ê°„ ${prev.from.slice(5)} ~ ${prev.to.slice(5)}`;

  const chBadge = document.getElementById('ins-ch-badge');
  if (chBadge) {
    if (INS5.selChannel !== 'ì „ì²´') {
      const col = INS5_CH_COLOR[INS5.selChannel] || '#6c63ff';
      chBadge.textContent = (INS5_CH_LABEL[INS5.selChannel] || INS5.selChannel) + (INS5.campFilter ? ` Â· "${INS5.campFilter}"` : '');
      chBadge.style.display   = 'inline-flex';
      chBadge.style.color     = col;
      chBadge.style.background= col + '12';
      chBadge.style.border    = `1px solid ${col}25`;
    } else {
      chBadge.style.display = 'none';
    }
  }

  const body = document.getElementById('ins-body');
  if (!body) return;

  if (!curRows.length) {
    body.innerHTML = '<div style="color:#6b7394;font-size:12px;text-align:center;padding:60px 0;">ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  if (INS5.tab === 'chart') {
    ins5RenderChart(curRows);
    return;
  }

  // ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ ë Œë”
  const sections = ins5GenSections(curRows, prevRows);
  body.innerHTML = sections.map((sec, i) => ins5SectionHTML(sec, i < 3)).join('');
}

/* â”€â”€ ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ ì—´ê¸° â”€â”€ */
function showInsight() {
  const modal = document.getElementById('insight-modal');
  if (!modal) return;
  modal.style.display = 'flex';

  // ë‚ ì§œ ì´ˆê¸°ê°’ (ë©”ì¸ ëŒ€ì‹œë³´ë“œì™€ ë™ê¸°í™”)
  const mFrom = document.getElementById('date-from')?.value;
  const mTo   = document.getElementById('date-to')?.value;
  const insFrom = document.getElementById('ins-from');
  const insTo   = document.getElementById('ins-to');
  if (insFrom && !insFrom.value && mFrom) insFrom.value = mFrom;
  if (insTo   && !insTo.value   && mTo)   insTo.value   = mTo;

  // ì±„ë„ select ì±„ìš°ê¸° (ì²˜ìŒ ì—´ ë•Œ)
  const selCh = document.getElementById('ins-sel-channel');
  if (selCh && selCh.options.length <= 1 && typeof CHANNELS !== 'undefined') {
    CHANNELS.forEach(ch => {
      const opt = document.createElement('option');
      opt.value = ch; opt.textContent = INS5_CH_LABEL[ch] || ch;
      selCh.appendChild(opt);
    });
  }

  ins5Render();
}


// â”€â”€ í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ iCard í•¨ìˆ˜ ìœ ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


/* ================================================================
   KPI ì„¹ì…˜ ì•„ì½”ë””ì–¸ í† ê¸€
================================================================ */
function kpiToggle(id) {
  const body  = document.getElementById('kpi-body-' + id);
  const arrow = document.getElementById('kpi-arrow-' + id);
  if (!body) return;
  const open = body.style.display === 'none';
  body.style.display  = open ? (id === 'product' ? 'flex' : 'grid') : 'none';
  arrow.style.transform = open ? 'rotate(180deg)' : 'none';
}

/* ================================================================
   KPI ë¯¸ë‹ˆ ëª¨ë‹¬ (Chart.js ì‹œê³„ì—´)
================================================================ */

/* KPI ë©”íƒ€ ì •ì˜ â€” id ê¸°ì¤€ */
const KMM_META = {
  /* í”„ë¡œë•íŠ¸ */
  'pkv-total-revenue': { label:'ì´ ë§¤ì¶œ',         accent:'#fbbf24', isBar:false, fmt: v=>(v/100000000).toFixed(2)+'ì–µ',   field:'convRevenue' },
  'pkv-total-sales':   { label:'ì´ ê²°ì œê±´ìˆ˜',      accent:'#34d399', isBar:true,  fmt: v=>Math.round(v).toLocaleString()+'ê±´', field:'conversions' },
  'pkv-total-nights':  { label:'ì´ ê²°ì œë°•ìˆ˜',      accent:'#2dd4bf', isBar:true,  fmt: v=>Math.round(v).toLocaleString()+'ë°•', field:'convNights' },
  'pkv-aov':           { label:'ê°ë‹¨ê°€',           accent:'#a78bfa', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'aov' },
  'pkv-adr':           { label:'ADR',             accent:'#818cf8', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'adr' },
  'pkv-los':           { label:'LOS',             accent:'#38bdf8', isBar:false, fmt: v=>v.toFixed(1)+'ë°•',                   field:'los' },
  'pkv-leadtime':      { label:'í‰ê·  ë¦¬ë“œíƒ€ì„',    accent:'#f472b6', isBar:false, fmt: v=>v.toFixed(1)+'ì¼',                   field:'leadtime' },
  /* ë³¼ë¥¨ */
  'kv-spend':          { label:'ì´ ë¹„ìš©',          accent:'#ef4444', isBar:true,  fmt: v=>(v/10000).toFixed(0)+'ë§Œì›',         field:'spend' },
  'kv-impressions':    { label:'ë…¸ì¶œìˆ˜',           accent:'#818cf8', isBar:true,  fmt: v=>Math.round(v/1000).toLocaleString()+'K', field:'impressions' },
  'kv-clicks':         { label:'í´ë¦­ìˆ˜',           accent:'#38bdf8', isBar:true,  fmt: v=>Math.round(v).toLocaleString(),       field:'clicks' },
  'kv-signups':        { label:'íšŒì›ê°€ì…ìˆ˜',       accent:'#34d399', isBar:true,  fmt: v=>Math.round(v).toLocaleString()+'ëª…',  field:'signups' },
  'kv-detailviews':    { label:'ìƒì„¸í˜ì´ì§€ ì¡°íšŒ',  accent:'#2dd4bf', isBar:true,  fmt: v=>Math.round(v).toLocaleString()+'íšŒ',  field:'detailViews' },
  'kv-conversions':    { label:'êµ¬ë§¤ ì „í™˜',        accent:'#fbbf24', isBar:true,  fmt: v=>Math.round(v).toLocaleString()+'ê±´',  field:'conversions' },
  'kv-conv-revenue':   { label:'ì „í™˜ ë§¤ì¶œ',        accent:'#6c63ff', isBar:true,  fmt: v=>(v/10000).toFixed(0)+'ë§Œì›',         field:'convRevenue' },
  /* ë‹¨ê°€Â·íš¨ìœ¨ */
  'kv-cpm':  { label:'CPM',  accent:'#a78bfa', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'cpm' },
  'kv-cpc':  { label:'CPC',  accent:'#f472b6', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'cpc' },
  'kv-ctr':  { label:'CTR',  accent:'#38bdf8', isBar:false, fmt: v=>v.toFixed(2)+'%',                   field:'ctr' },
  'kv-cac':  { label:'CAC',  accent:'#34d399', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'cac' },
  'kv-cpa':  { label:'CPA',  accent:'#fbbf24', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'cpa' },
  'kv-cps':  { label:'CPS',  accent:'#fb923c', isBar:false, fmt: v=>Math.round(v).toLocaleString()+'ì›', field:'cps' },
  'kv-roas': { label:'ROAS', accent:'#22d3ee', isBar:false, fmt: v=>v.toFixed(1)+'%',                   field:'roas' },
  /* ì „í™˜ìœ¨ */
  'kv-signup-cvr':      { label:'í´ë¦­â†’ê°€ì…',     accent:'#6c63ff', isBar:false, fmt: v=>v.toFixed(2)+'%', field:'signupCvr' },
  'kv-purchase-cvr':    { label:'í´ë¦­â†’êµ¬ë§¤',     accent:'#34d399', isBar:false, fmt: v=>v.toFixed(2)+'%', field:'purchaseCvr' },
  'kv-post-signup-cvr': { label:'ê°€ì…â†’êµ¬ë§¤',     accent:'#f472b6', isBar:false, fmt: v=>v.toFixed(2)+'%', field:'postSignupCvr' },
  'kv-ad-spend-ratio':  { label:'ê´‘ê³ ë¹„/ì´ë§¤ì¶œ', accent:'#ef4444', isBar:false, fmt: v=>v.toFixed(1)+'%', field:'adSpendRatio' },
  'kv-ad-rev-ratio':    { label:'ê´‘ê³ ë§¤ì¶œ/ì´ë§¤ì¶œ',accent:'#a78bfa',isBar:false, fmt: v=>v.toFixed(1)+'%', field:'adRevRatio' },
};

let _kmmChart = null;

/* ì§‘ê³„ í—¬í¼ (ëª¨ë‹¬ ì „ìš© â€” ë‚ ì§œë³„) */
function kmmBuildTS() {
  const from    = document.getElementById('date-from')?.value || '';
  const to      = document.getElementById('date-to')?.value   || '';
  const channel = document.getElementById('sel-channel')?.value || 'ì „ì²´';
  const gran    = (() => {
    const active = document.querySelector('.gran-btn.active');
    return active ? active.dataset.gran : 'daily';
  })();

  let rows = RAW_DATA.filter(d => d.date >= from && d.date <= to);
  if (channel !== 'ì „ì²´') rows = rows.filter(d => d.channelDisplay === channel);

  /* ë‚ ì§œ í‚¤ */
  const keyOf = dateStr => {
    if (gran === 'daily')   return dateStr.slice(5);
    if (gran === 'weekly') {
      const d = new Date(dateStr), dow = d.getDay();
      const mon = new Date(d); mon.setDate(d.getDate() - ((dow + 6) % 7));
      return mon.toISOString().slice(5, 10) + 'W';
    }
    return dateStr.slice(0, 7);
  };

  const map = {};
  rows.forEach(r => {
    const k = keyOf(r.date);
    if (!map[k]) map[k] = { spend:0, impressions:0, clicks:0, signups:0, detailViews:0, conversions:0, convRevenue:0 };
    const m = map[k];
    m.spend       += r.spend;
    m.impressions += r.impressions || 0;
    m.clicks      += r.clicks;
    m.signups     += r.signups     || 0;
    m.detailViews += r.detailViews || 0;
    m.conversions += r.conversions || 0;
    m.convRevenue += r.convRevenue || 0;
  });

  const safe = (a,b) => b ? a / b : 0;
  return Object.entries(map).sort(([a],[b])=>a.localeCompare(b)).map(([key, m]) => ({
    key,
    spend:       m.spend,
    impressions: m.impressions,
    clicks:      m.clicks,
    signups:     m.signups,
    detailViews: m.detailViews,
    conversions: m.conversions,
    convRevenue: m.convRevenue,
    convNights:  m.conversions * 1.6,
    aov:         safe(m.convRevenue, m.conversions),
    adr:         safe(m.convRevenue, m.conversions * 1.6),
    los:         1.6,
    leadtime:    3.2,
    cpm:         safe(m.spend, m.impressions) * 1000,
    cpc:         safe(m.spend, m.clicks),
    ctr:         safe(m.clicks, m.impressions) * 100,
    cac:         safe(m.spend, m.signups),
    cpa:         safe(m.spend, m.detailViews),
    cps:         safe(m.spend, m.conversions),
    roas:        safe(m.convRevenue, m.spend) * 100,
    signupCvr:     safe(m.signups,     m.clicks) * 100,
    purchaseCvr:   safe(m.conversions, m.clicks) * 100,
    postSignupCvr: safe(m.conversions, m.signups) * 100,
    adSpendRatio:  safe(m.spend, m.convRevenue) * 100,
    adRevRatio:    safe(m.convRevenue, m.spend + m.convRevenue) * 100,
  }));
}

function kpiMiniOpen(kpiId) {
  const meta = KMM_META[kpiId];
  if (!meta || typeof RAW_DATA === 'undefined' || !RAW_DATA.length) return;

  const ts      = kmmBuildTS();
  const vals    = ts.map(r => r[meta.field] || 0);
  const avg     = vals.length ? vals.reduce((a,b)=>a+b,0) / vals.length : 0;
  const minVal  = vals.length ? Math.min(...vals) : 0;
  const maxVal  = vals.length ? Math.max(...vals) : 0;

  /* í—¤ë” ì—…ë°ì´íŠ¸ */
  const box = document.getElementById('kpi-mini-modal-box');
  box.style.setProperty('--kmm-accent', meta.accent);
  document.getElementById('kpi-mini-modal').querySelector('#kmm-header').style.borderLeftColor = meta.accent;
  document.getElementById('kmm-title').textContent = meta.label;

  const from    = document.getElementById('date-from')?.value  || '';
  const to      = document.getElementById('date-to')?.value    || '';
  const channel = document.getElementById('sel-channel')?.value || 'ì „ì²´';
  const gran    = document.querySelector('.gran-btn.active')?.dataset.gran || 'daily';
  document.getElementById('kmm-meta').textContent =
    `${from} ~ ${to}  Â·  ${gran==='daily'?'ì¼ë³„':gran==='weekly'?'ì£¼ë³„':'ì›”ë³„'}  Â·  ${channel === 'ì „ì²´' ? 'ì „ì²´ ì±„ë„' : channel}`;

  /* í†µê³„ */
  document.getElementById('kmm-min').textContent = meta.fmt(minVal);
  document.getElementById('kmm-avg').textContent = meta.fmt(avg);
  document.getElementById('kmm-max').textContent = meta.fmt(maxVal);
  document.getElementById('kmm-avg').style.color = meta.accent;

  /* Chart.js */
  if (_kmmChart) { _kmmChart.destroy(); _kmmChart = null; }
  const ctx = document.getElementById('kmm-canvas');
  const avgLine = ts.map(() => avg);

  const baseDataset = {
    data: vals,
    backgroundColor: meta.accent + 'aa',
    borderColor:     meta.accent,
    borderWidth: meta.isBar ? 0 : 2,
    borderRadius: meta.isBar ? 3 : 0,
    pointRadius: meta.isBar ? 0 : 3,
    pointHoverRadius: meta.isBar ? 0 : 5,
    tension: 0.3,
    fill: !meta.isBar,
    backgroundColor: meta.isBar ? meta.accent + '99' : meta.accent + '18',
  };

  _kmmChart = new Chart(ctx, {
    type: meta.isBar ? 'bar' : 'line',
    data: {
      labels: ts.map(r => r.key),
      datasets: [
        { ...baseDataset, label: meta.label, order: 1 },
        { type:'line', label:'í‰ê· ', data: avgLine,
          borderColor: meta.accent + '66', borderDash:[4,3],
          borderWidth:1.5, pointRadius:0, fill:false, order:0 },
      ],
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ display:false },
        tooltip:{
          backgroundColor:'#181b24', borderColor:'#1e2330', borderWidth:1,
          titleColor:'#5a6080', bodyColor:'#dde1ef',
          callbacks:{ label: c => c.datasetIndex===0 ? `${meta.label}: ${meta.fmt(c.parsed.y)}` : `í‰ê· : ${meta.fmt(c.parsed.y)}` }
        },
      },
      scales:{
        x:{ grid:{ color:'#1e2330' }, ticks:{ color:'#5a6080', font:{size:9} }, border:{ display:false } },
        y:{ grid:{ color:'#1e2330' }, ticks:{ color:'#5a6080', font:{size:9},
            callback: v => meta.fmt(v) }, border:{ display:false } },
      },
    },
  });

  document.getElementById('kpi-mini-modal').style.display = 'flex';
}

function kpiMiniClose() {
  document.getElementById('kpi-mini-modal').style.display = 'none';
  if (_kmmChart) { _kmmChart.destroy(); _kmmChart = null; }
}





/* ================================================================
   ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© ëª¨ë‹¬
================================================================ */

/* ëª©ë¡ UI ë Œë” */
function renderBrandCostList() {
  const list    = document.getElementById('bc-list');
  const count   = document.getElementById('bc-count');
  const summary = document.getElementById('bc-summary');

  if (!BRAND_COSTS.length) {
    list.innerHTML = '<div style="color:#555b66;font-size:12px;">ë“±ë¡ëœ í•­ëª©ì´ ì—†ì–´ìš”.</div>';
    count.textContent = '';
    summary.textContent = '';
    return;
  }

  const total = BRAND_COSTS.reduce((s, bc) => s + bc.totalCost, 0);
  count.textContent = `(${BRAND_COSTS.length}ê±´)`;
  summary.textContent = `ì´ ë“±ë¡ ë¹„ìš©: ${Number(total).toLocaleString()}ì›`;

  list.innerHTML = BRAND_COSTS.map((bc, i) => {
    const days = Math.round((new Date(bc.to) - new Date(bc.from)) / 86400000) + 1;
    const daily = Math.round(bc.totalCost / days);
    return `
    <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;
                background:${i%2===0?'#13151a':'#1a1d24'};border-radius:8px;margin-bottom:4px;">
      <div style="flex:1;">
        <div style="font-size:11px;color:#a78bfa;font-weight:700;margin-bottom:3px;">
          ğŸ¯ ${bc.campaign}
        </div>
        <div style="font-size:12px;color:#e1e4ea;font-weight:600;">
          ${bc.from} ~ ${bc.to}
          <span style="font-size:10px;color:#555b66;margin-left:6px;">(${days}ì¼)</span>
        </div>
        <div style="font-size:11px;color:#fbbf24;margin-top:2px;">
          ì´ ${Number(bc.totalCost).toLocaleString()}ì›
          <span style="color:#555b66;margin-left:6px;">Â· ì¼ ${Number(daily).toLocaleString()}ì›</span>
        </div>
      </div>
      <button onclick="deleteBrandCost(${i})"
        style="background:none;border:1px solid #ef444433;color:#ef4444;border-radius:6px;
               padding:4px 10px;font-size:11px;cursor:pointer;font-family:inherit;">
        ì‚­ì œ
      </button>
    </div>`;
  }).join('');
}

/* í•­ëª© ì¶”ê°€ */
function addBrandCost() {
  const campaign = document.getElementById('bc-campaign').value.trim();
  const from     = document.getElementById('bc-from').value;
  const to       = document.getElementById('bc-to').value;
  const costStr  = document.getElementById('bc-cost').value;
  const errEl    = document.getElementById('bc-error');
  errEl.style.display = 'none';

  if (!campaign)           { errEl.textContent = 'ìº í˜ì¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errEl.style.display='block'; return; }
  if (!from || !to)        { errEl.textContent = 'ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errEl.style.display='block'; return; }
  if (from > to)           { errEl.textContent = 'ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ì–´ìš”.'; errEl.style.display='block'; return; }
  if (!costStr || +costStr <= 0) { errEl.textContent = 'ì´ë¹„ìš©ì„ 1ì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errEl.style.display='block'; return; }

  BRAND_COSTS.push({ id: Date.now(), campaign, from, to, totalCost: Number(costStr) });
  // ìº í˜ì¸ â†’ ì‹œì‘ì¼ ê¸°ì¤€ ì •ë ¬
  BRAND_COSTS.sort((a, b) => a.campaign.localeCompare(b.campaign) || a.from.localeCompare(b.from));
  saveBrandCosts();
  renderBrandCostList();

  // ì…ë ¥ ì´ˆê¸°í™” (ìº í˜ì¸ëª…ì€ ìœ ì§€ â€” ê°™ì€ ìº í˜ì¸ìœ¼ë¡œ ì—¬ëŸ¬ ê¸°ê°„ ì¶”ê°€ í¸ì˜)
  document.getElementById('bc-from').value  = '';
  document.getElementById('bc-to').value    = '';
  document.getElementById('bc-cost').value  = '';
}

/* í•­ëª© ì‚­ì œ */
function deleteBrandCost(idx) {
  BRAND_COSTS.splice(idx, 1);
  saveBrandCosts();
  renderBrandCostList();
}

/* ëª¨ë‹¬ ì—´ê¸° */
function openBrandCostModal() {
  renderBrandCostList();
  // ë‚ ì§œ ê¸°ë³¸ê°’: ëŒ€ì‹œë³´ë“œ í˜„ì¬ ê¸°ê°„
  if (!document.getElementById('bc-from').value) document.getElementById('bc-from').value = DATE_FROM;
  if (!document.getElementById('bc-to').value)   document.getElementById('bc-to').value   = DATE_TO;
  document.getElementById('brand-cost-modal').style.display = 'flex';
}

/* ëª¨ë‹¬ ë‹«ê¸° */
function closeBrandCostModal() {
  document.getElementById('brand-cost-modal').style.display = 'none';
}

/* ë°˜ì˜ ë²„íŠ¼ â†’ ëª¨ë‹¬ ë‹«ê³  ëŒ€ì‹œë³´ë“œ ì¬ë Œë” */
function applyBrandCost() {
  closeBrandCostModal();
  render();
}

/* â”€â”€ ê³µí†µ ì°¨íŠ¸ ìœ í‹¸ â”€â”€ */

function makePeriodMap(data, dateField, gran, aggregator) {
  const map = {};
  data.forEach(d => {
    const pk = buildPeriodKey(d[dateField] || d.date, gran);
    if (!map[pk]) map[pk] = aggregator.init();
    aggregator.merge(map[pk], d);
  });
  return Object.entries(map)
    .sort(([a],[b]) => a.localeCompare(b))
    .map(([k, v]) => ({ period: k, label: buildPeriodLabel(k, gran), ...aggregator.compute(v) }));
}

/* ================================================================
   íƒ­ ì „í™˜ ë¡œì§
================================================================ */
function switchMainTab(tab) {
  ACTIVE_TAB = tab;
  document.querySelectorAll('.main-tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tab);
  });
  document.querySelectorAll('.tab-section').forEach(s => { s.style.display = 'none'; });
  const target = document.getElementById('tab-' + tab);
  if (target) target.style.display = 'block';

  if (tab === 'product') renderProductTab();
}

function switchMktSub(sub) {
  MKT_SUB = sub;
  document.querySelectorAll('.mkt-sub-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.sub === sub);
  });
  document.querySelectorAll('.subtab-section').forEach(s => { s.style.display = 'none'; });
  const target = document.getElementById('subtab-' + sub);
  if (target) target.style.display = 'block';

  // 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ í‘œì‹œ/ìˆ¨ê¹€ + ë‚´ìš© ê°±ì‹ 
  const chanNav = document.getElementById('chan-nav');
  if (sub === 'perf') {
    chanNav.style.display = 'flex';
    updateChanNav('perf');
  } else if (sub === 'crm') {
    chanNav.style.display = 'flex';
    updateChanNav('crm');
  } else {
    chanNav.style.display = 'none';
  }

  if (sub === 'total')     renderTotal();
  else if (sub === 'crm')  renderCrm();
  else if (sub === 'perf') render();
}

// â”€â”€ 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ êµ¬ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateChanNav(type) {
  const nav = document.getElementById('chan-nav');
  if (!nav) return;
  const label  = document.getElementById('chan-nav-label');
  const chans  = type === 'perf' ? PERF_CHANNELS : CRM_CHANNELS;
  const active = type === 'perf' ? PERF_CHAN      : CRM_CHAN;

  if (label) label.textContent = type === 'perf' ? 'ğŸ“£ ë§¤ì²´' : 'ğŸ’¬ ì±„ë„';

  // ê¸°ì¡´ ë²„íŠ¼ ì œê±° (label ì œì™¸)
  nav.querySelectorAll('.chan-btn').forEach(b => b.remove());

  // ì „ì²´ ë²„íŠ¼
  const allBtn = document.createElement('button');
  allBtn.className = 'chan-btn' + (active === 'ì „ì²´' ? ' active' : '');
  allBtn.textContent = 'ì „ì²´';
  allBtn.onclick = () => switchChan(type, 'ì „ì²´');
  nav.appendChild(allBtn);

  // ì±„ë„ë³„ ë²„íŠ¼
  chans.forEach(ch => {
    const btn = document.createElement('button');
    btn.className = 'chan-btn' + (active === ch ? ' active' : '');
    btn.textContent = ch;
    btn.onclick = () => switchChan(type, ch);
    nav.appendChild(btn);
  });
}

// â”€â”€ 3ë‹¨ê³„ ì±„ë„ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchChan(type, ch) {
  if (type === 'perf') {
    PERF_CHAN = ch;
    // ctrl-barì˜ ì±„ë„ ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
    const sel = document.getElementById('sel-channel');
    if (sel) sel.value = ch === 'ì „ì²´' ? 'ì „ì²´' : (CHANNELS.includes(ch) ? ch : 'ì „ì²´');
    updateChanNav('perf');
    render();
  } else {
    CRM_CHAN = ch;
    const sel = document.getElementById('crm-sel-channel');
    if (sel) sel.value = ch === 'ì „ì²´' ? 'ì „ì²´' : (CRM_CHANS.includes(ch) ? ch : 'ì „ì²´');
    updateChanNav('crm');
    renderCrm();
  }
}

/* ================================================================
   TOTAL íƒ­ ë Œë”
================================================================ */
function renderTotal() {
  const from = document.getElementById('date-from')?.value || DATE_FROM;
  const to   = document.getElementById('date-to')?.value   || DATE_TO;
  const gran = GRAN_TOTAL;

  const set = (id, v) => { const el=document.getElementById(id); if(el) el.textContent=v; };

  // â”€â”€ â‘  í”„ë¡œë•íŠ¸ ì§€í‘œ ê³ ì • ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (PRODUCT_DATA.length > 0) {
    const pf = PRODUCT_DATA.filter(d => d.date >= from && d.date <= to);
    const ps = pf.reduce((a, d) => {
      a.totalRevenue += d.totalRevenue; a.totalSales += d.totalSales; a.totalNights += d.totalNights;
      if (d.leadTime > 0) { a.leadTimeSum += d.leadTime; a.leadTimeCnt++; }
      return a;
    }, { totalRevenue:0, totalSales:0, totalNights:0, leadTimeSum:0, leadTimeCnt:0 });
    const days = pf.length || 1;
    set('tot-pkv-total-revenue', fo(ps.totalRevenue));
    set('tot-pkv-rev-sub',       `ì¼í‰ê·  ${fo(Math.round(ps.totalRevenue / days))}ì›`);
    set('tot-pkv-total-sales',   fo(ps.totalSales));
    set('tot-pkv-sales-sub',     `ì¼í‰ê·  ${+(ps.totalSales/days).toFixed(1)}ê±´`);
    set('tot-pkv-total-nights',  fo(ps.totalNights));
    set('tot-pkv-aov',           fo(ps.totalSales ? Math.round(ps.totalRevenue / ps.totalSales) : 0));
    set('tot-pkv-adr',           fo(ps.totalNights ? Math.round(ps.totalRevenue / ps.totalNights) : 0));
    set('tot-pkv-los',           ps.totalSales ? (ps.totalNights / ps.totalSales).toFixed(2) : '-');
    set('tot-pkv-leadtime',      ps.leadTimeCnt ? (ps.leadTimeSum / ps.leadTimeCnt).toFixed(1) : '-');
  }

  // â”€â”€ â‘¡ í¼í¬ë¨¼ìŠ¤ ë°ì´í„° ì§‘ê³„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const pRows = RAW_DATA.filter(d => d.date >= from && d.date <= to);
  const pTot  = { spend:0, convRevenue:0, conversions:0 };
  pRows.forEach(d => { pTot.spend+=d.spend; pTot.convRevenue+=d.convRevenue; pTot.conversions+=d.conversions; });

  // CRM ë°ì´í„° ì§‘ê³„
  const cRows = CRM_DATA.filter(d => d.date >= from && d.date <= to);
  const cTot  = { spend:0, revenue:0, converted:0, sent:0, opened:0, clicked:0 };
  cRows.forEach(d => {
    cTot.spend+=d.spend; cTot.revenue+=d.revenue; cTot.converted+=d.converted;
    cTot.sent+=d.sent;   cTot.opened+=d.opened;   cTot.clicked+=d.clicked;
  });

  const totalSpend = pTot.spend + cTot.spend;
  const totalRev   = pTot.convRevenue + cTot.revenue;
  const totalConv  = pTot.conversions + cTot.converted;

  // KPI ì—…ë°ì´íŠ¸
  set('tot-spend',       fo(Math.round(totalSpend)));
  set('tot-rev',         fo(Math.round(totalRev)));
  set('tot-conv',        fo(totalConv));
  set('tot-roas',        totalSpend ? Math.round(totalRev/totalSpend*100) : '-');
  set('tot-cpa',         totalConv  ? fo(Math.round(totalSpend/totalConv)) : '-');
  set('tot-spend-sub',   `í¼í¬ë¨¼ìŠ¤ ${fo(Math.round(pTot.spend))} + CRM ${fo(Math.round(cTot.spend))}`);
  set('tot-rev-sub',     `í¼í¬ë¨¼ìŠ¤ ${fo(Math.round(pTot.convRevenue))} + CRM ${fo(Math.round(cTot.revenue))}`);
  set('tot-conv-sub',    `í¼í¬ë¨¼ìŠ¤ ${fo(pTot.conversions)} + CRM ${fo(cTot.converted)}`);
  set('tot-p-spend',     fo(Math.round(pTot.spend)));
  set('tot-c-spend',     fo(Math.round(cTot.spend)));
  set('tot-p-rev',       fo(Math.round(pTot.convRevenue)));
  set('tot-c-rev',       fo(Math.round(cTot.revenue)));
  set('tot-p-spend-share', totalSpend ? `ì „ì²´ ë¹„ìš©ì˜ ${(pTot.spend/totalSpend*100).toFixed(1)}%` : '-');
  set('tot-c-spend-share', totalSpend ? `ì „ì²´ ë¹„ìš©ì˜ ${(cTot.spend/totalSpend*100).toFixed(1)}%` : '-');
  set('tot-p-rev-share', totalRev ? `ì „ì²´ ë§¤ì¶œì˜ ${(pTot.convRevenue/totalRev*100).toFixed(1)}%` : '-');
  set('tot-c-rev-share', totalRev ? `ì „ì²´ ë§¤ì¶œì˜ ${(cTot.revenue/totalRev*100).toFixed(1)}%` : '-');

  // â”€â”€ CRM ì±„ë„ ì§€í‘œ KPI (TOTAL íƒ­ ì „ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const cSafe = (a, b) => b ? (a / b * 100).toFixed(1) : '-';
  set('tot-crm-sent',      fo(cTot.sent));
  set('tot-crm-opened',    fo(cTot.opened));
  set('tot-crm-clicked',   fo(cTot.clicked));
  set('tot-crm-converted', fo(cTot.converted));
  set('tot-crm-revenue',   fo(Math.round(cTot.revenue)));
  set('tot-crm-open-rate',  `ì—´ëŒìœ¨ ${cSafe(cTot.opened, cTot.sent)}%`);
  set('tot-crm-click-rate', `í´ë¦­ìœ¨ ${cSafe(cTot.clicked, cTot.opened)}%`);
  set('tot-crm-conv-rate',  `ì „í™˜ìœ¨ ${cSafe(cTot.converted, cTot.clicked)}%`);

  // ë„ë„› ì°¨íŠ¸ â€” ë¹„ìš© ë¹„ì¤‘
  mkChart('chart-tot-spend-share', 'doughnut', {
    labels: ['í¼í¬ë¨¼ìŠ¤', 'CRM'],
    datasets: [{ data: [pTot.spend, cTot.spend], backgroundColor: ['#6c63ff', '#34d399'], borderWidth: 0, hoverOffset: 6 }]
  }, { ...CHART_DEFAULTS, scales:{}, plugins:{ legend:{ position:'bottom', labels:{ color:'#6c7280', font:{size:10} } } } });

  // ë„ë„› ì°¨íŠ¸ â€” ë§¤ì¶œ ë¹„ì¤‘
  mkChart('chart-tot-rev-share', 'doughnut', {
    labels: ['í¼í¬ë¨¼ìŠ¤', 'CRM'],
    datasets: [{ data: [pTot.convRevenue, cTot.revenue], backgroundColor: ['#a78bfa', '#38bdf8'], borderWidth: 0, hoverOffset: 6 }]
  }, { ...CHART_DEFAULTS, scales:{}, plugins:{ legend:{ position:'bottom', labels:{ color:'#6c7280', font:{size:10} } } } });

  // ê¸°ê°„ë³„ ë°ì´í„° êµ¬ì„±
  const periodMap = {};
  const aggPeriod = (pk, key, val) => {
    if (!periodMap[pk]) periodMap[pk] = {perfSpend:0,perfRev:0,crmSpend:0,crmRev:0};
    periodMap[pk][key] += val;
  };
  pRows.forEach(d => {
    const pk = buildPeriodKey(d.date, gran);
    aggPeriod(pk, 'perfSpend', d.spend); aggPeriod(pk, 'perfRev', d.convRevenue);
  });
  cRows.forEach(d => {
    const pk = buildPeriodKey(d.date, gran);
    aggPeriod(pk, 'crmSpend', d.spend); aggPeriod(pk, 'crmRev', d.revenue);
  });
  const periods = Object.keys(periodMap).sort();
  const labels  = periods.map(p => buildPeriodLabel(p, gran));
  const pSpends = periods.map(p => periodMap[p].perfSpend);
  const cSpends = periods.map(p => periodMap[p].crmSpend);
  const pRevs   = periods.map(p => periodMap[p].perfRev);
  const cRevs   = periods.map(p => periodMap[p].crmRev);
  const roasArr = periods.map(p => {
    const s = periodMap[p].perfSpend + periodMap[p].crmSpend;
    const r = periodMap[p].perfRev   + periodMap[p].crmRev;
    return s ? Math.round(r/s*100) : 0;
  });

  const gran_lbl = gran==='daily'?'ì¼ë³„':gran==='weekly'?'ì£¼ë³„':'ì›”ë³„';
  document.getElementById('ct-tot-roas').textContent     = `${gran_lbl} í†µí•© ROAS ì¶”ì´`;
  document.getElementById('ct-tot-spend-stack').textContent = `${gran_lbl} ë¹„ìš© ì¶”ì´`;
  document.getElementById('ct-tot-rev-stack').textContent   = `${gran_lbl} ì „í™˜ë§¤ì¶œ ì¶”ì´`;

  // ROAS ë¼ì¸ ì°¨íŠ¸
  mkChart('chart-tot-roas', 'line', {
    labels, datasets: [{ label:'ROAS', data: roasArr, borderColor:'#f472b6', backgroundColor:'#f472b622', borderWidth:2.5, tension:0.3, fill:true, pointRadius:gran==='daily'?0:3 }]
  }, { ...CHART_DEFAULTS, plugins:{...CHART_DEFAULTS.plugins}, scales:{...CHART_DEFAULTS.scales, y:{...CHART_DEFAULTS.scales.y, ticks:{...CHART_DEFAULTS.scales.y.ticks, callback:v=>v+'%'}}} });

  // ë¹„ìš© ìŠ¤íƒ ë°”
  mkChart('chart-tot-spend-stack', 'bar', {
    labels,
    datasets: [
      { label:'í¼í¬ë¨¼ìŠ¤ ë¹„ìš©', data: pSpends, backgroundColor:'#6c63ffcc', stack:'a' },
      { label:'CRM ë¹„ìš©',     data: cSpends, backgroundColor:'#34d399cc', stack:'a' }
    ]
  }, { ...CHART_DEFAULTS, scales:{...CHART_DEFAULTS.scales, y:{...CHART_DEFAULTS.scales.y, stacked:true, ticks:{...CHART_DEFAULTS.scales.y.ticks, callback:v=>fo(v)}}, x:{...CHART_DEFAULTS.scales.x, stacked:true}} });

  // ë§¤ì¶œ ìŠ¤íƒ ë°”
  mkChart('chart-tot-rev-stack', 'bar', {
    labels,
    datasets: [
      { label:'í¼í¬ë¨¼ìŠ¤ ë§¤ì¶œ', data: pRevs, backgroundColor:'#a78bfacc', stack:'a' },
      { label:'CRM ë§¤ì¶œ',     data: cRevs, backgroundColor:'#38bdf8cc', stack:'a' }
    ]
  }, { ...CHART_DEFAULTS, scales:{...CHART_DEFAULTS.scales, y:{...CHART_DEFAULTS.scales.y, stacked:true, ticks:{...CHART_DEFAULTS.scales.y.ticks, callback:v=>fo(v)}}, x:{...CHART_DEFAULTS.scales.x, stacked:true}} });

  // ì „ì²´ ì±„ë„ í…Œì´ë¸” (í¼í¬ë¨¼ìŠ¤ + CRM í•©ì‚°)
  const chMap = {};
  pRows.forEach(d => {
    if (!chMap[d.channelDisplay]) chMap[d.channelDisplay] = {channel:d.channelDisplay,type:'í¼í¬ë¨¼ìŠ¤',spend:0,revenue:0,conversions:0};
    chMap[d.channelDisplay].spend+=d.spend; chMap[d.channelDisplay].revenue+=d.convRevenue; chMap[d.channelDisplay].conversions+=d.conversions;
  });
  cRows.forEach(d => {
    if (!chMap[d.channel]) chMap[d.channel] = {channel:d.channel,type:'CRM',spend:0,revenue:0,conversions:0};
    chMap[d.channel].spend+=d.spend; chMap[d.channel].revenue+=d.revenue; chMap[d.channel].conversions+=d.converted;
  });
  const chData = Object.values(chMap).map(d=>({...d,roas:d.spend?(d.revenue/d.spend*100).toFixed(0):'0',cpa:d.conversions?Math.round(d.spend/d.conversions):0})).sort((a,b)=>b.spend-a.spend);

  const thead = document.getElementById('tot-table-head');
  const tbody = document.getElementById('tot-table-body');
  if (!thead || !tbody) return;
  thead.innerHTML = `<tr>${['ì±„ë„','ìœ í˜•','ë¹„ìš©','ì „í™˜ë§¤ì¶œ','ì „í™˜','CPA','ROAS'].map(h=>`<th>${h}</th>`).join('')}</tr>`;
  tbody.innerHTML = chData.map((d,i) => `<tr class="${i%2===0?'':'alt'}">
    <td>${d.channel}</td>
    <td><span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:${d.type==='í¼í¬ë¨¼ìŠ¤'?'#6c63ff22':'#34d39922'};color:${d.type==='í¼í¬ë¨¼ìŠ¤'?'#a78bfa':'#34d399'}">${d.type}</span></td>
    <td class="r">${fo(Math.round(d.spend))}ì›</td>
    <td class="r">${fo(Math.round(d.revenue))}ì›</td>
    <td class="r">${fo(d.conversions)}</td>
    <td class="r">${fo(d.cpa)}ì›</td>
    <td class="r">${d.roas}%</td>
  </tr>`).join('');
}

/* ================================================================
   CRM íƒ­ ë Œë”
================================================================ */
function renderCrm() {
  const from     = document.getElementById('crm-date-from')?.value || document.getElementById('date-from')?.value || DATE_FROM;
  const to       = document.getElementById('crm-date-to')?.value   || document.getElementById('date-to')?.value   || DATE_TO;
  const gran     = GRAN_CRM;
  // 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ ìš°ì„ , ì—†ìœ¼ë©´ ë“œë¡­ë‹¤ìš´ ì‚¬ìš©
  const chFilter = CRM_CHAN !== 'ì „ì²´' ? CRM_CHAN : (document.getElementById('crm-sel-channel')?.value || 'ì „ì²´');

  const set  = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };

  // â”€â”€ í”„ë¡œë•íŠ¸ ì§€í‘œ ê³ ì • ë Œë” (ê¸°ê°„ í•„í„° ì ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (PRODUCT_DATA.length > 0) {
    const pf = PRODUCT_DATA.filter(d => d.date >= from && d.date <= to);
    const ps = pf.reduce((a, d) => {
      a.totalRevenue += d.totalRevenue; a.totalSales += d.totalSales; a.totalNights += d.totalNights;
      if (d.leadTime > 0) { a.leadTimeSum += d.leadTime; a.leadTimeCnt++; }
      return a;
    }, { totalRevenue:0, totalSales:0, totalNights:0, leadTimeSum:0, leadTimeCnt:0 });
    const days = pf.length || 1;
    set('crm-pkv-revenue',  fo(ps.totalRevenue));
    set('crm-pkv-rev-sub',  `ì¼í‰ê·  ${fo(Math.round(ps.totalRevenue / days))}ì›`);
    set('crm-pkv-sales',    fo(ps.totalSales));
    set('crm-pkv-nights',   fo(ps.totalNights));
    set('crm-pkv-aov',      fo(ps.totalSales ? Math.round(ps.totalRevenue / ps.totalSales) : 0));
    set('crm-pkv-adr',      fo(ps.totalNights ? Math.round(ps.totalRevenue / ps.totalNights) : 0));
    set('crm-pkv-los',      ps.totalSales ? (ps.totalNights / ps.totalSales).toFixed(2) : '-');
    set('crm-pkv-leadtime', ps.leadTimeCnt ? (ps.leadTimeSum / ps.leadTimeCnt).toFixed(1) : '-');
  }

  const rows = CRM_DATA.filter(d =>
    d.date >= from && d.date <= to &&
    (chFilter === 'ì „ì²´' || d.channel === chFilter)
  );

  // â”€â”€ KPI í•©ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tot = { sent:0, opened:0, clicked:0, installs:0, detailViews:0, signups:0, converted:0, revenue:0, spend:0 };
  rows.forEach(d => {
    tot.sent        += d.sent;
    tot.opened      += d.opened;
    tot.clicked     += d.clicked;
    tot.installs    += d.installs;
    tot.detailViews += d.detailViews;
    tot.signups     += d.signups;
    tot.converted   += d.converted;
    tot.revenue     += d.revenue;
    tot.spend       += d.spend;
  });

  const safe = (a, b) => b ? (a / b * 100).toFixed(1) : '-';

  // 1í–‰ KPI
  set('crm-sent',         fo(tot.sent));
  set('crm-sent-sub',     rows.length ? `${fo(Math.round(tot.sent / rows.length))} ì¼í‰ê· ` : '-');
  set('crm-open-rate',    safe(tot.opened,    tot.sent));
  set('crm-opened-count', `${fo(tot.opened)}ê±´ ì—´ëŒ`);
  set('crm-click-rate',   safe(tot.clicked,   tot.opened));
  set('crm-clicked-count',`${fo(tot.clicked)}ê±´ í´ë¦­`);
  set('crm-conv-rate',    safe(tot.converted, tot.clicked));
  set('crm-conv-count',   `${fo(tot.converted)}ê±´ ì „í™˜`);
  set('crm-roas',         tot.spend ? Math.round(tot.revenue / tot.spend * 100) : '-');

  // 2í–‰ KPI
  set('crm-installs',      fo(tot.installs));
  set('crm-install-rate',  `ì„¤ì¹˜ìœ¨ ${safe(tot.installs, tot.clicked)}%`);
  set('crm-detail-views',  fo(tot.detailViews));
  set('crm-detail-rate',   `ì¡°íšŒìœ¨ ${safe(tot.detailViews, tot.clicked)}%`);
  set('crm-signups',       fo(tot.signups));
  set('crm-signup-rate',   `ê°€ì…ìœ¨ ${safe(tot.signups, tot.clicked)}%`);
  set('crm-revenue',       fo(Math.round(tot.revenue)));
  set('crm-spend',         fo(Math.round(tot.spend)));

  // â”€â”€ ì „í™˜ í¼ë„ (ë°œì†¡â†’ì—´ëŒâ†’í´ë¦­â†’ì„¤ì¹˜â†’ìƒì„¸ì¡°íšŒâ†’ê°€ì…â†’ì „í™˜) â”€â”€â”€â”€â”€â”€â”€â”€
  const funnel = [
    { stage:'ë°œì†¡',     value:tot.sent,        color:'#6c63ff' },
    { stage:'ì—´ëŒ',     value:tot.opened,      color:'#38bdf8' },
    { stage:'í´ë¦­',     value:tot.clicked,     color:'#34d399' },
    { stage:'ì„¤ì¹˜',     value:tot.installs,    color:'#2dd4bf' },
    { stage:'ìƒì„¸ì¡°íšŒ', value:tot.detailViews, color:'#818cf8' },
    { stage:'ê°€ì…',     value:tot.signups,     color:'#fb923c' },
    { stage:'ì „í™˜',     value:tot.converted,   color:'#fbbf24' },
  ].filter(f => f.value > 0 || f.stage === 'ë°œì†¡');  // 0ì´ì–´ë„ ë°œì†¡ì€ í•­ìƒ í‘œì‹œ

  const maxF    = funnel[0].value || 1;
  const funnelWrap = document.getElementById('crm-funnel-wrap');
  if (funnelWrap) {
    funnelWrap.innerHTML = funnel.map((fl, i) => {
      const prevVal = i > 0 ? funnel[i - 1].value : null;
      const stepPct = prevVal != null
        ? `<span style="font-size:10px;color:${fl.color};font-weight:700;margin-left:6px;">${(fl.value / (prevVal || 1) * 100).toFixed(1)}%</span>`
        : '';
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;">
        <div style="width:40px;font-size:9px;color:#8a8f98;font-weight:700;text-align:right;letter-spacing:.3px;">${fl.stage}</div>
        <div style="flex:1;height:22px;background:#1e2128;border-radius:5px;overflow:hidden;position:relative;">
          <div style="width:${Math.max(fl.value / maxF * 100, 0.5)}%;height:100%;background:${fl.color}99;border-radius:5px;transition:width .3s;"></div>
          <span style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:11px;font-weight:600;color:#e1e4ea;">${fo(fl.value)}</span>
        </div>${stepPct}
      </div>`;
    }).join('');
  }

  // â”€â”€ ê¸°ê°„ë³„ ì§‘ê³„ (ì°¨íŠ¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const periodMap = {};
  rows.forEach(d => {
    const pk = buildPeriodKey(d.date, gran);
    if (!periodMap[pk]) periodMap[pk] = { revenue:0, spend:0, sent:0, converted:0 };
    periodMap[pk].revenue   += d.revenue;
    periodMap[pk].spend     += d.spend;
    periodMap[pk].sent      += d.sent;
    periodMap[pk].converted += d.converted;
  });
  const periods  = Object.keys(periodMap).sort();
  const labels   = periods.map(p => buildPeriodLabel(p, gran));
  const gran_lbl = gran === 'daily' ? 'ì¼ë³„' : gran === 'weekly' ? 'ì£¼ë³„' : 'ì›”ë³„';

  document.getElementById('ct-crm-rev').textContent = `${gran_lbl} CRM ë§¤ì¶œ`;

  mkChart('chart-crm-rev', 'bar', {
    labels,
    datasets: [{ label:'CRM ë§¤ì¶œ', data: periods.map(p => periodMap[p].revenue), backgroundColor:'#f472b699', borderRadius:4 }]
  }, { ...CHART_DEFAULTS, scales:{ ...CHART_DEFAULTS.scales, y:{ ...CHART_DEFAULTS.scales.y, ticks:{ ...CHART_DEFAULTS.scales.y.ticks, callback: v => fo(v) } } } });

  // â”€â”€ ì±„ë„ë³„ ë§¤ì¶œ ì ìœ ìœ¨ ë„ë„› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const chMap = {};
  rows.forEach(d => {
    if (!chMap[d.channel]) chMap[d.channel] = { channel:d.channel, sent:0, opened:0, clicked:0, installs:0, detailViews:0, signups:0, converted:0, revenue:0, spend:0 };
    const m = chMap[d.channel];
    m.sent        += d.sent;      m.opened      += d.opened;
    m.clicked     += d.clicked;   m.installs    += d.installs;
    m.detailViews += d.detailViews; m.signups   += d.signups;
    m.converted   += d.converted; m.revenue     += d.revenue;
    m.spend       += d.spend;
  });
  const chData   = Object.values(chMap).sort((a, b) => b.revenue - a.revenue);
  const chColors = ['#34d399','#38bdf8','#fbbf24','#f472b6','#a78bfa','#fb923c','#6c63ff'];

  mkChart('chart-crm-share', 'doughnut', {
    labels: chData.map(d => d.channel),
    datasets: [{ data: chData.map(d => d.revenue), backgroundColor: chColors.slice(0, chData.length), borderWidth:0, hoverOffset:6 }]
  }, { ...CHART_DEFAULTS, scales:{}, plugins:{ legend:{ position:'bottom', labels:{ color:'#6c7280', font:{size:10} } } } });

  // â”€â”€ ì±„ë„ë³„ ìƒì„¸ í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const thead = document.getElementById('crm-table-head');
  const tbody = document.getElementById('crm-table-body');
  if (!thead || !tbody) return;

  const totalRev = chData.reduce((s, d) => s + d.revenue, 0);
  thead.innerHTML = `<tr>${['ì±„ë„','ë°œì†¡','ì—´ëŒìœ¨','í´ë¦­ìœ¨','ì„¤ì¹˜','ìƒì„¸ì¡°íšŒ','ê°€ì…','ì „í™˜','ì „í™˜ìœ¨','ë¹„ìš©','ë§¤ì¶œ','ROAS'].map(h => `<th>${h}</th>`).join('')}</tr>`;
  tbody.innerHTML = chData.map((d, i) => {
    const openR  = d.sent     ? (d.opened    / d.sent     * 100).toFixed(1) : '0';
    const clickR = d.opened   ? (d.clicked   / d.opened   * 100).toFixed(1) : '0';
    const convR  = d.clicked  ? (d.converted / d.clicked  * 100).toFixed(2) : '0';
    const roas   = d.spend    ? Math.round(d.revenue / d.spend * 100)        : 0;
    return `<tr class="${i % 2 === 0 ? '' : 'alt'}">
      <td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${chColors[i % chColors.length]};margin-right:6px;"></span>${d.channel}</td>
      <td class="r">${fo(d.sent)}</td>
      <td class="r">${openR}%</td>
      <td class="r">${clickR}%</td>
      <td class="r">${fo(d.installs)}</td>
      <td class="r">${fo(d.detailViews)}</td>
      <td class="r">${fo(d.signups)}</td>
      <td class="r">${fo(d.converted)}</td>
      <td class="r">${convR}%</td>
      <td class="r">${fo(Math.round(d.spend))}ì›</td>
      <td class="r">${fo(Math.round(d.revenue))}ì›</td>
      <td class="r">${roas}%</td>
    </tr>`;
  }).join('');
}

/* ================================================================
   í”„ë¡œë•íŠ¸ íƒ­ ë Œë”
================================================================ */
function renderProductTab() {
  if (!HOTEL_DATA.length) return;

  const from     = document.getElementById('prod-date-from')?.value || DATE_FROM;
  const to       = document.getElementById('prod-date-to')?.value   || DATE_TO;
  const gran     = GRAN_PROD;
  const region   = document.getElementById('prod-sel-region')?.value  || 'ì „ì²´';
  const branch   = document.getElementById('prod-sel-branch')?.value  || 'ì „ì²´';
  const brand    = document.getElementById('prod-sel-brand')?.value   || 'ì „ì²´';
  const roomType = document.getElementById('prod-sel-room')?.value    || 'ì „ì²´';

  const filtered = HOTEL_DATA.filter(d =>
    d.date >= from && d.date <= to &&
    (region   === 'ì „ì²´' || d.region   === region)   &&
    (branch   === 'ì „ì²´' || d.branch   === branch)   &&
    (brand    === 'ì „ì²´' || d.brand    === brand)    &&
    (roomType === 'ì „ì²´' || d.roomType === roomType)
  );

  if (!filtered.length) {
    const el = document.getElementById('hotel-status');
    if (el) el.textContent = 'Â· í•´ë‹¹ ê¸°ê°„/ì¡°ê±´ ë°ì´í„° ì—†ìŒ';
    return;
  }

  const granLbl = gran==='daily'?'ì¼ë³„':gran==='weekly'?'ì£¼ë³„':'ì›”ë³„';
  const set = (id, v) => { const el=document.getElementById(id); if(el) el.textContent=v; };

  // KPI ì§‘ê³„
  let totRev=0,totBk=0,totNt=0,ltWsum=0,ltWcnt=0,totCancel=0,totSold=0,totAvail=0;
  filtered.forEach(d => {
    totRev    += d.revenue;  totBk += d.bookings; totNt += d.nights;
    totCancel += d.cancel;   totSold += d.sold;   totAvail += d.avail;
    if (d.leadTime > 0 && d.bookings > 0) { ltWsum += d.leadTime*d.bookings; ltWcnt += d.bookings; }
  });
  const uniqDates  = new Set(filtered.map(d=>d.date)).size || 1;
  const aov        = totBk    ? Math.round(totRev/totBk)            : 0;
  const adr        = totNt    ? Math.round(totRev/totNt)            : 0;
  const los        = totBk    ? (totNt/totBk).toFixed(2)            : '0';
  const occ        = totAvail ? (totSold/totAvail*100).toFixed(1)   : '0';
  const revpar     = totAvail ? Math.round(totRev/totAvail)         : 0;
  const cancelRate = totBk    ? (totCancel/totBk*100).toFixed(1)    : '0';
  const avgLt      = ltWcnt   ? (ltWsum/ltWcnt).toFixed(1)          : '-';

  set('hkv-revenue',     fo(Math.round(totRev)));
  set('hkv-revenue-sub', 'ì¼í‰ê·  '+fo(Math.round(totRev/uniqDates))+'ì›');
  set('hkv-bookings',    fo(totBk));
  set('hkv-bookings-sub','ì¼í‰ê·  '+(totBk/uniqDates).toFixed(1)+'ê±´');
  set('hkv-nights',      fo(totNt));
  set('hkv-nights-sub',  'ì¼í‰ê·  '+(totNt/uniqDates).toFixed(1)+'ë°•');
  set('hkv-leadtime',    avgLt);
  set('hkv-aov',         fo(aov));
  set('hkv-adr',         fo(adr));
  set('hkv-los',         los);
  set('hkv-occ',         occ);
  set('hkv-occ-sub',     fo(totSold)+' / '+fo(totAvail)+'ì‹¤');
  set('hkv-revpar',      fo(revpar));
  set('hkv-cancel',      cancelRate);
  set('hkv-cancel-sub',  fo(totCancel)+'ê±´ ì·¨ì†Œ');

  // ê¸°ê°„ë³„ ì‹œê³„ì—´
  const periodMap = {};
  filtered.forEach(d => {
    const pk = periodKey(d.date, gran);
    if (!periodMap[pk]) periodMap[pk] = {rev:0,bk:0,nt:0};
    periodMap[pk].rev += d.revenue;
    periodMap[pk].bk  += d.bookings;
    periodMap[pk].nt  += d.nights;
  });
  const periods = Object.keys(periodMap).sort();
  const plabels = periods.map(p => periodLabel(p, gran));

  set('ct-hotel-ts', granLbl+' ë§¤ì¶œ + ì˜ˆì•½ê±´ìˆ˜ ì¶”ì´');

  mkChart('chart-hotel-ts', 'bar', {
    labels: plabels,
    datasets: [
      { type:'line', label:'ë§¤ì¶œ', data: periods.map(p=>periodMap[p].rev),
        borderColor:'#6c63ff', backgroundColor:'#6c63ff22', fill:true,
        borderWidth:2.5, tension:0.3, pointRadius:gran==='daily'?0:3, yAxisID:'yL' },
      { type:'bar', label:'ì˜ˆì•½ê±´ìˆ˜', data: periods.map(p=>periodMap[p].bk),
        backgroundColor:'#38bdf866', borderRadius:4, yAxisID:'yR' }
    ]
  }, { ...CHART_DEFAULTS, scales:{
    x:  { ticks:{color:'#6c7280',font:{size:9},maxTicksLimit:12}, grid:{color:'#1e2128'} },
    yL: { position:'left',  ticks:{color:'#6c7280',font:{size:10},callback:v=>fo(v)}, grid:{color:'#1e2128'} },
    yR: { position:'right', ticks:{color:'#38bdf8',font:{size:10},callback:v=>fo(v)}, grid:{display:false} }
  }});

  // ì‹œì¦Œë³„
  const seasonMap = {};
  filtered.forEach(d => {
    const s = SEASONS_MAP[d.date.slice(5,7)] || 'ê¸°íƒ€';
    if (!seasonMap[s]) seasonMap[s] = {rev:0,bk:0,nt:0};
    seasonMap[s].rev += d.revenue; seasonMap[s].bk += d.bookings; seasonMap[s].nt += d.nights;
  });
  const seasonsHere = SEASON_ORDER.filter(s => seasonMap[s]);
  mkChart('chart-hotel-season', 'bar', {
    labels: seasonsHere.map(s => SEASON_LABELS_MAP[s]||s),
    datasets: [{ label:'ë§¤ì¶œ', data: seasonsHere.map(s=>seasonMap[s].rev),
      backgroundColor: seasonsHere.map(s=>SEASON_COLORS_MAP[s]||'#888'), borderRadius:8 }]
  }, { ...CHART_DEFAULTS,
    plugins: { ...CHART_DEFAULTS.plugins, legend:{display:false} },
    scales:  { ...CHART_DEFAULTS.scales, y:{...CHART_DEFAULTS.scales.y,ticks:{...CHART_DEFAULTS.scales.y.ticks,callback:v=>fo(v)}} }
  });

  // íŒŒì´ ì°¨íŠ¸ í—¬í¼
  const makePie = (canvasId, keyFn) => {
    const grp = {};
    filtered.forEach(d => { const k=keyFn(d); grp[k]=(grp[k]||0)+d.revenue; });
    const sorted = Object.entries(grp).sort((a,b)=>b[1]-a[1]);
    const total  = sorted.reduce((s,[,v])=>s+v,0);
    mkChart(canvasId, 'doughnut', {
      labels: sorted.map(([k])=>k),
      datasets:[{ data:sorted.map(([,v])=>v), backgroundColor:HOTEL_COLORS.slice(0,sorted.length), borderWidth:0, hoverOffset:8 }]
    }, { ...CHART_DEFAULTS, scales:{},
      plugins:{ legend:{position:'bottom',labels:{color:'#6c7280',font:{size:10},boxWidth:10}},
        tooltip:{callbacks:{label:ctx=>{
          const pct=total?(ctx.raw/total*100).toFixed(1):'0';
          return ' '+ctx.label+': '+fo(Math.round(ctx.raw))+'ì› ('+pct+'%)';
        }}}
      }
    });
  };
  makePie('chart-hotel-pie-region', d=>d.region);
  makePie('chart-hotel-pie-brand',  d=>d.brand);
  makePie('chart-hotel-pie-room',   d=>d.roomType);

  // ì§€ì—­â†’ì§€ì  ìˆ˜í‰ 100% ìŠ¤íƒë°”
  const regionsHere  = [...new Set(filtered.map(d=>d.region))].sort();
  const branchesHere = [...new Set(filtered.map(d=>d.branch))].sort();
  const regBrMap = {};
  filtered.forEach(d => {
    if (!regBrMap[d.region]) regBrMap[d.region] = {};
    regBrMap[d.region][d.branch] = (regBrMap[d.region][d.branch]||0)+d.revenue;
  });
  const regTotal = {};
  regionsHere.forEach(r => { regTotal[r]=Object.values(regBrMap[r]||{}).reduce((s,v)=>s+v,0); });
  mkChart('chart-hotel-region-branch', 'bar', {
    labels: regionsHere,
    datasets: branchesHere.map((br,i)=>({
      label:br,
      data:regionsHere.map(r=>{ const v=regBrMap[r]?.[br]||0; return regTotal[r]?+(v/regTotal[r]*100).toFixed(1):0; }),
      backgroundColor:HOTEL_COLORS[i%HOTEL_COLORS.length], stack:'a'
    }))
  }, { ...CHART_DEFAULTS, indexAxis:'y',
    scales:{
      x:{stacked:true,max:100,grid:{color:'#1e2128'},ticks:{color:'#6c7280',font:{size:10},callback:v=>v+'%'}},
      y:{stacked:true,grid:{display:false},ticks:{color:'#c9cdd5',font:{size:10}}}
    },
    plugins:{...CHART_DEFAULTS.plugins,tooltip:{callbacks:{label:ctx=>' '+ctx.dataset.label+': '+ctx.raw+'%'}}}
  });

  // ì§€ì â†’ê°ì‹¤íƒ€ì… ìˆ˜í‰ 100% ìŠ¤íƒë°”
  const roomsHere = [...new Set(filtered.map(d=>d.roomType))].sort();
  const brRoomMap = {};
  filtered.forEach(d => {
    if (!brRoomMap[d.branch]) brRoomMap[d.branch] = {};
    brRoomMap[d.branch][d.roomType] = (brRoomMap[d.branch][d.roomType]||0)+d.revenue;
  });
  const brTotal = {};
  branchesHere.forEach(br => { brTotal[br]=Object.values(brRoomMap[br]||{}).reduce((s,v)=>s+v,0); });
  mkChart('chart-hotel-branch-room', 'bar', {
    labels: branchesHere,
    datasets: roomsHere.map((rm,i)=>({
      label:rm,
      data:branchesHere.map(br=>{ const v=brRoomMap[br]?.[rm]||0; return brTotal[br]?+(v/brTotal[br]*100).toFixed(1):0; }),
      backgroundColor:HOTEL_COLORS[(i+4)%HOTEL_COLORS.length], stack:'a'
    }))
  }, { ...CHART_DEFAULTS, indexAxis:'y',
    scales:{
      x:{stacked:true,max:100,grid:{color:'#1e2128'},ticks:{color:'#6c7280',font:{size:10},callback:v=>v+'%'}},
      y:{stacked:true,grid:{display:false},ticks:{color:'#c9cdd5',font:{size:10}}}
    },
    plugins:{...CHART_DEFAULTS.plugins,tooltip:{callbacks:{label:ctx=>' '+ctx.dataset.label+': '+ctx.raw+'%'}}}
  });

  // ì§€ì—­ë³„ ì‹œê³„ì—´ (ê°ë‹¨ê°€ / ADR)
  const regTSMap = {};
  filtered.forEach(d => {
    const pk = periodKey(d.date, gran);
    if (!regTSMap[pk]) regTSMap[pk] = {};
    if (!regTSMap[pk][d.region]) regTSMap[pk][d.region] = {rev:0,bk:0,nt:0};
    regTSMap[pk][d.region].rev+=d.revenue; regTSMap[pk][d.region].bk+=d.bookings; regTSMap[pk][d.region].nt+=d.nights;
  });
  set('ct-hotel-region-aov', 'ì§€ì—­ë³„ ê°ë‹¨ê°€ ì¶”ì´ ('+granLbl+')');
  set('ct-hotel-region-adr', 'ì§€ì—­ë³„ ADR ì¶”ì´ ('+granLbl+')');
  mkChart('chart-hotel-region-aov', 'line', {
    labels:plabels,
    datasets:regionsHere.map((r,i)=>({
      label:r, borderColor:HOTEL_COLORS[i%HOTEL_COLORS.length],
      borderWidth:2, tension:0.3, pointRadius:gran==='daily'?0:3, spanGaps:true,
      data:periods.map(pk=>{ const m=regTSMap[pk]?.[r]; return m&&m.bk?Math.round(m.rev/m.bk):null; })
    }))
  }, {...CHART_DEFAULTS, scales:{x:CHART_DEFAULTS.scales.x,
    y:{...CHART_DEFAULTS.scales.y,ticks:{...CHART_DEFAULTS.scales.y.ticks,callback:v=>fo(v)}}}});
  mkChart('chart-hotel-region-adr', 'line', {
    labels:plabels,
    datasets:regionsHere.map((r,i)=>({
      label:r, borderColor:HOTEL_COLORS[i%HOTEL_COLORS.length],
      borderDash:i%2===0?[]:[5,3], borderWidth:2, tension:0.3, pointRadius:gran==='daily'?0:3, spanGaps:true,
      data:periods.map(pk=>{ const m=regTSMap[pk]?.[r]; return m&&m.nt?Math.round(m.rev/m.nt):null; })
    }))
  }, {...CHART_DEFAULTS, scales:{x:CHART_DEFAULTS.scales.x,
    y:{...CHART_DEFAULTS.scales.y,ticks:{...CHART_DEFAULTS.scales.y.ticks,callback:v=>fo(v)}}}});

  // ì§€ì ë³„ ì‹œê³„ì—´ (ê°ë‹¨ê°€ / ADR)
  const brTSMap = {};
  filtered.forEach(d => {
    const pk = periodKey(d.date, gran);
    if (!brTSMap[pk]) brTSMap[pk] = {};
    if (!brTSMap[pk][d.branch]) brTSMap[pk][d.branch] = {rev:0,bk:0,nt:0};
    brTSMap[pk][d.branch].rev+=d.revenue; brTSMap[pk][d.branch].bk+=d.bookings; brTSMap[pk][d.branch].nt+=d.nights;
  });
  set('ct-hotel-branch-aov', 'ì§€ì ë³„ ê°ë‹¨ê°€ ì¶”ì´ ('+granLbl+')');
  set('ct-hotel-branch-adr', 'ì§€ì ë³„ ADR ì¶”ì´ ('+granLbl+')');
  mkChart('chart-hotel-branch-aov', 'line', {
    labels:plabels,
    datasets:branchesHere.map((br,i)=>({
      label:br, borderColor:HOTEL_COLORS[i%HOTEL_COLORS.length],
      borderWidth:1.5, tension:0.3, pointRadius:gran==='daily'?0:3, spanGaps:true,
      data:periods.map(pk=>{ const m=brTSMap[pk]?.[br]; return m&&m.bk?Math.round(m.rev/m.bk):null; })
    }))
  }, {...CHART_DEFAULTS, scales:{x:CHART_DEFAULTS.scales.x,
    y:{...CHART_DEFAULTS.scales.y,ticks:{...CHART_DEFAULTS.scales.y.ticks,callback:v=>fo(v)}}}});
  mkChart('chart-hotel-branch-adr', 'line', {
    labels:plabels,
    datasets:branchesHere.map((br,i)=>({
      label:br, borderColor:HOTEL_COLORS[i%HOTEL_COLORS.length],
      borderWidth:1.5, tension:0.3, pointRadius:gran==='daily'?0:3, spanGaps:true,
      data:periods.map(pk=>{ const m=brTSMap[pk]?.[br]; return m&&m.nt?Math.round(m.rev/m.nt):null; })
    }))
  }, {...CHART_DEFAULTS, scales:{x:CHART_DEFAULTS.scales.x,
    y:{...CHART_DEFAULTS.scales.y,ticks:{...CHART_DEFAULTS.scales.y.ticks,callback:v=>fo(v)}}}});

  // ì§€ì ë³„ ë­í‚¹ í…Œì´ë¸”
  const brRankMap = {};
  filtered.forEach(d => {
    if (!brRankMap[d.branch]) brRankMap[d.branch]={branch:d.branch,region:d.region,rev:0,bk:0,nt:0,cancel:0,sold:0,avail:0};
    const m=brRankMap[d.branch];
    m.rev+=d.revenue; m.bk+=d.bookings; m.nt+=d.nights; m.cancel+=d.cancel; m.sold+=d.sold; m.avail+=d.avail;
  });
  const brRank = Object.values(brRankMap).map(m=>({
    ...m,
    aov:m.bk?Math.round(m.rev/m.bk):0, adr:m.nt?Math.round(m.rev/m.nt):0,
    los:m.bk?(m.nt/m.bk).toFixed(2):'0', occ:m.avail?(m.sold/m.avail*100).toFixed(1):'0',
    revpar:m.avail?Math.round(m.rev/m.avail):0, cancelRate:m.bk?(m.cancel/m.bk*100).toFixed(1):'0'
  })).sort((a,b)=>b.rev-a.rev);
  const rh=document.getElementById('hotel-branch-rank-head');
  const rb=document.getElementById('hotel-branch-rank-body');
  if(rh) rh.innerHTML='<tr>'+['#','ì§€ì ','ì§€ì—­','ë§¤ì¶œ','ì˜ˆì•½','OCC','RevPAR','ê°ë‹¨ê°€','ADR','LOS','ì·¨ì†Œìœ¨'].map(h=>'<th>'+h+'</th>').join('')+'</tr>';
  if(rb) rb.innerHTML=brRank.map((d,i)=>'<tr class="'+(i%2?'alt':'')+'"><td style="text-align:center">'+(i+1)+'</td><td>'+d.branch+'</td><td>'+d.region+'</td><td class="r">'+fo(Math.round(d.rev))+'ì›</td><td class="r">'+fo(d.bk)+'</td><td class="r" style="color:'+getOccColor(d.occ)+';font-weight:600">'+d.occ+'%</td><td class="r">'+fo(d.revpar)+'ì›</td><td class="r">'+fo(d.aov)+'ì›</td><td class="r">'+fo(d.adr)+'ì›</td><td class="r">'+d.los+'ë°•</td><td class="r">'+d.cancelRate+'%</td></tr>').join('');

  // ì‹œì¦Œë³„ í…Œì´ë¸”
  const sb=document.getElementById('hotel-season-body');
  if(sb) sb.innerHTML=SEASON_ORDER.filter(s=>seasonMap[s]).map((s,i)=>{
    const m=seasonMap[s];
    return '<tr class="'+(i%2?'alt':'')+'"><td>'+(SEASON_LABELS_MAP[s]||s)+'</td><td class="r">'+fo(Math.round(m.rev))+'ì›</td><td class="r">'+fo(m.bk)+'</td><td class="r">'+(m.bk?fo(Math.round(m.rev/m.bk))+'ì›':'-')+'</td><td class="r">'+(m.nt?fo(Math.round(m.rev/m.nt))+'ì›':'-')+'</td><td class="r">'+(m.bk?(m.nt/m.bk).toFixed(2)+'ë°•':'-')+'</td></tr>';
  }).join('');

  // ê¸°ê°„ë³„ í…Œì´ë¸”
  const ph=document.getElementById('hotel-period-head');
  const pb=document.getElementById('hotel-period-body');
  const colHdr=gran==='daily'?'ë‚ ì§œ':gran==='weekly'?'ì£¼ì°¨':'ì›”';
  set('hotel-period-title', granLbl+' ìƒì„¸');
  if(ph) ph.innerHTML='<tr>'+[colHdr,'ë§¤ì¶œ','ì˜ˆì•½','ë°•ìˆ˜','ê°ë‹¨ê°€','ADR','LOS'].map(h=>'<th>'+h+'</th>').join('')+'</tr>';
  if(pb) pb.innerHTML=periods.map((pk,i)=>{
    const m=periodMap[pk];
    return '<tr class="'+(i%2?'alt':'')+'"><td>'+plabels[i]+'</td><td class="r">'+fo(Math.round(m.rev))+'ì›</td><td class="r">'+fo(m.bk)+'</td><td class="r">'+fo(m.nt)+'</td><td class="r">'+(m.bk?fo(Math.round(m.rev/m.bk))+'ì›':'-')+'</td><td class="r">'+(m.nt?fo(Math.round(m.rev/m.nt))+'ì›':'-')+'</td><td class="r">'+(m.bk?(m.nt/m.bk).toFixed(2)+'ë°•':'-')+'</td></tr>';
  }).join('');
}

// â”€â”€ iCard: ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ HTML ìƒì„± í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function iCard(title, desc, accent, val) {
  return `<div class="insight-card" style="--accent:${accent}">
    <div class="ic-title">${title}</div>
    <div class="ic-desc">${desc}</div>
    ${val ? `<div class="ic-val">${val}</div>` : ''}
  </div>`;
}


/* ================================================================
   ì´ˆê¸°í™” + ì´ë²¤íŠ¸ ë°”ì¸ë”©
================================================================ */

// ================================================================
//  Supabase ì—°ê²° ì„¤ì •
//  Supabase ëŒ€ì‹œë³´ë“œ â†’ Settings â†’ API ì—ì„œ ë³µì‚¬
// ================================================================
const SUPABASE_URL  = 'https://gjykjvevjuzjyuuopsns.supabase.co';  // â† êµì²´
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqeWtqdmV2anV6anl1dW9wc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMzI5NDMsImV4cCI6MjA4NzcwODk0M30.dsO4N8NVYoIyH7SYmUPmJISYVQ5kQ0LyOes3mzRowBQ';              // â† êµì²´ (anon, not service_role)

const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// â”€â”€ Supabase ì „ì²´ ì½ê¸° (1000í–‰ ì´ˆê³¼ ì‹œ ìë™ í˜ì´ì§€ë„¤ì´ì…˜) â”€â”€â”€â”€â”€â”€
async function sbFetchAll(tableName) {
  const PAGE = 1000;
  let allRows = [], from = 0;
  while (true) {
    const { data, error } = await _sb
      .from(tableName).select('*').range(from, from + PAGE - 1);
    if (error) throw new Error(`[${tableName}] ${error.message}`);
    if (!data || data.length === 0) break;
    allRows = allRows.concat(data);
    if (data.length < PAGE) break;
    from += PAGE;
  }
  return allRows;
}

// â”€â”€ perf ì •ê·œí™”: Supabase ê°ì²´ â†’ onDataLoaded í‘œì¤€ í˜•ì‹ â”€â”€â”€â”€â”€â”€â”€â”€
// ì‹¤ì œ ì»¬ëŸ¼ëª…ì´ ë‹¬ë¼ë„ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ìœ ì—°í•˜ê²Œ ë§¤í•‘
function normalizePerfRows(objArr) {
  if (!objArr.length) return { headers: [], rows: [] };

  const keys   = Object.keys(objArr[0]);
  const find   = (...kws) => keys.find(k => kws.some(kw => k.toLowerCase().includes(kw.toLowerCase()))) || '';

  // ì‹¤ì œ ì»¬ëŸ¼ëª… íƒìƒ‰
  const K = {
    date    : find('date', 'ë‚ ì§œ'),
    channel : find('channel'),
    campaign: find('campaign', 'ìº í˜ì¸'),
    spend   : find('cost', 'spend', 'ë¹„ìš©'),
    imps    : find('impression', 'ë…¸ì¶œ'),
    clicks  : find('click', 'í´ë¦­'),
    detail  : find('detail', 'ìƒì„¸'),
    signups : find('signup', 'ê°€ì…'),
    conv    : find('êµ¬ë§¤ ì™„ë£Œ', 'êµ¬ë§¤ì™„ë£Œ', 'conversion', 'ì „í™˜ìˆ˜'),
    revenue : find('êµ¬ë§¤ì•¡', 'revenue', 'ì „í™˜ë§¤ì¶œ', 'ë§¤ì¶œ'),
  };

  console.log('[normalizePerfRows] ì»¬ëŸ¼ ë§¤í•‘:', K);

  const HEADERS = ['date','channel','campaign','spend','impressions','clicks',
                   'detail_views','signups','conversions','conv_revenue'];

  const rows = objArr.map(obj => [
    obj[K.date]    || '',
    obj[K.channel] || '',
    obj[K.campaign]|| '',
    Number(obj[K.spend]  ) || 0,
    Number(obj[K.imps]   ) || 0,
    Number(obj[K.clicks] ) || 0,
    Number(obj[K.detail] ) || 0,
    Number(obj[K.signups]) || 0,
    Number(obj[K.conv]   ) || 0,
    Number(obj[K.revenue]) || 0,
  ]);

  return { headers: HEADERS, rows };
}

// â”€â”€ crm ì •ê·œí™”: Supabase ê°ì²´ â†’ onCrmDataLoaded í‘œì¤€ í˜•ì‹ â”€â”€â”€â”€â”€â”€
function normalizeCrmRows(objArr) {
  if (!objArr.length) return { headers: [], rows: [] };

  const keys = Object.keys(objArr[0]);
  const find = (...kws) => keys.find(k => kws.some(kw => k.toLowerCase().includes(kw.toLowerCase()))) || '';

  const K = {
    date       : find('date', 'ë‚ ì§œ'),
    channel    : find('channel'),
    sent       : find('sent', 'ë°œì†¡'),
    spend      : find('spend', 'cost', 'ë¹„ìš©'),
    opened     : find('open', 'ì—´ëŒ'),
    clicked    : find('click', 'í´ë¦­'),
    installs   : find('install', 'ì„¤ì¹˜'),
    detailViews: find('detail', 'ìƒì„¸'),
    signups    : find('signup', 'ê°€ì…'),
    converted  : find('convert', 'ì „í™˜ìˆ˜', 'êµ¬ë§¤ ì™„ë£Œ'),
    revenue    : find('revenue', 'êµ¬ë§¤ì•¡', 'ë§¤ì¶œ'),
  };

  console.log('[normalizeCrmRows] ì»¬ëŸ¼ ë§¤í•‘:', K);

  const HEADERS = ['date','channel','sent','spend','opened','clicked',
                   'installs','detailViews','signups','converted','revenue'];

  const rows = objArr.map(obj => [
    obj[K.date]        || '',
    obj[K.channel]     || '',
    Number(obj[K.sent]       ) || 0,
    Number(obj[K.spend]      ) || 0,
    Number(obj[K.opened]     ) || 0,
    Number(obj[K.clicked]    ) || 0,
    Number(obj[K.installs]   ) || 0,
    Number(obj[K.detailViews]) || 0,
    Number(obj[K.signups]    ) || 0,
    Number(obj[K.converted]  ) || 0,
    Number(obj[K.revenue]    ) || 0,
  ]);

  return { headers: HEADERS, rows };
}

// â”€â”€ í¼í¬ë¨¼ìŠ¤ ë°ì´í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const raw    = await sbFetchAll('marketing_perf');
    const result = normalizePerfRows(raw);
    if (!result.rows.length) { onDataError('marketing_perf ë°ì´í„° ì—†ìŒ'); return; }
    onDataLoaded(result);
  } catch(e) {
    onDataError('marketing_perf ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
  }
}

// â”€â”€ í”„ë¡œë•íŠ¸ ë°ì´í„° ë¡œë“œ (product_rawdata) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProductData() {
  try {
    const raw = await sbFetchAll('product_rawdata');
    if (!raw.length) { console.warn('[product] ë°ì´í„° ì—†ìŒ'); return; }
    const keys    = Object.keys(raw[0]).filter(k => k !== 'id');
    const headers = keys;
    const rows    = raw.map(obj => keys.map(k => obj[k] ?? 0));
    onProductDataLoaded({ headers, rows });
  } catch(e) { console.warn('[product] ë¡œë“œ ì‹¤íŒ¨:', e.message); }
}

// â”€â”€ í˜¸í…” ë°ì´í„° ë¡œë“œ (hotel_rawdata) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHotelData() {
  try {
    const raw = await sbFetchAll('hotel_rawdata');
    if (!raw.length) { console.warn('[hotel] ë°ì´í„° ì—†ìŒ'); return; }
    const keys    = Object.keys(raw[0]).filter(k => k !== 'id');
    const headers = keys;
    const rows    = raw.map(obj => keys.map(k => obj[k] ?? ''));
    onHotelDataLoaded({ headers, rows });
  } catch(e) { console.warn('[hotel] ë¡œë“œ ì‹¤íŒ¨:', e.message); }
}

// â”€â”€ CRM ë°ì´í„° ë¡œë“œ (marketing_crm) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCrmData() {
  try {
    const raw    = await sbFetchAll('marketing_crm');
    if (!raw.length) { console.warn('[crm] ë°ì´í„° ì—†ìŒ'); return; }
    const result = normalizeCrmRows(raw);
    onCrmDataLoaded(result);
  } catch(e) { console.warn('[crm] ë¡œë“œ ì‹¤íŒ¨:', e.message); }
}

function onHotelDataLoaded(result) {
  const el = document.getElementById('hotel-status');
  if (!result || result.error || !result.headers || !result.rows.length) {
    const msg = result?.error || 'ë°ì´í„° ì—†ìŒ';
    if (el) el.textContent = `Â· ${msg}`;
    console.warn('[hotel] ê²°ê³¼ ì—†ìŒ:', msg);
    return;
  }

  // â”€â”€ í—¤ë” ì¸ë±ìŠ¤ ë§¤í•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const h = result.headers;
  const idx = {
    date:    h.findIndex(x => x.toLowerCase().includes('date')),
    region:  h.findIndex(x => x.includes('region') || x.includes('ì§€ì—­')),
    branch:  h.findIndex(x => x.includes('branch') || x.includes('ì§€ì ')),
    brand:   h.findIndex(x => x.includes('brand')  || x.includes('ë¸Œëœë“œ')),
    room:    h.findIndex(x => x.includes('room')   || x.includes('ê°ì‹¤')),
    revenue: h.findIndex(x => x.includes('revenue')|| x.includes('ë§¤ì¶œ')),
    bk:      h.findIndex(x => x.includes('booking')|| x.includes('ì˜ˆì•½ê±´')),
    nights:  h.findIndex(x => x.includes('night')  || x.includes('ë°•ìˆ˜')),
    lt:      h.findIndex(x => x.includes('lead')   || x.includes('ë¦¬ë“œ')),
    cancel:  h.findIndex(x => x.includes('cancel') || x.includes('ì·¨ì†Œ')),
    sold:    h.findIndex(x => x.includes('sold')),
    avail:   h.findIndex(x => x.includes('avail')  || x.includes('ê°€ìš©')),
  };
  const g = (row, key) => idx[key] >= 0 ? (Number(row[idx[key]]) || 0) : 0;
  const s = (row, key) => idx[key] >= 0 ? String(row[idx[key]])        : '';

  HOTEL_DATA = result.rows.map(row => ({
    date:    s(row,'date'),
    region:  s(row,'region'),
    branch:  s(row,'branch'),
    brand:   s(row,'brand'),
    roomType:s(row,'room'),
    revenue: g(row,'revenue'),
    bookings:g(row,'bk'),
    nights:  g(row,'nights'),
    leadTime:g(row,'lt'),
    cancel:  g(row,'cancel'),
    sold:    g(row,'sold'),
    avail:   g(row,'avail'),
  })).filter(d => d.date);

  // â”€â”€ ëª©ë¡ ì¶”ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  HOTEL_REGIONS = [...new Set(HOTEL_DATA.map(d => d.region))].filter(Boolean).sort();
  HOTEL_BRANCHES_MAP = {};
  HOTEL_DATA.forEach(d => {
    if (!HOTEL_BRANCHES_MAP[d.region]) HOTEL_BRANCHES_MAP[d.region] = new Set();
    HOTEL_BRANCHES_MAP[d.region].add(d.branch);
  });
  Object.keys(HOTEL_BRANCHES_MAP).forEach(r => {
    HOTEL_BRANCHES_MAP[r] = [...HOTEL_BRANCHES_MAP[r]].sort();
  });
  HOTEL_BRANDS = [...new Set(HOTEL_DATA.map(d => d.brand))].filter(Boolean).sort();
  HOTEL_ROOMS  = [...new Set(HOTEL_DATA.map(d => d.roomType))].filter(Boolean).sort();

  // â”€â”€ í•„í„° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const buildSel = (id, items) => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>';
    items.forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      sel.appendChild(o);
    });
    if (cur && items.includes(cur)) sel.value = cur;
  };
  buildSel('prod-sel-region', HOTEL_REGIONS);
  buildSel('prod-sel-brand',  HOTEL_BRANDS);
  buildSel('prod-sel-room',   HOTEL_ROOMS);

  // â”€â”€ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dates = HOTEL_DATA.map(d => d.date).filter(Boolean).sort();
  const hFrom = dates[0] || DATE_FROM;
  const hTo   = dates[dates.length-1] || DATE_TO;
  const pf = document.getElementById('prod-date-from');
  const pt = document.getElementById('prod-date-to');
  if (pf && !pf.value) pf.value = hFrom;
  if (pt && !pt.value) pt.value = hTo;

  if (el) el.textContent = `Â· ${HOTEL_DATA.length.toLocaleString()}í–‰ ë¡œë“œ ì™„ë£Œ`;
  console.log('[hotel] ë¡œë“œ ì™„ë£Œ:', HOTEL_DATA.length, 'í–‰ / ì§€ì—­:', HOTEL_REGIONS);

  // í˜„ì¬ íƒ­ì´ productì´ë©´ ë°”ë¡œ ë Œë”
  if (ACTIVE_TAB === 'product') renderProductTab();
}


/* ================================================================
   CRM ë°ì´í„° ë¡œë“œ (crm_rawdata)
================================================================ */
// loadCrmData ëŠ” ìœ„ Supabase ë¸”ë¡ì— ì •ì˜ë¨

function onCrmDataLoaded(result) {
  if (!result || result.error || !result.headers || !result.rows.length) {
    const msg = result?.error || 'ë°ì´í„° ì—†ìŒ';
    console.warn('[crm] ê²°ê³¼ ì—†ìŒ:', msg);
    return;
  }

  // â”€â”€ Code.gsì—ì„œ Wideâ†’Long ë³€í™˜ ì™„ë£Œ ìƒíƒœë¡œ ìˆ˜ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // headers: ['date','channel','sent','spend','opened','clicked','installs','detailViews','signups','converted','revenue']
  // ê³ ì • ì¸ë±ìŠ¤ë¡œ íŒŒì‹± (í—¤ë” ê²€ìƒ‰ ë¶ˆí•„ìš”)
  const h = result.headers;
  const I = {
    date:        h.indexOf('date'),
    channel:     h.indexOf('channel'),
    sent:        h.indexOf('sent'),
    spend:       h.indexOf('spend'),
    opened:      h.indexOf('opened'),
    clicked:     h.indexOf('clicked'),
    installs:    h.indexOf('installs'),
    detailViews: h.indexOf('detailViews'),
    signups:     h.indexOf('signups'),
    converted:   h.indexOf('converted'),
    revenue:     h.indexOf('revenue'),
  };

  console.log('[crm] í—¤ë” ì¸ë±ìŠ¤:', I);

  const g = (row, key) => I[key] >= 0 ? (Number(row[I[key]]) || 0) : 0;
  const s = (row, key) => I[key] >= 0 ? String(row[I[key]]).trim()  : '';

  CRM_DATA = result.rows.map(row => ({
    date:        s(row, 'date'),
    channel:     s(row, 'channel'),       // í™”ë©´ í‘œì‹œëª… (ë¬¸ì ë©”ì‹œì§€ / ì•±í‘¸ì‹œ / ì•Œë¦¼í†¡ ë§ˆì¼€íŒ… / í”Œì¹œ ë©”ì‹œì§€ / ì•Œë¦¼í†¡ í¼ë„)
    sent:        g(row, 'sent'),
    spend:       g(row, 'spend'),
    opened:      g(row, 'opened'),
    clicked:     g(row, 'clicked'),
    installs:    g(row, 'installs'),
    detailViews: g(row, 'detailViews'),
    signups:     g(row, 'signups'),
    converted:   g(row, 'converted'),
    revenue:     g(row, 'revenue'),
  })).filter(d => d.date);

  // â”€â”€ CRM ì±„ë„ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CRM_CHANS    = [...new Set(CRM_DATA.map(d => d.channel))].filter(Boolean).sort();
  CRM_CHANNELS = CRM_CHANS;  // 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ìš©
  const crmSel = document.getElementById('crm-sel-channel');
  if (crmSel) {
    const cur = crmSel.value;
    crmSel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>';
    CRM_CHANS.forEach(ch => {
      const o = document.createElement('option');
      o.value = ch; o.textContent = ch;
      crmSel.appendChild(o);
    });
    if (cur && CRM_CHANS.includes(cur)) crmSel.value = cur;
  }

  // CRM 3ë‹¨ê³„ ì±„ë„ ë„¤ë¹„ êµ¬ì„±
  updateChanNav('crm');

  console.log('[crm] ë¡œë“œ ì™„ë£Œ:', CRM_DATA.length, 'í–‰ / ì±„ë„:', CRM_CHANS);

  // í˜„ì¬ íƒ­ì´ ë§ˆì¼€íŒ… CRMì´ë©´ ë°”ë¡œ ë Œë”
  if (ACTIVE_TAB === 'marketing' && MKT_SUB === 'crm') renderCrm();
}

function onProductDataLoaded(result) {
  if (!result || result.error || !result.headers || !result.rows.length) {
    const msg = result?.error ? `Â· ì˜¤ë¥˜: ${result.error}` : 'Â· ë°ì´í„° ì—†ìŒ';
    document.getElementById('product-kpi-status').textContent = msg;
    return;
  }

  // í—¤ë” ì¸ë±ìŠ¤ ë§¤í•‘ (ìˆœì„œ ë³€ê²½ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘)
  const h = result.headers;
  const idx = {
    date:        h.findIndex(x => x.toLowerCase().includes('date')),
    totalSales:  h.findIndex(x => x.includes('íŒë§¤ê±´') || x.includes('ê²°ì œê±´')),
    totalNights: h.findIndex(x => x.includes('íŒë§¤ë°•') || x.includes('ê²°ì œë°•')),
    totalRev:    h.findIndex(x => x.includes('ì´') && x.includes('ë§¤ì¶œ') && !x.includes('ì•±') && !x.includes('ì›¹')),
    aov:         h.findIndex(x => x.includes('ê°ë‹¨')),
    appRev:      h.findIndex(x => x.includes('ì•±') && x.includes('ë§¤ì¶œ')),
    appSales:    h.findIndex(x => x.includes('ì•±') && x.includes('íŒë§¤ê±´')),
    appNights:   h.findIndex(x => x.includes('ì•±') && x.includes('íŒë§¤ë°•')),
    webRev:      h.findIndex(x => x.includes('ì›¹') && x.includes('ë§¤ì¶œ')),
    webSales:    h.findIndex(x => x.includes('ì›¹') && x.includes('íŒë§¤ê±´')),
    webNights:   h.findIndex(x => x.includes('ì›¹') && x.includes('íŒë§¤ë°•')),
    coupon:      h.findIndex(x => x.includes('ì¿ í°')),
    point:       h.findIndex(x => x.includes('í¬ì¸íŠ¸')),
    discRate:    h.findIndex(x => x.includes('í• ì¸ìœ¨')),
    leadTime:    14,  // Oì—´ (0-indexed) â€” í‰ê·  ë¦¬ë“œíƒ€ì„ ê³ ì • ìœ„ì¹˜
  };

  const g = (row, key) => idx[key] >= 0 ? (Number(row[idx[key]]) || 0) : 0;

  PRODUCT_DATA = result.rows.map(row => {
    const dateRaw = idx.date >= 0 ? String(row[idx.date]) : '';
    const appRev  = g(row, 'appRev');
    const webRev  = g(row, 'webRev');
    const coupon  = g(row, 'coupon');
    const point   = g(row, 'point');
    // ì´ë§¤ì¶œ: ì‹œíŠ¸ì— ì…ë ¥ëœ ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ì•±+ì›¹-í• ì¸ ê³„ì‚°
    const totalRev = g(row, 'totalRev') || (appRev + webRev - coupon - point);
    const totalDiscount = coupon + point;
    return {
      date:        dateRaw,
      totalSales:  g(row, 'totalSales'),
      totalNights: g(row, 'totalNights'),
      totalRevenue: totalRev,
      aov:         g(row, 'aov') || (g(row,'totalSales') ? Math.round(totalRev / g(row,'totalSales')) : 0),
      appRevenue:  appRev,
      appSales:    g(row, 'appSales'),
      appNights:   g(row, 'appNights'),
      webRevenue:  webRev,
      webSales:    g(row, 'webSales'),
      webNights:   g(row, 'webNights'),
      coupon, point,
      totalDiscount,
      discountRate: g(row, 'discRate') ||
                    (totalRev ? +(totalDiscount / totalRev * 100).toFixed(1) : 0),
      leadTime:    g(row, 'leadTime'),  // Oì—´(14ë²ˆì§¸) â€” í‰ê·  ë¦¬ë“œíƒ€ì„(ì¼)
    };
  }).filter(d => d.date);

  console.log('[product] ë¡œë“œ ì™„ë£Œ:', PRODUCT_DATA.length, 'í–‰');
  document.getElementById('product-kpi-status').textContent =
    `Â· ${PRODUCT_DATA.length}í–‰ ë¡œë“œ ì™„ë£Œ`;

  // í¼í¬ë¨¼ìŠ¤ KPIì™€ í•¨ê»˜ ë Œë”
  render();
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©: ì‹¤íŒ¨í•´ë„ loadDataëŠ” ì˜í–¥ ì—†ìŒ
function bindEvents() {
  loadBrandCosts();  // localStorageì—ì„œ ì €ì¥ëœ ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© ë³µì›
  loadGoals();       // ëª©í‘œ ì„¤ì • ë³µì›

  // â”€â”€ ë©”ì¸ íƒ­ í´ë¦­ ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.querySelectorAll('.main-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchMainTab(btn.dataset.tab));
    });
  } catch(e) { console.warn('[Tab] ë©”ì¸íƒ­ ë°”ì¸ë”© ì‹¤íŒ¨:', e); }

  // â”€â”€ ë§ˆì¼€íŒ… ì„œë¸Œíƒ­ í´ë¦­ ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.querySelectorAll('.mkt-sub-btn').forEach(btn => {
      btn.addEventListener('click', () => switchMktSub(btn.dataset.sub));
    });
  } catch(e) { console.warn('[Tab] ì„œë¸Œíƒ­ ë°”ì¸ë”© ì‹¤íŒ¨:', e); }

  // â”€â”€ ë‚ ì§œ ë³€ê²½ â†’ í™œì„± íƒ­ ì¬ë Œë” + í¬ë¡œìŠ¤ ë™ê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const renderActive = () => {
    if      (MKT_SUB === 'perf')  render();
    else if (MKT_SUB === 'total') renderTotal();
    else if (MKT_SUB === 'crm')   renderCrm();
  };
  // í¼í¬ë¨¼ìŠ¤ ë‚ ì§œ ì¸í’‹ â†’ DATE_FROM/TO ì—…ë°ì´íŠ¸ + crm ì¸í’‹ ë™ê¸°í™”
  try {
    document.getElementById('date-from').addEventListener('change', e => {
      DATE_FROM = e.target.value;
      const cd = document.getElementById('crm-date-from');
      if (cd && !cd.value) cd.value = DATE_FROM;
      renderActive();
    });
  } catch(e) {}
  try {
    document.getElementById('date-to').addEventListener('change', e => {
      DATE_TO = e.target.value;
      const cd = document.getElementById('crm-date-to');
      if (cd && !cd.value) cd.value = DATE_TO;
      renderActive();
    });
  } catch(e) {}
  // CRM ë‚ ì§œ ì¸í’‹ â†’ renderCrm() í˜¸ì¶œ
  try {
    document.getElementById('crm-date-from').addEventListener('change', () => renderCrm());
    document.getElementById('crm-date-to').addEventListener('change',   () => renderCrm());
  } catch(e) {}
  // CRM ì±„ë„ ë“œë¡­ë‹¤ìš´ â†’ renderCrm()
  try {
    document.getElementById('crm-sel-channel').addEventListener('change', () => renderCrm());
  } catch(e) {}

  // â”€â”€ ì§‘ê³„ë‹¨ìœ„ ë²„íŠ¼ â€” í¼í¬ë¨¼ìŠ¤(data-gran) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.querySelectorAll('.gran-btn[data-gran]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.gran-btn[data-gran]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        GRAN = btn.dataset.gran;
        render();
      });
    });
  } catch(e) {}

  // â”€â”€ ì§‘ê³„ë‹¨ìœ„ ë²„íŠ¼ â€” TOTAL(data-gran-total) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.querySelectorAll('.gran-btn[data-gran-total]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.gran-btn[data-gran-total]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        GRAN_TOTAL = btn.dataset.granTotal;
        renderTotal();
      });
    });
  } catch(e) {}

  // â”€â”€ ì§‘ê³„ë‹¨ìœ„ ë²„íŠ¼ â€” CRM(data-gran-crm) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.querySelectorAll('.gran-btn[data-gran-crm]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.gran-btn[data-gran-crm]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        GRAN_CRM = btn.dataset.granCrm;
        renderCrm();
      });
    });
  } catch(e) {}

  try {
    document.getElementById('sel-channel').addEventListener('change', e => {
      const ch = e.target.value;
      const selCamp = document.getElementById('sel-campaign');
      selCamp.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>';
      if (ch !== 'ì „ì²´' && CAMP_MAP[ch]) {
        selCamp.disabled = false;
        CAMP_MAP[ch].forEach(camp => {
          const opt = document.createElement('option');
          opt.value = camp; opt.textContent = camp;
          selCamp.appendChild(opt);
        });
      } else {
        selCamp.disabled = true;
      }
      render();
    });
  } catch(e) {}

  try { document.getElementById('sel-campaign').addEventListener('change', () => render()); } catch(e) {}

  try {
    let campSearchTimer;
    document.getElementById('camp-search').addEventListener('input', () => {
      clearTimeout(campSearchTimer);
      campSearchTimer = setTimeout(() => render(), 200);
    });
  } catch(e) {}

  try { document.getElementById('btn-brand-cost').addEventListener('click', openBrandCostModal); } catch(e) {}

  // â”€â”€ ëª©í‘œ ì„¤ì • ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.getElementById('chk-goal-on').addEventListener('change', e => {
      GOAL_ON = e.target.checked;
      document.getElementById('btn-goal-input').style.display = GOAL_ON ? '' : 'none';
      if (GOAL_ON && !GOALS.from) { GOALS.from = DATE_FROM; GOALS.to = DATE_TO; }
      saveGoals(); render();
    });
    document.getElementById('btn-goal-input').addEventListener('click', () => {
      document.getElementById('goal-from').value          = GOALS.from || DATE_FROM;
      document.getElementById('goal-to').value            = GOALS.to   || DATE_TO;
      document.getElementById('goal-total-revenue').value = GOALS.totalRevenue || '';
      document.getElementById('goal-total-sales').value   = GOALS.totalSales   || '';
      document.getElementById('goal-ad-spend').value      = GOALS.adSpend      || '';
      document.getElementById('goal-roas').value          = GOALS.roas          || '';
      document.getElementById('goal-conv-revenue').value  = GOALS.convRevenue  || '';
      document.getElementById('goal-modal').style.display = 'flex';
    });
    document.getElementById('btn-goal-modal-close').addEventListener('click', () => {
      document.getElementById('goal-modal').style.display = 'none';
    });
    document.getElementById('btn-goal-apply').addEventListener('click', () => {
      GOALS = {
        from:         document.getElementById('goal-from').value,
        to:           document.getElementById('goal-to').value,
        totalRevenue: +document.getElementById('goal-total-revenue').value || 0,
        totalSales:   +document.getElementById('goal-total-sales').value   || 0,
        adSpend:      +document.getElementById('goal-ad-spend').value      || 0,
        roas:         +document.getElementById('goal-roas').value           || 0,
        convRevenue:  +document.getElementById('goal-conv-revenue').value  || 0,
      };
      saveGoals();
      document.getElementById('goal-modal').style.display = 'none';
      render();
    });
    document.getElementById('chk-insight-goal').addEventListener('change', e => {
      INSIGHT_GOAL_ON = e.target.checked;
      saveGoals();
      if (document.getElementById('insight-modal').style.display !== 'none') runSummary();
    });
    // localStorage ë³µì› í›„ UI ë°˜ì˜
    if (GOAL_ON) {
      document.getElementById('chk-goal-on').checked         = true;
      document.getElementById('btn-goal-input').style.display = '';
    }
  } catch(e) { console.warn('[Goal] ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹¤íŒ¨:', e); }
  try { document.getElementById('btn-brand-cost-close').addEventListener('click', closeBrandCostModal); } catch(e) {}
  try { document.getElementById('btn-bc-add').addEventListener('click', addBrandCost); } catch(e) {}
  try { document.getElementById('btn-bc-apply').addEventListener('click', applyBrandCost); } catch(e) {}
  try {
    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('brand-cost-modal').addEventListener('click', e => {
      if (e.target === document.getElementById('brand-cost-modal')) closeBrandCostModal();
    });
  } catch(e) {}
  // â”€â”€ KPI ì¹´ë“œ í´ë¦­ â†’ ë¯¸ë‹ˆ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    document.querySelectorAll('.kpi-clickable[data-kpi]').forEach(el => {
      el.addEventListener('click', () => kpiMiniOpen(el.dataset.kpi));
    });
    document.getElementById('kpi-mini-modal')?.addEventListener('click', e => {
      if (e.target === document.getElementById('kpi-mini-modal')) kpiMiniClose();
    });
  } catch(e) {}

  // â”€â”€ ì¸ì‚¬ì´íŠ¸ v5 ì´ë²¤íŠ¸ ë°”ì¸ë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try { document.getElementById('btn-insight').addEventListener('click', showInsight); } catch(e) {}
  try { document.getElementById('btn-insight-close').addEventListener('click', () => {
    document.getElementById('insight-modal').style.display = 'none';
  }); } catch(e) {}

  // ë¹ ë¥¸ ì„ íƒ
  try {
    document.querySelectorAll('.ins-quick-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const days     = parseInt(btn.dataset.days);
        const allDates = RAW_DATA.map(d => d.date).sort();
        const latest   = allDates[allDates.length-1] || new Date().toISOString().slice(0,10);
        const from     = new Date(latest);
        from.setDate(from.getDate() - (days - 1));
        const insFrom = document.getElementById('ins-from');
        const insTo   = document.getElementById('ins-to');
        if (insFrom) insFrom.value = from.toISOString().slice(0, 10);
        if (insTo)   insTo.value   = latest;
        document.querySelectorAll('.ins-quick-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ins5Render();
      });
    });
  } catch(e) {}

  // ë‚ ì§œ ì§ì ‘ ë³€ê²½ â†’ ìë™ ì¬ë Œë”
  try {
    ['ins-from', 'ins-to'].forEach(id => {
      document.getElementById(id)?.addEventListener('change', () => ins5Render());
    });
  } catch(e) {}

  // ì±„ë„ ì„ íƒ â†’ ìº í˜ì¸ í•„í„° í™œì„±í™” + ì¬ë Œë”
  try {
    document.getElementById('ins-sel-channel')?.addEventListener('change', e => {
      const ch  = e.target.value;
      const flt = document.getElementById('ins-camp-filter');
      if (flt) {
        flt.disabled     = (ch === 'ì „ì²´');
        flt.placeholder  = ch === 'ì „ì²´' ? 'ì±„ë„ ì„ íƒ í›„ í™œì„±' : 'í…ìŠ¤íŠ¸ë¡œ ìº í˜ì¸ ê²€ìƒ‰...';
        if (ch === 'ì „ì²´') flt.value = '';
      }
      ins5Render();
    });
  } catch(e) {}

  // ìº í˜ì¸ í…ìŠ¤íŠ¸ í•„í„° ì…ë ¥ â†’ ì¬ë Œë”
  try {
    document.getElementById('ins-camp-filter')?.addEventListener('input', () => ins5Render());
  } catch(e) {}

  // ì¸ì‚¬ì´íŠ¸ / ì°¨íŠ¸ íƒ­ í† ê¸€
  try {
    document.querySelectorAll('[data-instab]').forEach(btn => {
      btn.addEventListener('click', () => {
        INS5.tab = btn.dataset.instab;
        document.querySelectorAll('[data-instab]').forEach(b => {
          const on = b.dataset.instab === INS5.tab;
          b.style.fontWeight  = on ? '700' : '400';
          b.style.background  = on ? '#181b24' : 'transparent';
          b.style.color       = on ? '#e2e5ef' : '#6b7394';
        });
        ins5Render();
      });
    });
  } catch(e) {}

  // â”€â”€ (2) Flatpickr â€” ì›”ìš”ì¼ ì‹œì‘, ì–´ì œê¹Œì§€, í•œêµ­ì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    // ì–´ì œ ë‚ ì§œ ê³„ì‚° (ì˜¤ëŠ˜ ë°ì´í„° ì—†ìŒ â†’ maxDate ì–´ì œ)
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    // ko localeì€ flatpickr.l10ns.koë¡œ ì ‘ê·¼
    const koLocale = (typeof flatpickr !== 'undefined' && flatpickr.l10ns && flatpickr.l10ns.ko)
      ? { ...flatpickr.l10ns.ko, firstDayOfWeek: 1 }  // ì›”ìš”ì¼ ì‹œì‘
      : { firstDayOfWeek: 1 };
    const fpOpts = {
      locale: koLocale,
      dateFormat: 'Y-m-d',
      maxDate: yesterday,     // ì˜¤ëŠ˜ ì„ íƒ ë¶ˆê°€
      disableMobile: true,    // ëª¨ë°”ì¼ë„ ì»¤ìŠ¤í…€ ìº˜ë¦°ë” ì‚¬ìš©
    };
    // ì¸ì‚¬ì´íŠ¸ ëª¨ë‹¬ ë‚ ì§œ
    flatpickr('#ins-from',     { ...fpOpts });
    flatpickr('#ins-to',       { ...fpOpts });
    flatpickr('#ins-cmp-from', { ...fpOpts });
    flatpickr('#ins-cmp-to',   { ...fpOpts });
    // ë¸Œëœë“œê²€ìƒ‰ ë¹„ìš© ëª¨ë‹¬ ë‚ ì§œ
    flatpickr('#bc-from',      { ...fpOpts, maxDate: null });
    flatpickr('#bc-to',        { ...fpOpts, maxDate: null });
  } catch(e) { console.warn('[Flatpickr] ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }

  try {
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.getElementById('insight-modal').style.display = 'none';
    });
  } catch(e) {}

  // â”€â”€ í”„ë¡œë•íŠ¸ íƒ­ í•„í„° ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    // ë‚ ì§œ ë³€ê²½
    document.getElementById('prod-date-from').addEventListener('change', () => {
      if (ACTIVE_TAB === 'product') renderProductTab();
    });
    document.getElementById('prod-date-to').addEventListener('change', () => {
      if (ACTIVE_TAB === 'product') renderProductTab();
    });
  } catch(e) {}

  try {
    // ì§‘ê³„ ë‹¨ìœ„
    document.querySelectorAll('[data-gran-prod]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-gran-prod]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        GRAN_PROD = btn.dataset.granProd;
        if (ACTIVE_TAB === 'product') renderProductTab();
      });
    });
  } catch(e) {}

  try {
    // ì§€ì—­ â†’ ì§€ì  ìºìŠ¤ì¼€ì´ë”© í•„í„°
    document.getElementById('prod-sel-region').addEventListener('change', e => {
      const r      = e.target.value;
      const brSel  = document.getElementById('prod-sel-branch');
      brSel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>';
      if (r !== 'ì „ì²´' && HOTEL_BRANCHES_MAP[r]) {
        brSel.disabled = false;
        HOTEL_BRANCHES_MAP[r].forEach(br => {
          const o = document.createElement('option'); o.value=br; o.textContent=br;
          brSel.appendChild(o);
        });
      } else {
        brSel.disabled = true;
      }
      if (ACTIVE_TAB === 'product') renderProductTab();
    });
    document.getElementById('prod-sel-branch').addEventListener('change', () => {
      if (ACTIVE_TAB === 'product') renderProductTab();
    });
    document.getElementById('prod-sel-brand').addEventListener('change', () => {
      if (ACTIVE_TAB === 'product') renderProductTab();
    });
    document.getElementById('prod-sel-room').addEventListener('change', () => {
      if (ACTIVE_TAB === 'product') renderProductTab();
    });
  } catch(e) {}
}

// â”€â”€ ì‹¤í–‰ ì§„ì…ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// script íƒœê·¸ê°€ </body> ì§ì „ì— ìˆìœ¼ë¯€ë¡œ DOMì€ ì´ë¯¸ ì¤€ë¹„ë¨
// Chart.jsë„ headì—ì„œ blocking ë¡œë“œë˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
// Apps Script HtmlServiceì—ì„œ ê°€ì¥ ì•ˆì •ì ì¸ ì§ì ‘ í˜¸ì¶œ íŒ¨í„´
bindEvents();
loadData();

</script>
</body>
</html>
